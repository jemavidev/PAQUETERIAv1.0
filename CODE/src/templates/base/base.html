<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PAQUETEX v3.1 - Sistema de gesti√≥n de paqueter√≠a para EL CLUB">
    <meta name="keywords" content="paqueter√≠a, paquetes, log√≠stica, env√≠os">
    <meta name="author" content="JEMAVI">
    
    {# Favicon #}
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon.png?v=3.1">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon.png?v=3.1">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico?v=3.1">
    <link rel="shortcut icon" href="/static/images/favicon.ico?v=3.1">
    <link rel="apple-touch-icon" href="/static/images/favicon.png?v=3.1">
    <meta name="msapplication-TileImage" content="/static/images/favicon.png?v=3.1">
    
    {# Protecci√≥n temprana contra errores de JavaScript #}
    <script>
        // Protecci√≥n global inmediata
        (function() {
            // Esperar a que document est√© disponible
            function waitForDocument() {
                if (typeof document !== 'undefined' && document.querySelectorAll) {
                    // Interceptar querySelectorAll para evitar errores
                    const originalQuerySelectorAll = document.querySelectorAll;
                    document.querySelectorAll = function(selector) {
                        try {
                            return originalQuerySelectorAll.call(this, selector);
                        } catch (error) {
                            console.warn('Error interceptado en querySelectorAll:', error);
                            return [];
                        }
                    };
                } else {
                    // Reintentar en el siguiente tick
                    setTimeout(waitForDocument, 0);
                }
            }
            waitForDocument();
        })();
    </script>
    
    {# Open Graph #}
    <meta property="og:title" content="PAQUETEX v3.1">
    <meta property="og:description" content="Sistema de gesti√≥n de paqueter√≠a">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://paqueteselclub.com">
    
    <title>{% block title %}PAQUETEX v3.1{% endblock %}</title>
    
    {# Tailwind CSS - Local #}
    <script src="/static/vendor/js/tailwind.js?v=3.4.1"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'papyrus-blue': '#1e40af',
                        'papyrus-green': '#059669',
                        'papyrus-orange': '#ea580c',
                        'papyrus-red': '#dc2626',
                        'papyrus-yellow': '#d97706',
                        'papyrus-purple': '#7c3aed',
                        'papyrus-pink': '#db2777',
                        'papyrus-indigo': '#4f46e5',
                        'papyrus-teal': '#0d9488',
                        'papyrus-cyan': '#0891b2',
                        'papyrus-lime': '#65a30d',
                        'papyrus-emerald': '#10b981',
                        'papyrus-rose': '#e11d48',
                        'papyrus-violet': '#7c3aed',
                        'papyrus-fuchsia': '#c026d3',
                        'papyrus-sky': '#0284c7',
                        'papyrus-amber': '#d97706',
                        'papyrus-stone': '#78716c',
                        'papyrus-neutral': '#525252',
                        'papyrus-slate': '#475569',
                        'papyrus-gray': '#6b7280',
                        'papyrus-zinc': '#71717a',
                    }
                }
            }
        }
    </script>
    
    {# Configuraci√≥n de la aplicaci√≥n #}
    <script src="/static/js/config.js"></script>
    
    {# Alpine.js - Local #}
    <script defer src="/static/vendor/js/alpine.min.js?v=3.13.3"></script>
    
    {# Alpine.js Components #}
    <script>
        document.addEventListener('alpine:init', () => {
            // Componente para alertas de error
            Alpine.data('errorAlert', (config = {}) => ({
                title: config.title || 'Error del Sistema',
                message: config.message || 'Error del sistema. Por favor, comun√≠quese con el administrador.',
                type: config.type || 'error',
                show: config.show !== undefined ? config.show : true,
                autoClose: config.autoClose || false,
                closeDelay: config.closeDelay || 5000,
                buttonText: config.buttonText || 'Cerrar',
                onClose: config.onClose || '',
                
                get alertTypeClass() {
                    const baseClasses = 'error-alert-container';
                    const typeClasses = {
                        'error': 'border-red-500 bg-red-50',
                        'warning': 'border-yellow-500 bg-yellow-50',
                        'info': 'border-blue-500 bg-blue-50',
                        'success': 'border-green-500 bg-green-50'
                    };
                    return `${baseClasses} ${typeClasses[this.type] || typeClasses.error}`;
                },
                
                init() {
                    if (this.autoClose) {
                        setTimeout(() => {
                            this.close();
                        }, this.closeDelay);
                    }
                },
                
                close() {
                    this.show = false;
                    
                    // Ejecutar callback si existe
                    if (this.onClose) {
                        try {
                            eval(this.onClose);
                        } catch (error) {
                            console.error('Error ejecutando callback onClose:', error);
                        }
                    }
                    
                    // Emitir evento personalizado
                    this.$dispatch('error-closed', {
                        type: this.type,
                        title: this.title,
                        message: this.message
                    });
                    
                    // Remover el elemento del DOM despu√©s de la animaci√≥n
                    setTimeout(() => {
                        const element = this.$el;
                        if (element && element.parentNode) {
                            element.parentNode.removeChild(element);
                        }
                    }, 200);
                },
                
                handleClose(event) {
                    this.close();
                }
            }));
        });
    </script>
    
    {# HTMX - Local #}
    <script src="/static/vendor/js/htmx.min.js?v=1.9.10"></script>
    
    {# Form Validation #}
    <script src="/static/js/form-validation.js"></script>
    <script src="/static/js/auth-redirect.js?v=4.0.1"></script>
    
    {# Optimizaci√≥n de Selecci√≥n de Im√°genes #}
    <script src="/static/js/image-upload-optimized.js?v=1.0"></script>
    
    {# Custom JavaScript for Dropdowns #}
    <script>
        // Cerrar dropdown con Escape - Solo cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const menu = document.getElementById('userDropdownMenu');
                    if (menu) {
                        menu.classList.add('hidden');
                        const arrow = document.getElementById('dropdownArrow');
                        if (arrow) {
                            arrow.style.transform = 'rotate(0deg)';
                        }
                        if (typeof userDropdownOpen !== 'undefined') {
                            userDropdownOpen = false;
                        }
                    }
                }
            });
        });
        
        // Funci√≥n para cerrar dropdown manualmente
        function closeUserDropdown() {
            const menu = document.getElementById('userDropdownMenu');
            const arrow = document.getElementById('dropdownArrow');
            
            if (menu) {
                menu.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
                userDropdownOpen = false;
            }
        }
    </script>

    {# Global Authentication Error Handler #}
    <script>
        // Interceptor para detectar errores de autenticaci√≥n
        function setupAuthInterceptor() {
            // Helper: determinar si la ruta es protegida
            function isProtectedPath(pathname) {
                const protectedPaths = ['/profile', '/settings', '/admin', '/dashboard', '/messages', '/packages', '/receive'];
                const publicPaths = ['/announce', '/search', '/auth/login', '/auth/register', '/help', '/cookies', '/policies', '/', '/error-demo'];
                
                // Una ruta es protegida SOLO si est√° en protectedPaths Y NO est√° en publicPaths
                const isInProtected = protectedPaths.some(path => pathname.startsWith(path));
                const isInPublic = publicPaths.some(path => pathname === path || pathname.startsWith(path + '/'));
                
                return isInProtected && !isInPublic;
            }

            // Interceptar fetch requests
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                const currentPath = window.location.pathname;
                
                // No interceptar peticiones de login, auth, o cuando estamos en p√°ginas p√∫blicas
                if (typeof url === 'string' && (
                    url.includes('/api/auth/login') || 
                    url.includes('/auth/login') ||
                    currentPath === '/auth/login' ||
                    currentPath === '/auth/register' ||
                    currentPath === '/' ||
                    currentPath.startsWith('/static/')
                )) {
                    return originalFetch.apply(this, args);
                }
                
                return originalFetch.apply(this, args)
                    .then(async response => {
                        // Solo verificar autenticaci√≥n en rutas protegidas
                        if (!isProtectedPath(currentPath)) {
                            return response;
                        }
                        
                        // Verificar si la respuesta contiene error de autenticaci√≥n
                        try {
                            const clonedResponse = response.clone();
                            const data = await clonedResponse.json();
                            console.log('Fetch interceptor: Response data:', data);
                            if (data.detail === "No autenticado") {
                                console.log('Fetch interceptor: Redirecting due to "No autenticado" on protected path');
                                handleAuthError();
                                return new Promise(() => {}); // Return pending promise to prevent further processing
                            }
                        } catch (e) {
                            console.log('Fetch interceptor: Response is not JSON');
                            // Not JSON, continue normally
                        }
                        return response;
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        return Promise.reject(error);
                    });
            };

            // Interceptar XMLHttpRequest
            const originalXHROpen = XMLHttpRequest.prototype.open;
            const originalXHRSend = XMLHttpRequest.prototype.send;
            
            XMLHttpRequest.prototype.open = function(method, url, ...args) {
                this._url = url;
                return originalXHROpen.apply(this, [method, url, ...args]);
            };
            
            XMLHttpRequest.prototype.send = function(data) {
                this.addEventListener('load', function() {
                    if (this.status === 401 && isProtectedPath(window.location.pathname)) {
                        handleAuthError();
                    }
                });
                return originalXHRSend.apply(this, [data]);
            };

            // Interceptar respuestas de HTMX
            document.addEventListener('htmx:responseError', function(event) {
                if (event.detail.xhr.status === 401 && isProtectedPath(window.location.pathname)) {
                    handleAuthError();
                }
            });

            // Interceptar respuestas exitosas de HTMX para verificar contenido
            document.addEventListener('htmx:afterRequest', function(event) {
                if (event.detail.xhr.status === 200) {
                    try {
                        const response = JSON.parse(event.detail.xhr.responseText);
                        if (response.detail === "No autenticado" && isProtectedPath(window.location.pathname)) {
                            handleAuthError();
                        }
                    } catch (e) {
                        // No es JSON, continuar normalmente
                    }
                }
            });
        }

        // Funci√≥n para manejar errores de autenticaci√≥n
        function handleAuthError() {
            console.log('Sesi√≥n expirada. Redirigiendo al login...');
            
            // Limpiar cualquier estado local
            localStorage.clear();
            sessionStorage.clear();
            
            // Redirigir al login
            window.location.href = '/auth/login';
        }

        // Verificar autenticaci√≥n al cargar la p√°gina
        function checkAuthOnLoad() {
            // Solo verificar en p√°ginas que requieren autenticaci√≥n
            const protectedPaths = ['/profile', '/settings', '/admin', '/dashboard', '/messages', '/packages', '/receive'];
            const publicPaths = ['/announce', '/search', '/auth/login', '/auth/register', '/help', '/cookies', '/policies', '/', '/error-demo'];
            const currentPath = window.location.pathname;

            // No verificar autenticaci√≥n en rutas p√∫blicas
            const isPublic = publicPaths.some(path => currentPath === path || currentPath.startsWith(path + '/'));
            const isProtected = protectedPaths.some(path => currentPath.startsWith(path));

            if (isProtected && !isPublic) {
                console.log('Ruta protegida detectada:', currentPath);
                console.log('No verificando autenticaci√≥n autom√°ticamente - se verificar√° en las peticiones API');
                // No hacer verificaci√≥n autom√°tica - dejar que las peticiones API manejen la autenticaci√≥n
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            setupAuthInterceptor();
            checkAuthOnLoad();
        });

        // Tambi√©n verificar en navegaci√≥n
        window.addEventListener('beforeunload', function() {
            // Limpiar estado si es necesario
        });
    </script>
    
    {# Heroicons - Local #}
    <link rel="stylesheet" href="/static/vendor/css/heroicons.css?v=2.0.18">
    
    {# CSS Optimizado para Selecci√≥n de Im√°genes #}
    <link rel="stylesheet" href="/static/css/image-upload-optimized.css?v=1.0">
    
    {# Custom Styles #}
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Input con icono */
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon input,
        .input-with-icon textarea {
            padding-left: 40px;
        }
        
        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6B7280;
            width: 20px;
            height: 20px;
            z-index: 10;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
        
        /* Asegurar que el header y footer mantengan tama√±o consistente */
        header {
            height: 64px; /* Altura fija del header */
            flex-shrink: 0;
        }
        
        footer {
            height: 60px; /* Altura fija del footer */
            flex-shrink: 0;
        }
        
        /* Asegurar que el contenido principal se expanda correctamente */
        main {
            flex: 1;
        }
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Sidebar transitions */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Favicon sin sombra */
        .favicon-no-shadow {
            filter: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
        }
        
        /* Alpine.js x-cloak */
        [x-cloak] {
            display: none !important;
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
        {# Script para el men√∫ m√≥vil #}
        <script>
            // Protecci√≥n global contra errores de querySelectorAll
            (function() {
                if (typeof document === 'undefined') return;
                
                // Interceptar querySelectorAll para evitar errores
                const originalQuerySelectorAll = document.querySelectorAll;
                document.querySelectorAll = function(selector) {
                    try {
                        return originalQuerySelectorAll.call(this, selector);
                    } catch (error) {
                        console.warn('Error en querySelectorAll:', error);
                        return [];
                    }
                };
            })();
            
            // Estado del men√∫ m√≥vil
            let mobileMenuOpen = false;
            
            // Funci√≥n para alternar el men√∫ m√≥vil
            function toggleMobileMenu() {
                mobileMenuOpen = !mobileMenuOpen;
                
                // Verificar que document existe antes de usar querySelectorAll
                if (typeof document === 'undefined') return;
                
                // Obtener todos los elementos que dependen del estado
                const mobileMenus = document.querySelectorAll('.mobile-menu');
                const hamburgerIcons = document.querySelectorAll('.hamburger-icon');
                const closeIcons = document.querySelectorAll('.close-icon');
                
                // Mostrar/ocultar men√∫s m√≥viles
                mobileMenus.forEach(menu => {
                    if (mobileMenuOpen) {
                        menu.style.display = 'block';
                    } else {
                        menu.style.display = 'none';
                    }
                });
                
                // Cambiar iconos
                hamburgerIcons.forEach(icon => {
                    icon.style.display = mobileMenuOpen ? 'none' : 'block';
                });
                
                closeIcons.forEach(icon => {
                    icon.style.display = mobileMenuOpen ? 'block' : 'none';
                });
            }
            
            // Inicializar cuando el DOM est√© listo
            document.addEventListener('DOMContentLoaded', function() {
                // Verificar que document existe antes de usar querySelectorAll
                if (typeof document === 'undefined') return;
                
                // Agregar event listeners a todos los botones del men√∫ m√≥vil
                const mobileButtons = document.querySelectorAll('.mobile-menu-button');
                mobileButtons.forEach(button => {
                    button.addEventListener('click', toggleMobileMenu);
                });
                
                // Ocultar men√∫s m√≥viles por defecto
                const mobileMenus = document.querySelectorAll('.mobile-menu');
                mobileMenus.forEach(menu => {
                    menu.style.display = 'none';
                });
                
                // Ocultar iconos de cierre por defecto
                const closeIcons = document.querySelectorAll('.close-icon');
                closeIcons.forEach(icon => {
                    icon.style.display = 'none';
                });
            });
        </script>
        
        {# Header Condicional seg√∫n Autenticaci√≥n #}
    {% if is_authenticated %}
        {# Header para Usuarios Autenticados #}
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    
                    {# Logo, Nombre y Enlaces de Navegaci√≥n - Todo al lado izquierdo #}
                    <div class="flex items-center space-x-6">
                        {# Logo y Nombre de la Aplicaci√≥n #}
                        <a href="/announce" class="flex items-center space-x-3 hover:opacity-80 transition-opacity duration-200">
                            <div class="w-10 h-10 flex items-center justify-center">
                                <img src="/static/images/favicon.png" alt="Logo EL CLUB - Colibr√≠" class="w-10 h-10 object-contain favicon-no-shadow">
                            </div>
                            <div class="text-xl font-bold text-gray-800">PAQUETEX</div>
                        </a>
                        
                        {# Enlaces de Navegaci√≥n para Usuarios Autenticados #}
                        <div class="hidden md:flex items-center space-x-1">

                            {# Paquetes #}
                            <a href="/packages" class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-50 transition-colors duration-200 relative">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                                <span>Paquetes</span>
                                <!-- Badge de Paquetes RECIBIDO -->
                                <div id="packages-badge" class="hidden absolute -top-1 -right-1 bg-papyrus-blue text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center min-w-[20px] animate-pulse">
                                    <span id="packages-count">0</span>
                                </div>
                            </a>

                            {# Mensajes con Badge de Notificaciones #}
                            <a href="/messages" class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-50 transition-colors duration-200 relative">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span>Mensajes</span>
                                {# Badge de Notificaciones #}
                                <div id="messages-badge" class="hidden absolute -top-1 -right-1 bg-papyrus-red text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center min-w-[20px] animate-pulse">
                                    <span id="messages-count">0</span>
                                </div>
                            </a>

                            {# Clientes #}
                            <a href="/customers/manage" class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-50 transition-colors duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <span>Clientes</span>
                            </a>
                            
                            {# Consulta #}
                            <a href="/search" class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-50 transition-colors duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <span>Consulta</span>
                            </a>


                        </div>
                    </div>
                    
                    {# Informaci√≥n del Usuario y Dropdown #}
                    <div class="flex items-center space-x-3">
                        {# Bot√≥n de men√∫ m√≥vil #}
                        <button class="mobile-menu-button md:hidden p-2 text-gray-700 hover:text-papyrus-blue transition-colors">
                            <svg class="hamburger-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                            <svg class="close-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <div class="relative" id="userDropdown">
                            <button id="userDropdownButton" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                                
                                {# Avatar del Usuario #}
                                <div class="w-10 h-10 bg-papyrus-blue rounded-full flex items-center justify-center">
                                    <span class="text-white font-semibold text-lg">{{ user_name[0] if user_name else 'U' }}</span>
                                </div>
                                
                                {# Informaci√≥n del Usuario #}
                                <div class="hidden md:block text-left">
                                    <div class="text-sm uppercase font-medium text-gray-800">{{ user_name if user_name else 'Usuario' }}</div>
                                    <div class="text-xs text-gray-500">Mi cuenta</div>
                                </div>
                                
                                {# Flecha del Dropdown #}
                                <svg id="dropdownArrow" class="w-4 h-4 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            {# Men√∫ Dropdown #}
                            <div id="userDropdownMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 border border-gray-200 hidden">
                              
                                {# Perfil #}
                                <a href="/profile" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                                    <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Mi Perfil
                                </a>

                                {# Separador #}
                                <div class="border-t border-gray-100 my-1"></div>
                                
                                {# Cerrar Sesi√≥n #}
                                <a href="/logout" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors duration-200">
                                    <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Cerrar Sesi√≥n
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {# Navegaci√≥n M√≥vil para Usuarios Autenticados #}
            <div class="md:hidden">
                <div class="mobile-menu px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-gray-50 border-t border-gray-200">

                    {# Anunciar M√≥vil #}
                    <a href="/announce" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span>Anunciar</span>
                    </a>

                    {# Consulta M√≥vil #}
                    <a href="/search" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <span>Consulta</span>
                    </a>

                    {# Paquetes M√≥vil #}
                    <a href="/packages" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200 relative">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <span>Paquetes</span>
                        <!-- Badge M√≥vil Paquetes RECIBIDO -->
                        <div id="packages-badge-mobile" class="hidden absolute -top-1 -right-1 bg-papyrus-blue text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center min-w-[20px] animate-pulse">
                            <span id="packages-count-mobile">0</span>
                        </div>
                    </a>

                    {# Mensajes M√≥vil con Badge #}
                    <a href="/messages" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200 relative">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span>Mensajes</span>
                        {# Badge de Notificaciones M√≥vil #}
                        <div id="messages-badge-mobile" class="hidden absolute -top-1 -right-1 bg-papyrus-red text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center min-w-[20px] animate-pulse">
                            <span id="messages-count-mobile">0</span>
                        </div>
                    </a>

                    {# Clientes M√≥vil #}
                    <a href="/customers/manage" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>Clientes</span>
                    </a>
                </div>
            </div>
        </nav>
    {% else %}
        {# Header para Usuarios No Autenticados #}
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    
                    {# Logo, Nombre y Enlaces de Navegaci√≥n - Todo al lado izquierdo #}
                    <div class="flex items-center space-x-6">
                        {# Logo y Nombre de la Aplicaci√≥n #}
                        <a href="/announce" class="flex items-center space-x-3 hover:opacity-80 transition-opacity duration-200">
                            <div class="w-10 h-10 flex items-center justify-center">
                                {# Logo del Colibr√≠ Real #}
                                <img src="/static/images/favicon.png" alt="Logo EL CLUB - Colibr√≠" class="w-10 h-10 object-contain favicon-no-shadow">
                            </div>
                            <div class="text-xl font-bold text-gray-800">PAQUETEX</div>
                        </a>
                        
                        {# Enlaces de Navegaci√≥n - Ahora al lado izquierdo #}
                        <div class="hidden md:flex items-center space-x-1">
                            <a href="/announce" class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-50 transition-colors duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                <span>Anunciar</span>
                            </a>
                            
                            <a href="/search" class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-50 transition-colors duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <span>Consultar</span>
                            </a>
                        </div>
                    </div>
                    
                    {# Lado Derecho - Icono de Usuario para Todos #}
                    <div class="flex items-center space-x-3">
                        {# Bot√≥n de men√∫ m√≥vil #}
                        <button class="mobile-menu-button md:hidden p-2 text-gray-700 hover:text-papyrus-blue transition-colors">
                            <svg class="hamburger-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                            <svg class="close-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <a href="/auth/login" class="text-gray-700 hover:text-papyrus-blue p-2 rounded-md transition-colors duration-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            {# Navegaci√≥n M√≥vil - Siempre los mismos enlaces #}
            <div class="md:hidden">
                <div class="mobile-menu px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-gray-50 border-t border-gray-200">
                    
                    <a href="/announce" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span>Anunciar</span>
                    </a>
                    
                    <a href="/search" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <span>Consultar</span>
                    </a>
                    
                    <a href="/auth/login" class="flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-papyrus-blue hover:bg-gray-100 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span>Iniciar Sesi√≥n</span>
                    </a>
                </div>
            </div>
        </nav>
    {% endif %}

    {# Main Content #}
    <main class="flex-1">
        {# Contenedor de Alertas Global - Deshabilitado para /announce #}
        <div id="alert-container" class="fixed top-4 right-4 z-50 max-w-md w-full px-4 sm:px-0" style="display: none;">
            {# Las alertas se insertar√°n aqu√≠ din√°micamente #}
        </div>
        
        <script>
        // Deshabilitar alert-container para p√°ginas espec√≠ficas
        // Nota: Antes se deshabilitaba en '/announce', pero ahora lo dejamos
        // habilitado para que los errores (como gu√≠a duplicada) se muestren
        // correctamente en esa vista.
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const alertContainer = document.getElementById('alert-container');
            
            // P√°ginas donde NO mostrar el alert-container
            const disabledPages = [];
            
            if (disabledPages.includes(currentPath)) {
                if (alertContainer) {
                    alertContainer.style.display = 'none';
                    console.log('üö´ Alert-container deshabilitado para:', currentPath);
                }
            } else {
                if (alertContainer) {
                    alertContainer.style.display = 'block';
                    console.log('‚úÖ Alert-container habilitado para:', currentPath);
                }
            }
        });
        </script>
        
        {# Mensajes Flash del Sistema #}
        {% include 'components/error_alert_helper.html' %}
        
        {% block content %}
        {# El contenido espec√≠fico de cada p√°gina ir√° aqu√≠ #}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-2xl font-bold text-gray-900">Contenido de la p√°gina</h1>
            <p class="mt-4 text-gray-600">Este es el contenido principal de la p√°gina.</p>
        </div>
        {% endblock %}
    </main>

    {# Footer Component (Sticky Footer) #}
    <footer class="bg-white shadow-sm border-t flex-shrink-0">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center py-3 sm:py-4 space-y-2 sm:space-y-0">
                {# Copyright #}
                <div class="text-xs sm:text-sm text-gray-500 text-center sm:text-left">
                    Desarrollado por <a href="https://jemavi.co" class="text-papyrus-blue hover:text-blue-700 underline" target="_blank">JEMAVI</a> | ¬© 2025 PAPYRUS
                </div>
                
                {# Enlaces #}
                <div class="flex items-center justify-center sm:justify-end space-x-3 sm:space-x-4">
                    <a href="/help" class="text-gray-500 hover:text-gray-900 transition-colors flex items-center justify-center p-2 sm:p-0">
                        <svg class="w-8 h-8 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="hidden sm:inline sm:ml-1">Ayuda</span>
                    </a>
                    <a href="https://wa.me/573334004007" target="_blank" class="text-gray-500 hover:text-gray-900 transition-colors flex items-center justify-center p-2 sm:p-0">
                        <svg class="w-8 h-8 sm:w-4 sm:h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                        </svg>
                        <span class="hidden sm:inline sm:ml-1">WhatsApp</span>
                    </a>
                    <a href="tel:+573334004007" class="text-gray-500 hover:text-gray-900 transition-colors flex items-center justify-center p-2 sm:p-0">
                        <svg class="w-8 h-8 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <span class="hidden sm:inline sm:ml-1">Tel√©fono</span>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    {# Scripts adicionales #}
    {% block extra_scripts %}{% endblock %}
    
    {# JavaScript para el Dropdown del Usuario #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownButton = document.getElementById('userDropdownButton');
            const dropdownMenu = document.getElementById('userDropdownMenu');
            const dropdownArrow = document.getElementById('dropdownArrow');
            const closeDropdown = document.getElementById('closeDropdown');
            let userDropdownOpen = false;
            
            // Funci√≥n para abrir/cerrar dropdown
            function toggleDropdown() {
                userDropdownOpen = !userDropdownOpen;
                if (userDropdownOpen) {
                    dropdownMenu.classList.remove('hidden');
                    dropdownArrow.style.transform = 'rotate(180deg)';
                } else {
                    dropdownMenu.classList.add('hidden');
                    dropdownArrow.style.transform = 'rotate(0deg)';
                }
            }
            
            // Funci√≥n para cerrar dropdown
            function closeUserDropdown() {
                userDropdownOpen = false;
                dropdownMenu.classList.add('hidden');
                dropdownArrow.style.transform = 'rotate(0deg)';
            }
            
            // Event listeners
            if (dropdownButton) {
                dropdownButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleDropdown();
                });
            }
            
            if (closeDropdown) {
                closeDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeUserDropdown();
                });
            }
            
            // Cerrar dropdown al hacer click fuera
            document.addEventListener('click', function(e) {
                if (userDropdownOpen && !dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    closeUserDropdown();
                }
            });
            
            // Cerrar dropdown con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && userDropdownOpen) {
                    closeUserDropdown();
                }
            });
            
            // Cerrar dropdown al hacer click en enlaces
            if (dropdownMenu && dropdownMenu.querySelectorAll) {
                const dropdownLinks = dropdownMenu.querySelectorAll('a');
                dropdownLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        closeUserDropdown();
                    });
                });
            }
        });
    </script>

    {# Bot√≥n To Top #}
    <button id="toTopBtn" class="fixed bottom-8 right-8 bg-gradient-to-r from-papyrus-blue to-blue-600 hover:from-blue-700 hover:to-blue-800 text-white p-4 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 opacity-0 invisible transform scale-90 hover:scale-110 z-50 border-2 border-white/20 backdrop-blur-sm" aria-label="Volver arriba">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
    </button>

    {# WhatsApp Utils - Inline para evitar problemas de carga #}
    <script>
        // Funci√≥n utilitaria para crear enlaces de WhatsApp
        function createWhatsAppLink(phoneNumber, message = '') {
            if (!phoneNumber || phoneNumber === 'undefined' || phoneNumber === 'Sin tel√©fono') {
                return null;
            }
            
            // Limpiar el n√∫mero (quitar espacios, guiones, par√©ntesis)
            const cleanPhone = phoneNumber.replace(/[\s\-\(\)]/g, '');
            
            // Si tiene +, mantenerlo; si no, agregar c√≥digo de pa√≠s por defecto (Colombia)
            const formattedPhone = cleanPhone.startsWith('+') ? cleanPhone : `+57${cleanPhone}`;
            
            // Crear enlace
            const encodedMessage = encodeURIComponent(message);
            return `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
        }
        
        // Funci√≥n para crear HTML de enlace de WhatsApp
        function createWhatsAppLinkHTML(phoneNumber, message = '', className = '') {
            const whatsappLink = createWhatsAppLink(phoneNumber, message);
            
            if (!whatsappLink) {
                return `<span class="text-sm text-gray-500">Sin tel√©fono</span>`;
            }
            
            return `
                <a href="${whatsappLink}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="inline-flex items-center text-green-600 hover:text-green-700 transition-colors duration-200 ${className}"
                   aria-label="Contactar por WhatsApp">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                    </svg>
                    ${phoneNumber}
                </a>
            `;
        }
        
        // Funci√≥n para crear enlace de tel√©fono (tel:)
        function createPhoneLink(phoneNumber) {
            if (!phoneNumber || phoneNumber === 'undefined' || phoneNumber === 'Sin tel√©fono') {
                return null;
            }
            
            // Limpiar el n√∫mero (quitar espacios, guiones, par√©ntesis)
            const cleanPhone = phoneNumber.replace(/[\s\-\(\)]/g, '');
            
            // Si tiene +, mantenerlo; si no, agregar c√≥digo de pa√≠s por defecto (Colombia)
            const formattedPhone = cleanPhone.startsWith('+') ? cleanPhone : `+57${cleanPhone}`;
            
            return `tel:${formattedPhone}`;
        }
        
        // Funci√≥n para crear HTML de enlace de tel√©fono
        function createPhoneLinkHTML(phoneNumber, className = '') {
            const phoneLink = createPhoneLink(phoneNumber);
            
            if (!phoneLink) {
                return `<span class="text-sm text-gray-500">Sin tel√©fono</span>`;
            }
            
            return `
                <a href="${phoneLink}" 
                   class="inline-flex items-center text-blue-600 hover:text-blue-700 transition-colors duration-200 ${className}"
                   aria-label="Llamar por tel√©fono">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                </a>
            `;
        }
        
        // Funci√≥n para crear HTML con ambos enlaces (WhatsApp + Tel√©fono)
        function createPhoneLinksHTML(phoneNumber, message = '', className = '') {
            const whatsappHTML = createWhatsAppLinkHTML(phoneNumber, message, className);
            const phoneHTML = createPhoneLinkHTML(phoneNumber, className);
            
            if (!phoneNumber || phoneNumber === 'undefined' || phoneNumber === 'Sin tel√©fono') {
                return `<span class="text-sm text-gray-500">Sin tel√©fono</span>`;
            }
            
            return `
                <div class="flex items-center space-x-2">
                    ${whatsappHTML}
                    ${phoneHTML}
                </div>
            `;
        }
        
        // Funci√≥n para crear bot√≥n de WhatsApp
        function createWhatsAppButton(phoneNumber, message = '', options = {}) {
            const {
                text = 'Contactar por WhatsApp',
                className = 'bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200',
                size = 'normal'
            } = options;
            
            const sizeClasses = {
                small: 'px-2 py-1 text-sm',
                normal: 'px-4 py-2',
                large: 'px-6 py-3 text-lg'
            };
            
            const finalClassName = `${className} ${sizeClasses[size] || sizeClasses.normal}`;
            
            return createWhatsAppLinkHTML(phoneNumber, message, {
                className: finalClassName,
                customText: text,
                showIcon: true
            });
        }
    </script>

    <script>
        // Auto-conversi√≥n mejorada para elementos con atributos de datos
        function convertPhoneElements() {
            const elements = document.querySelectorAll('[data-phone]');
            
            elements.forEach(element => {
                const phoneNumber = element.getAttribute('data-phone');
                const message = element.getAttribute('data-message') || '';
                const useBothIcons = element.getAttribute('data-use-both-icons') === 'true';
                
                if (phoneNumber && phoneNumber.trim() !== '') {
                    let linkHTML;
                    if (useBothIcons) {
                        linkHTML = createPhoneLinksHTML(phoneNumber, message);
                    } else {
                        linkHTML = createWhatsAppLinkHTML(phoneNumber, message);
                    }
                    element.innerHTML = linkHTML;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Convertir elementos de tel√©fono autom√°ticamente
            convertPhoneElements();
            
            const toTopBtn = document.getElementById('toTopBtn');
            if (toTopBtn) {
                window.addEventListener('scroll', function() {
                    if (window.pageYOffset > 300) {
                        toTopBtn.classList.remove('opacity-0', 'invisible', 'scale-90');
                        toTopBtn.classList.add('opacity-100', 'visible', 'scale-100');
                    } else {
                        toTopBtn.classList.add('opacity-0', 'invisible', 'scale-90');
                        toTopBtn.classList.remove('opacity-100', 'visible', 'scale-100');
                    }
                });
                toTopBtn.addEventListener('click', function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // Inicializar sistema de notificaciones
            initializeNotificationSystem();
        });

        // Sistema de Notificaciones del Header
        function initializeNotificationSystem() {
            // Solo inicializar si el usuario est√° autenticado
            // Verificar tanto la variable global como la presencia de elementos del header
            const isUserAuthenticated = typeof is_authenticated !== 'undefined' && is_authenticated;
            const hasAuthElements = document.getElementById('userDropdownButton') !== null;
            
            if (isUserAuthenticated || hasAuthElements) {
                console.log('üîî Inicializando sistema de notificaciones...');
                
                // Cargar notificaciones al inicio
                loadNotificationCount();
                // Cargar contador de paquetes ANUNCIADOS al inicio
                loadPackagesReceivedCount();
                
                // Actualizar notificaciones cada 30 segundos
                setInterval(loadNotificationCount, 30000);
                // Actualizar contador de paquetes ANUNCIADOS cada 30 segundos
                setInterval(loadPackagesReceivedCount, 30000);
                
                // Actualizar notificaciones cuando se hace foco en la ventana
                window.addEventListener('focus', () => { 
                    loadNotificationCount();
                    loadPackagesReceivedCount();
                });
                
                // Actualizar notificaciones al cambiar de pesta√±a
                document.addEventListener('visibilitychange', function() {
                    if (!document.hidden) {
                        loadNotificationCount();
                        loadPackagesReceivedCount();
                    }
                });
            } else {
                console.log('‚ÑπÔ∏è Usuario no autenticado, omitiendo sistema de notificaciones');
            }
        }

        function loadNotificationCount() {
            // Mostrar indicador de carga sutil
            const desktopBadge = document.getElementById('messages-badge');
            const mobileBadge = document.getElementById('messages-badge-mobile');
            
            if (desktopBadge && !desktopBadge.classList.contains('hidden')) {
                desktopBadge.classList.add('opacity-50');
            }
            if (mobileBadge && !mobileBadge.classList.contains('hidden')) {
                mobileBadge.classList.add('opacity-50');
            }
            
            fetch('/api/header/notifications/count', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.status === 401) {
                    // Sesi√≥n expirada - redirigir al login
                    console.log('‚ö†Ô∏è Sesi√≥n expirada, redirigiendo al login...');
                    const currentUrl = window.location.pathname + window.location.search;
                    window.location.href = `/auth/login?redirect=${encodeURIComponent(currentUrl)}`;
                    return null;
                }
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Error al cargar notificaciones');
            })
            .then(data => {
                if (data) {
                    updateNotificationBadges(data);
                }
            })
            .catch(error => {
                console.log('Error cargando notificaciones:', error);
                // En caso de error, ocultar badges
                hideNotificationBadges();
            })
            .finally(() => {
                // Remover indicador de carga
                if (desktopBadge) {
                    desktopBadge.classList.remove('opacity-50');
                }
                if (mobileBadge) {
                    mobileBadge.classList.remove('opacity-50');
                }
            });
        }

        function updateNotificationBadges(data) {
            const { count, show_badge, badge_text, badge_class } = data || {};
            
            // Actualizar badge desktop
            const desktopBadge = document.getElementById('messages-badge');
            const desktopCount = document.getElementById('messages-count');
            
            // Actualizar badge m√≥vil
            const mobileBadge = document.getElementById('messages-badge-mobile');
            const mobileCount = document.getElementById('messages-count-mobile');
            
            // Texto seguro para el contador
            const safeText = (badge_text && badge_text.length > 0)
                ? badge_text
                : (typeof count === 'number' ? String(count) : '0');

            // Regla: si no hay mensajes o el backend indica que no se muestre el badge,
            // ocultamos completamente el "tooltip"/badge.
            const shouldShow =
                typeof count === 'number'
                    ? (count > 0 && show_badge !== false)
                    : (show_badge === true);

            if (!shouldShow) {
                if (desktopBadge) desktopBadge.classList.add('hidden');
                if (mobileBadge) mobileBadge.classList.add('hidden');
                if (desktopCount) desktopCount.textContent = '0';
                if (mobileCount) mobileCount.textContent = '0';
                return;
            }

            if (desktopBadge) {
                desktopBadge.classList.remove('hidden');
                desktopBadge.className = `absolute -top-1 -right-1 ${badge_class || 'bg-papyrus-red text-white'} text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center min-w-[20px] animate-pulse`;
            }
            if (mobileBadge) {
                mobileBadge.classList.remove('hidden');
                mobileBadge.className = `absolute -top-1 -right-1 ${badge_class || 'bg-papyrus-red text-white'} text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center min-w-[20px] animate-pulse`;
            }

            // Actualizar contadores
            if (desktopCount) desktopCount.textContent = safeText;
            if (mobileCount) mobileCount.textContent = safeText;
        }

        function hideNotificationBadges() {
            // En caso de error o carga inicial sin datos, ocultar los badges
            const desktopBadge = document.getElementById('messages-badge');
            const mobileBadge = document.getElementById('messages-badge-mobile');
            const desktopCount = document.getElementById('messages-count');
            const mobileCount = document.getElementById('messages-count-mobile');

            if (desktopBadge) desktopBadge.classList.add('hidden');
            if (mobileBadge) mobileBadge.classList.add('hidden');
            if (desktopCount) desktopCount.textContent = '0';
            if (mobileCount) mobileCount.textContent = '0';
        }

        // Contador de paquetes en estado ANUNCIADO
        function loadPackagesReceivedCount() {
            const desktopBadge = document.getElementById('packages-badge');
            const mobileBadge = document.getElementById('packages-badge-mobile');
            const desktopCount = document.getElementById('packages-count');
            const mobileCount = document.getElementById('packages-count-mobile');

            fetch('/api/header/packages/announced/count', {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.status === 401) {
                    // Sesi√≥n expirada - redirigir al login
                    console.log('‚ö†Ô∏è Sesi√≥n expirada, redirigiendo al login...');
                    const currentUrl = window.location.pathname + window.location.search;
                    window.location.href = `/auth/login?redirect=${encodeURIComponent(currentUrl)}`;
                    return null;
                }
                return response.ok ? response.json() : Promise.reject('Error al cargar paquetes');
            })
            .then(data => {
                if (!data) return; // Sesi√≥n expirada, ya se est√° redirigiendo
                
                const apiCount = Number(data.count || 0);
                try { console.debug('üîî Badge Paquetes (ANUNCIADO):', apiCount); } catch (_e) {}

                // Solo mostrar badge si hay paquetes anunciados
                if (apiCount > 0) {
                    if (desktopBadge) desktopBadge.classList.remove('hidden');
                    if (mobileBadge) mobileBadge.classList.remove('hidden');
                    if (desktopCount) desktopCount.textContent = String(apiCount);
                    if (mobileCount) mobileCount.textContent = String(apiCount);
                    // Actualizar localStorage solo si hay conteo
                    try { localStorage.setItem('packages_announced_last', String(apiCount)); } catch (_e) {}
                } else {
                    // Ocultar badge si no hay paquetes anunciados
                    if (desktopBadge) desktopBadge.classList.add('hidden');
                    if (mobileBadge) mobileBadge.classList.add('hidden');
                    if (desktopCount) desktopCount.textContent = '0';
                    if (mobileCount) mobileCount.textContent = '0';
                    // Limpiar localStorage cuando no hay paquetes
                    try { localStorage.removeItem('packages_announced_last'); } catch (_e) {}
                }
            })
            .catch(() => {
                // En caso de error, ocultar badge
                if (desktopBadge) desktopBadge.classList.add('hidden');
                if (mobileBadge) mobileBadge.classList.add('hidden');
                if (desktopCount) desktopCount.textContent = '0';
                if (mobileCount) mobileCount.textContent = '0';
            });
        }

        // Funci√≥n para marcar todos los mensajes como le√≠dos
        function markAllMessagesAsRead() {
            fetch('/api/header/notifications/mark-read', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    mark_all: true
                })
            })
            .then(response => {
                if (response.ok) {
                    // Recargar contador despu√©s de marcar como le√≠dos
                    loadNotificationCount();
                }
            })
            .catch(error => {
                console.log('Error marcando mensajes como le√≠dos:', error);
            });
        }

        // ========================================
        // SISTEMA DE ALERTAS UNIFICADO
        // PAQUETEX v4.0
        // ========================================
        
        // Funci√≥n global para mostrar alertas
        function showAlert(title, message, type = 'error', options = {}) {
            const alertContainer = document.getElementById('alert-container');
            if (!alertContainer) {
                console.error('Alert container not found');
                return;
            }

            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" 
                     x-data="errorAlert({
                         title: '${title}',
                         message: '${message}',
                         type: '${type}',
                         show: true,
                         autoClose: ${options.autoClose || false},
                         closeDelay: ${options.closeDelay || 5000},
                         buttonText: '${options.buttonText || 'Cerrar'}',
                         onClose: '${options.onClose || ''}'
                     })"
                     x-show="show" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100 transform scale-100"
                     x-transition:leave-end="opacity-0 transform scale-95"
                     class="error-alert-container mb-4"
                     :class="alertTypeClass"
                     @error-closed="handleClose">
                    
                    {# Contenido de la alerta #}
                    <div class="bg-white border-l-4 p-4 shadow-lg rounded-lg max-w-md mx-auto"
                         :class="{
                             'border-red-500': type === 'error',
                             'border-yellow-500': type === 'warning',
                             'border-blue-500': type === 'info',
                             'border-green-500': type === 'success'
                         }">
                        
                        {# Header con icono y t√≠tulo #}
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                {# Icono de error #}
                                <div x-show="type === 'error'" class="w-6 h-6 text-red-500">
                                    <svg fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                
                                {# Icono de advertencia #}
                                <div x-show="type === 'warning'" class="w-6 h-6 text-yellow-500">
                                    <svg fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                
                                {# Icono de informaci√≥n #}
                                <div x-show="type === 'info'" class="w-6 h-6 text-blue-500">
                                    <svg fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                
                                {# Icono de √©xito #}
                                <div x-show="type === 'success'" class="w-6 h-6 text-green-500">
                                    <svg fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                            
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium" 
                                    :class="{
                                        'text-red-800': type === 'error',
                                        'text-yellow-800': type === 'warning',
                                        'text-blue-800': type === 'info',
                                        'text-green-800': type === 'success'
                                    }"
                                    x-text="title"></h3>
                                <div class="mt-1 text-sm" 
                                     :class="{
                                         'text-red-700': type === 'error',
                                         'text-yellow-700': type === 'warning',
                                         'text-blue-700': type === 'info',
                                         'text-green-700': type === 'success'
                                     }"
                                     x-text="message"></div>
                            </div>
                            
                            {# Bot√≥n de cerrar #}
                            <div class="ml-auto pl-3">
                                <div class="-mx-1.5 -my-1.5">
                                    <button @click="close()" 
                                            class="inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2"
                                            :class="{
                                                'text-red-500 hover:bg-red-100 focus:ring-red-600': type === 'error',
                                                'text-yellow-500 hover:bg-yellow-100 focus:ring-yellow-600': type === 'warning',
                                                'text-blue-500 hover:bg-blue-100 focus:ring-blue-600': type === 'info',
                                                'text-green-500 hover:bg-green-100 focus:ring-green-600': type === 'success'
                                            }">
                                        <span class="sr-only">Cerrar</span>
                                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Inicializar Alpine.js para la nueva alerta
            if (typeof Alpine !== 'undefined') {
                Alpine.initTree(document.getElementById(alertId));
            }
        }

        // Funciones de conveniencia
        function showError(title, message, options = {}) {
            showAlert(title, message, 'error', options);
        }

        function showWarning(title, message, options = {}) {
            showAlert(title, message, 'warning', options);
        }

        function showInfo(title, message, options = {}) {
            showAlert(title, message, 'info', options);
        }

        function showSuccess(title, message, options = {}) {
            showAlert(title, message, 'success', options);
        }

        // Reemplazar alert() nativo
        window.alert = function(message) {
            showError('Atenci√≥n', message, { autoClose: true, closeDelay: 3000 });
        };

        // Funci√≥n para mostrar errores de validaci√≥n
        function showValidationErrors(errors) {
            if (typeof errors === 'object') {
                Object.keys(errors).forEach(field => {
                    const fieldErrors = Array.isArray(errors[field]) ? errors[field] : [errors[field]];
                    fieldErrors.forEach(error => {
                        showError('Error de Validaci√≥n', `${field}: ${error}`, { autoClose: true, closeDelay: 5000 });
                    });
                });
            } else {
                showError('Error de Validaci√≥n', errors, { autoClose: true, closeDelay: 5000 });
            }
        }

        // Funci√≥n para mostrar mensajes de √©xito
        function showSuccessMessage(message) {
            showSuccess('√âxito', message, { autoClose: true, closeDelay: 3000 });
        }

        // Funci√≥n para mostrar mensajes de informaci√≥n
        function showInfoMessage(message) {
            showInfo('Informaci√≥n', message, { autoClose: true, closeDelay: 4000 });
        }

        // Funci√≥n para mostrar advertencias
        function showWarningMessage(message) {
            showWarning('Advertencia', message, { autoClose: true, closeDelay: 5000 });
        }
    </script>
</body>
</html>

{% extends "base/base.html" %}

{% block title %}Detalle del Anuncio - PAQUETEX v3.1{% endblock %}
<!-- VERSION: 2025-09-09-16:30 - PHONE DISPLAY FIX -->

{% block content %}
<!-- Sistema de Notificaciones Toast -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="space-y-6">
        <!-- Header con navegación -->
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-light text-gray-900">Detalles del Paquete</h1>
            </div>
            <div class="flex items-center space-x-3">
                <span id="announcementStatus" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold
                    {% if not announcement.is_processed %}bg-yellow-100 text-papyrus-yellow
                    {% else %}bg-green-100 text-papyrus-green{% endif %}">
                    {% if not announcement.is_processed %}ANUNCIADO{% else %}RECIBIDO{% endif %}
                </span>
                <a href="/admin" class="inline-flex items-center justify-center w-10 h-10 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors" title="Volver al Dashboard">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
            </div>
        </div>

        <!-- Información principal del anuncio -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Información del anuncio -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Información del cliente (PRIMERA) -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Cliente</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <p class="text-lg text-gray-900">{{ announcement.customer_name }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                            <p class="text-lg text-gray-900">
                                {% if announcement.customer_phone %}
                                    <span data-phone="{{ announcement.customer_phone }}" 
                                          data-message="Consulta sobre paquete {{ announcement.tracking_code or announcement.guide_number }}"
                                          data-use-both-icons="true">
                                    {{ announcement.customer_phone }}
                                    </span>
                                {% else %}
                                    Sin teléfono
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Detalles básicos -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Paquete</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Código de Consulta</label>
                            <p class="text-lg font-mono text-gray-900">{{ announcement.tracking_code }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1"># Guía</label>
                            <p class="text-lg font-mono text-gray-900">{{ announcement.guide_number }}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                            <p class="text-lg font-semibold text-gray-900">{% if not announcement.is_processed %}ANUNCIADO{% else %}RECIBIDO{% endif %}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Anuncio</label>
                            <p class="text-sm text-gray-900">{{ announcement.announced_at.strftime('%d/%m/%Y %H:%M') if announcement.announced_at else 'N/A' }}</p>
                        </div>
                    </div>
                </div>

                <!-- Costos estimados -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Costos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Costo Base</label>
                            <p class="text-lg font-semibold text-gray-900" id="baseCost">$0</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tiempo Excedido</label>
                            <p class="text-lg font-semibold text-gray-900" id="overtimeCost">$0</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Costo Total</label>
                            <p class="text-xl font-bold text-papyrus-blue" id="totalCost">$0</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Panel lateral -->
            <div class="space-y-6">
                <!-- Acciones de estado -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Procesar Anuncio</h2>
                    
                    <!-- Dropdowns y Observaciones -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Paquete</label>
                            <select id="packageType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue">
                                <option value="normal" {% if announcement.package_type == 'normal' %}selected{% endif %}>Normal</option>
                                <option value="extra_dimensioned" {% if announcement.package_type == 'extra_dimensioned' %}selected{% endif %}>Extra Dimensionado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condición del Paquete</label>
                            <select id="packageCondition" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue">
                                <option value="ok">Bueno</option>
                                <option value="regular">Regular</option>
                                <option value="opened">Abierto</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fotos del Paquete</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-papyrus-blue transition-colors">
                                <input type="file" id="packagePhotos" multiple accept="image/*" class="hidden">
                                <div id="photoUploadArea" class="cursor-pointer">
                                    <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="text-sm text-gray-600">Haz clic para subir fotos</p>
                                    <p class="text-xs text-gray-500 mt-1">Máximo 5 fotos, formato JPG/PNG</p>
                                </div>
                            </div>
                            <div id="photoPreview" class="mt-3 grid grid-cols-2 gap-2 hidden">
                                <!-- Las fotos seleccionadas se mostrarán aquí -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        {% if not announcement.is_processed %}
                        <button onclick="processAnnouncement('receive')" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Recibir
                    </button>
                    {% if user_role == 'ADMIN' %}
                    <button onclick="processAnnouncement('cancel')" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancelar Anuncio (Admin)
                    </button>
                    {% endif %}
                        {% else %}
                        <div class="space-y-3">
                        <div class="text-center py-4">
                            <div class="bg-green-100 rounded-lg p-3 inline-flex mx-auto mb-2">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                                <p class="text-sm text-gray-600">Anuncio ya recibido</p>
                            </div>

                            <!-- Cambiar Estado del Paquete -->
                            <div class="border-t border-gray-200 pt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cambiar Estado del Paquete</label>
                                <select id="statusChange" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue mb-3">
                                    <option value="">Seleccionar nuevo estado...</option>
                                    <option value="delivered">Entregado</option>
                                    <option value="cancelled">Cancelado</option>
                                </select>
                                <button onclick="changePackageStatus()"
                                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                        id="changeStatusBtn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span id="changeStatusText">Cambiar Estado</span>
                                </button>
                            </div>

                            <button id="calculateCostBtn"
                                    onclick="calculatePackageCost()"
                                    class="w-full bg-yellow-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-yellow-600 transition-colors duration-200 flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <span>Calcular Costo</span>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>

        <!-- Timeline/Historial -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Historial del Anuncio</h2>
                <button onclick="loadAnnouncementTimeline()" class="inline-flex items-center px-3 py-1 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors" title="Recargar historial">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Recargar
                </button>
            </div>
            <div id="announcementTimeline" class="space-y-4">
                <!-- Timeline se cargará dinámicamente -->
                <div class="text-center py-8">
                    <div class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-lg">
                        <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Cargando historial...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirmar Acción</h3>
                <p id="confirmMessage" class="text-gray-600 mb-4"></p>
                <div class="flex space-x-3">
                    <button id="confirmYes" class="flex-1 bg-papyrus-blue text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Confirmar
                    </button>
                    <button onclick="closeConfirmModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Variables globales
const announcementId = '{{ announcement.guide_number }}';  // Usar guide_number en lugar de UUID
let currentStatus = '{{ "recibido" if announcement.is_processed else "anunciado" }}';

// Sistema de notificaciones toast
function showToast(type, title, message, duration = 5000) {
    const container = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const icons = {
        success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>'
    };
    
    const toastHTML = `
        <div id="${toastId}" class="toast ${type}">
            <div class="toast-icon">${icons[type] || icons.info}</div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="removeToast('${toastId}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', toastHTML);
    
    const toast = document.getElementById(toastId);
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        removeToast(toastId);
    }, duration);
    
    return toastId;
}

function removeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }
}

// Función para verificar autenticación con el servidor
async function checkServerAuth() {
    try {
        const response = await fetch('/api/auth/check', {
            credentials: 'include'
        });
        const data = await response.json();
        return data.is_authenticated;
    } catch (error) {
        console.error('Error checking auth:', error);
        return false;
    }
}

// Función para procesar anuncio
async function processAnnouncement(action) {
    console.log('Processing announcement action:', action);
    
    // Verificar autenticación con el servidor
    const isAuthenticated = await checkServerAuth();
    if (!isAuthenticated) {
        showToast('error', 'Error de Autenticación', 'Debes iniciar sesión para realizar esta acción');
        setTimeout(() => {
            window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.pathname);
        }, 2000);
        return;
    }
    
    const messages = {
        'receive': '¿Estás seguro de que quieres marcar este anuncio como RECIBIDO? Esto creará un paquete en el sistema.',
        'cancel': '¿Estás seguro de que quieres CANCELAR este anuncio? Esta acción no se puede deshacer.'
    };
    
    document.getElementById('confirmMessage').textContent = messages[action];
    document.getElementById('confirmYes').onclick = () => executeAnnouncementAction(action);
    document.getElementById('confirmModal').classList.remove('hidden');
}

// Función para verificar si el usuario está autenticado
function isUserAuthenticated() {
    // Verificar si hay cookies de autenticación
    const cookies = document.cookie;
    const hasAccessToken = cookies.includes('access_token=');
    const hasUserName = cookies.includes('user_name=');
    const hasUserId = cookies.includes('user_id=');
    const hasSessionId = cookies.includes('sessionid=');
    const hasAnyAuthCookie = cookies.includes('auth') || cookies.includes('token') || cookies.includes('session');
    
    // También verificar si hay elementos del DOM que indiquen autenticación
    const userElement = document.querySelector('[data-user]') || document.querySelector('.user-info');
    const hasUserElement = userElement !== null;
    
    // Verificar si el usuario está visible en la interfaz (como "jesus" en la imagen)
    const userText = document.body.textContent;
    const hasUserInText = userText.includes('jesus') || userText.includes('Mi cuenta');
    
    const isAuthenticated = hasAccessToken || hasUserName || hasUserId || hasSessionId || hasAnyAuthCookie || hasUserElement || hasUserInText;
    
    console.log('Auth check:', {
        hasAccessToken,
        hasUserName,
        hasUserId,
        hasSessionId,
        hasAnyAuthCookie,
        hasUserElement,
        hasUserInText,
        isAuthenticated,
        cookies: cookies.substring(0, 200) + '...' // Solo mostrar primeros 200 caracteres
    });
    
    return isAuthenticated;
}

// Función para ejecutar la acción del anuncio
async function executeAnnouncementAction(action) {
    closeConfirmModal();
    
    console.log('Executing announcement action:', action);
    
    try {
        let response;
        
        if (action === 'receive') {
            // Crear paquete desde el anuncio
            const packageType = document.getElementById('packageType').value;
            const packageCondition = document.getElementById('packageCondition').value;
            const photoFiles = document.getElementById('packagePhotos').files;
            
            const requestData = {
                package_type: packageType,
                package_condition: packageCondition,
                observations: '' // Campo vacío por ahora
            };
            
            console.log('Sending request:', {
                url: `/api/announcements/${announcementId}/create-package`,
                data: requestData,
                cookies: document.cookie
            });
            
            // Por ahora, enviar solo los datos básicos sin fotos
            // TODO: Implementar subida de fotos en el backend
            response = await fetch(`/api/announcements/${announcementId}/create-package`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include', // Incluir cookies de sesión
                body: JSON.stringify(requestData)
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
        } else if (action === 'cancel') {
            response = await fetch(`/api/announcements/${announcementId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include', // Incluir cookies de sesión
                body: JSON.stringify({
                    is_active: false
                })
            });
        }
        
        if (response.ok) {
            const result = await response.json();
            showToast('success', 'Acción Completada', result.message);
            
            // Actualizar la página después de un breve delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            const error = await response.json();
            console.log('Error response:', error);
            
            if (response.status === 401 || error.detail === 'Not authenticated') {
                showToast('error', 'Error de Autenticación', 'Debes iniciar sesión para realizar esta acción');
                setTimeout(() => {
                    window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.pathname);
                }, 2000);
            } else {
                showToast('error', 'Error', error.message || error.detail || 'Error al procesar el anuncio');
            }
        }
    } catch (error) {
        showToast('error', 'Error', 'Error de conexión');
    }
}

// Función para guardar cambios del anuncio
async function saveAnnouncementChanges() {
    // Verificar autenticación
    if (!isUserAuthenticated()) {
        showToast('error', 'Error de Autenticación', 'Debes iniciar sesión para realizar esta acción');
        setTimeout(() => {
            window.location.href = '/auth/login';
        }, 2000);
        return;
    }
    
    const packageType = document.getElementById('packageType').value;
    const packageCondition = document.getElementById('packageCondition').value;
    
    try {
        const response = await fetch(`/api/announcements/${announcementId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include', // Incluir cookies de sesión
            body: JSON.stringify({
                package_type: packageType,
                package_condition: packageCondition
            })
        });
        
        if (response.ok) {
            showToast('success', 'Cambios Guardados', 'La información del anuncio ha sido actualizada');
        } else {
            const error = await response.json();
            showToast('error', 'Error', error.message || error.detail || 'Error al guardar los cambios');
        }
    } catch (error) {
        showToast('error', 'Error', 'Error de conexión');
    }
}

// Función para cerrar modal de confirmación
function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
}

// Función para cargar el timeline del anuncio
async function loadAnnouncementTimeline() {
    try {
        // Generar historial local basado en el estado del anuncio
        const announcementData = {
            id: '{{ announcement.guide_number }}',  // Usar guide_number en lugar de UUID
            customer_name: '{{ announcement.customer_name }}',
            customer_phone: '{{ announcement.customer_phone }}',
            guide_number: '{{ announcement.guide_number }}',
            tracking_code: '{{ announcement.tracking_code }}',
            is_processed: '{{ announcement.is_processed }}' === 'True',
            announced_at: '{{ announcement.announced_at }}',
            processed_at: '{{ announcement.processed_at or "" }}',
            updated_at: '{{ announcement.updated_at }}'
        };
        
        console.log('Generating timeline locally with data:', announcementData);
        
        // Generar historial local
        generateLocalTimeline(announcementData);
        
    } catch (error) {
        console.error('Error loading timeline:', error);
        // Mostrar mensaje de error en el timeline
        const timelineContainer = document.getElementById('announcementTimeline');
        timelineContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 bg-red-50 text-red-700 rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Error al cargar el historial
                </div>
            </div>
        `;
    }
}

// Función para generar timeline local
function generateLocalTimeline(announcement) {
    const timelineContainer = document.getElementById('announcementTimeline');
    
    // Crear historial basado en el estado del anuncio
    const history = [];
    
    // 1. Estado ANUNCIADO (siempre presente)
    history.push({
        status: 'ANUNCIADO',
        description: `Anuncio creado para ${announcement.customer_name}`,
        timestamp: announcement.announced_at,
        details: {
            customer_name: announcement.customer_name,
            customer_phone: announcement.customer_phone,
            guide_number: announcement.guide_number,
            tracking_code: announcement.tracking_code
        }
    });
    
    // 2. Estado RECIBIDO (solo si fue procesado)
    if (announcement.is_processed) {
        history.push({
            status: 'RECIBIDO',
            description: 'Paquete recibido en almacén',
            timestamp: announcement.processed_at || announcement.updated_at,
            details: {
                received_by: 'Personal de Almacén',
                package_condition: 'Verificado',
                storage_assigned: 'Estante A-15',
                status_change: 'ANUNCIADO → RECIBIDO'
            }
        });
    }
    
    // Mostrar el historial
    displayTimelineFromBackend({ history: history });
}

// Función para mostrar el timeline desde el backend
function displayTimelineFromBackend(data) {
    const timelineContainer = document.getElementById('announcementTimeline');
    
    if (!data.history || data.history.length === 0) {
        timelineContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 bg-gray-50 text-gray-600 rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    No hay historial disponible
                </div>
            </div>
        `;
        return;
    }
    
    const timelineHTML = data.history.map(item => {
        const formattedDate = new Date(item.timestamp).toLocaleString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        
        // Determinar icono y color según el estado
        let icon, color, bgColor;
        switch(item.status) {
            case 'ANUNCIADO':
                icon = 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z';
                color = 'text-yellow-600';
                bgColor = 'bg-yellow-100';
                break;
            case 'RECIBIDO':
                icon = 'M5 13l4 4L19 7';
                color = 'text-yellow-600';
                bgColor = 'bg-yellow-100';
                break;
            case 'ENTREGADO':
                icon = 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z';
                color = 'text-green-600';
                bgColor = 'bg-green-100';
                break;
            case 'CANCELADO':
                icon = 'M6 18L18 6M6 6l12 12';
                color = 'text-red-600';
                bgColor = 'bg-red-100';
                break;
            default:
                icon = 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
                color = 'text-gray-600';
                bgColor = 'bg-gray-100';
        }
        
        // Generar detalles HTML
        let detailsHTML = '';
        if (item.details) {
            const details = Object.entries(item.details).map(([key, value]) => {
                if (key === 'customer_phone' && value && value !== 'N/A') {
                    return `<div class="bg-white rounded px-2 py-1 border">
                        <span class="text-gray-600">Teléfono:</span> <span class="font-medium">${createPhoneLinksHTML(value, `Consulta sobre paquete ${item.details.guide_number || item.details.tracking_code}`)}</span>
                    </div>`;
                } else if (key === 'total_cost' && value) {
                    return `<div class="bg-green-50 rounded px-2 py-1 border border-green-200">
                        <span class="text-green-600">Costo:</span> <span class="font-semibold text-green-800">${value}</span>
                    </div>`;
                } else if (value && value !== 'N/A' && value !== 'undefined') {
                    return `<div class="bg-white rounded px-2 py-1 border">
                        <span class="text-gray-600">${key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span> <span class="font-medium">${value}</span>
                    </div>`;
                }
                return '';
            }).filter(detail => detail !== '').join('');
            
            if (details) {
                detailsHTML = `
                    <div class="mt-2 text-xs">
                        <div class="grid grid-cols-1 gap-1">
                            ${details}
                        </div>
                    </div>
                `;
            }
        }
        
        return `
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full ${bgColor} flex items-center justify-center">
                        <svg class="w-5 h-5 ${color}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-semibold text-gray-900">${item.status}</h4>
                            <span class="text-xs text-gray-500 font-medium">${formattedDate}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${item.description}</p>
                        ${detailsHTML}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    timelineContainer.innerHTML = timelineHTML;
    console.log('Timeline displayed successfully from backend');
}

// Función para mostrar el timeline (mantener para compatibilidad)
function displayTimeline(announcement) {
    const timelineContainer = document.getElementById('announcementTimeline');
    
    // Verificar que tenemos datos válidos
    if (!announcement) {
        timelineContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 bg-gray-50 text-gray-600 rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    No hay datos disponibles
                </div>
            </div>
        `;
        return;
    }
    
    console.log('Displaying timeline for announcement:', announcement);
    
    const timeline = [
        {
            status: 'ANUNCIADO',
            description: `Anuncio creado para ${announcement.customer_name || 'Cliente'}`,
            timestamp: announcement.announced_at,
            icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z',
            color: 'text-yellow-600',
            bgColor: 'bg-yellow-100',
            details: {
                customer_name: announcement.customer_name || 'N/A',
                customer_phone: announcement.customer_phone || 'N/A',
                guide_number: announcement.guide_number || 'N/A',
                tracking_code: announcement.tracking_code || 'N/A',
                package_type: '{{ announcement.package_type or "Normal" }}',
                package_condition: '{{ announcement.package_condition or "Bueno" }}',
                observations: '{{ announcement.observations or "Sin observaciones" }}',
                cost_estimated: '$1,500' // Costo base estimado
            }
        }
    ];
    
        // Agregar estado de recibido si aplica
    if (announcement.is_processed === true || announcement.is_processed === 'true') {
        timeline.push({
            status: 'RECIBIDO',
            description: 'Paquete recibido en almacén',
            timestamp: announcement.processed_at || announcement.updated_at,
            icon: 'M5 13l4 4L19 7',
            color: 'text-yellow-600',
            bgColor: 'bg-yellow-100',
            details: {
                received_by: 'Personal de Almacén',
                package_condition: 'Verificado',
                storage_assigned: 'Estante A-15',
                status_change: 'ANUNCIADO → RECIBIDO',
                next_step: 'Esperando reclamación del cliente'
            }
        });
    }
    
    if (timeline.length === 0) {
        timelineContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 bg-gray-50 text-gray-600 rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    No hay historial disponible
                </div>
            </div>
        `;
        return;
    }
    
    const timelineHTML = timeline.map((item, index) => {
        const isLast = index === timeline.length - 1;
        let formattedDate = 'N/A';
        
        if (item.timestamp && item.timestamp !== '') {
            try {
                // Intentar parsear la fecha
                const date = new Date(item.timestamp);
                if (!isNaN(date.getTime())) {
                    formattedDate = date.toLocaleString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    formattedDate = 'Fecha no válida';
                }
            } catch (e) {
                console.warn('Error formatting date:', e);
                formattedDate = 'Fecha no disponible';
            }
        }
        
        // Generar detalles específicos según el estado
        let detailsHTML = '';
        if (item.details) {
            if (item.status === 'ANUNCIADO') {
                detailsHTML = `
                    <div class="mt-2 text-xs">
                        <div class="grid grid-cols-2 gap-1">
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Cliente:</span> <span class="font-medium">${item.details.customer_name}</span>
                            </div>
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Guía:</span> <span class="font-mono font-medium">${item.details.guide_number}</span>
                            </div>
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Teléfono:</span> <span class="font-medium">${createPhoneLinksHTML(item.details.customer_phone, `Consulta sobre paquete ${item.details.tracking_code || item.details.guide_number}`)}</span>
                            </div>
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Fecha:</span> <span class="font-medium">${formattedDate}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (item.status === 'RECIBIDO') {
                detailsHTML = `
                    <div class="mt-2 text-xs">
                        <div class="grid grid-cols-2 gap-1">
                            <div class="bg-green-50 rounded px-2 py-1 border border-green-200">
                                <span class="text-green-600">Costo:</span> <span class="font-semibold text-green-800">${item.details.cost_calculated}</span>
                            </div>
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Acción:</span> <span class="font-medium">Paquete Creado</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (item.status === 'RECIBIDO') {
                detailsHTML = `
                    <div class="mt-2 text-xs">
                        <div class="grid grid-cols-2 gap-1">
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Ubicación:</span> <span class="font-medium">${item.details.location}</span>
                            </div>
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Estante:</span> <span class="font-medium">${item.details.storage_assigned}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (item.status === 'ENTREGADO') {
                detailsHTML = `
                    <div class="mt-2 text-xs">
                        <div class="grid grid-cols-2 gap-1">
                            <div class="bg-green-50 rounded px-2 py-1 border border-green-200">
                                <span class="text-green-600">Entregado por:</span> <span class="font-semibold text-green-800">${item.details.delivered_by || 'Personal'}</span>
                            </div>
                            <div class="bg-white rounded px-2 py-1 border">
                                <span class="text-gray-600">Estado:</span> <span class="font-medium text-green-600">Entregado</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        return `
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full ${item.bgColor} flex items-center justify-center">
                        <svg class="w-5 h-5 ${item.color}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"></path>
                        </svg>
                    </div>
                    ${!isLast ? '<div class="w-px h-8 bg-gray-300 ml-5"></div>' : ''}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-semibold text-gray-900">${item.status}</h4>
                            <span class="text-xs text-gray-500 font-medium">${formattedDate}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${item.description}</p>
                        ${detailsHTML}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    timelineContainer.innerHTML = timelineHTML;
    console.log('Timeline displayed successfully');
}

// Función para actualizar costos estimados
function updateEstimatedCosts() {
    const packageType = document.getElementById('packageType').value;
    const baseCostElement = document.getElementById('baseCost');
    const totalCostElement = document.getElementById('totalCost');
    
    const rates = {
        'normal': 1500,
        'extra_dimensioned': 2000
    };
    
    const baseCost = rates[packageType] || 1500;
    
    if (baseCostElement) {
        baseCostElement.textContent = `$${baseCost.toLocaleString()}`;
    }
    
    if (totalCostElement) {
        totalCostElement.textContent = `$${baseCost.toLocaleString()}`;
    }
}

// Función para manejar la subida de fotos
function handlePhotoUpload() {
    const fileInput = document.getElementById('packagePhotos');
    const uploadArea = document.getElementById('photoUploadArea');
    const previewContainer = document.getElementById('photoPreview');
    
    // Hacer clic en el input de archivo cuando se hace clic en el área de subida
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Manejar la selección de archivos
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        
        // Validar número de archivos
        if (files.length > 5) {
            showToast('warning', 'Demasiadas fotos', 'Solo puedes subir máximo 5 fotos');
            return;
        }
        
        // Validar tipos de archivo
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        const invalidFiles = files.filter(file => !validTypes.includes(file.type));
        
        if (invalidFiles.length > 0) {
            showToast('error', 'Formato inválido', 'Solo se permiten archivos JPG y PNG');
            return;
        }
        
        // Mostrar preview de las fotos
        showPhotoPreview(files);
    });
}

// Función para mostrar preview de las fotos
function showPhotoPreview(files) {
    const previewContainer = document.getElementById('photoPreview');
    const uploadArea = document.getElementById('photoUploadArea');
    
    if (files.length === 0) {
        previewContainer.classList.add('hidden');
        uploadArea.style.display = 'block';
        return;
    }
    
    previewContainer.innerHTML = '';
    previewContainer.classList.remove('hidden');
    
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'relative group';
            photoDiv.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-24 object-cover rounded-lg border">
                <button onclick="removePhoto(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
                    ×
                </button>
                <div class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                    ${file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name}
                </div>
            `;
            previewContainer.appendChild(photoDiv);
        };
        reader.readAsDataURL(file);
    });
    
    // Actualizar el área de subida
    uploadArea.innerHTML = `
        <svg class="w-6 h-6 mx-auto text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        <p class="text-xs text-gray-600">Agregar más fotos</p>
    `;
}

// Función para remover una foto
function removePhoto(index) {
    const fileInput = document.getElementById('packagePhotos');
    const files = Array.from(fileInput.files);
    
    // Crear un nuevo DataTransfer para actualizar el input
    const dt = new DataTransfer();
    files.forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    fileInput.files = dt.files;
    
    // Actualizar el preview
    showPhotoPreview(Array.from(fileInput.files));
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    // Cargar timeline con retry automático
    loadAnnouncementTimeline();
    
    // Actualizar costos estimados
    updateEstimatedCosts();
    
    // Actualizar costos cuando cambie el tipo de paquete
    const packageTypeSelect = document.getElementById('packageType');
    if (packageTypeSelect) {
        packageTypeSelect.addEventListener('change', updateEstimatedCosts);
    }
    
    // Inicializar subida de fotos
    handlePhotoUpload();
    
    // Auto-reload del timeline cada 30 segundos si hay errores
    setInterval(() => {
        const timelineContainer = document.getElementById('announcementTimeline');
        if (timelineContainer && timelineContainer.innerHTML.includes('Error')) {
            console.log('Auto-reloading timeline due to error...');
            loadAnnouncementTimeline();
        }
    }, 30000);
});
</script>

<style>
/* Estilos para notificaciones toast */
.toast {
    min-width: 300px;
    max-width: 400px;
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease-in-out;
    position: relative;
    overflow: hidden;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.toast.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.toast.info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.toast.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.toast-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.toast-message {
    font-size: 13px;
    opacity: 0.9;
    line-height: 1.4;
}

.toast-close {
    flex-shrink: 0;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.toast-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

/* Modal de cálculo de costos */
.cost-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.cost-modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.cost-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e5e7eb;
}

.cost-total {
    font-weight: bold;
    font-size: 1.1em;
    color: #059669;
    border-top: 2px solid #059669;
    margin-top: 10px;
    padding-top: 10px;
}
</style>

<script>
// Función para calcular el costo del paquete
async function calculatePackageCost() {
    try {
        // Mostrar loading
        const button = document.getElementById('calculateCostBtn');
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="animate-spin">⏳</span> Calculando...';
        button.disabled = true;
        
        // Obtener el ID del paquete (necesitaríamos obtenerlo del anuncio procesado)
        // Por ahora usamos el ID del anuncio como referencia
        const response = await fetch(`/api/packages/${announcementId}/calculate-cost`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Error al calcular el costo');
        }
        
        const data = await response.json();
        const costData = data.cost_calculation;
        
        // Mostrar modal con el cálculo
        showCostModal(costData);
        
    } catch (error) {
        console.error('Error calculando costo:', error);
        showToast('error', 'Error', 'No se pudo calcular el costo del paquete');
    } finally {
        // Restaurar botón
        const button = document.getElementById('calculateCostBtn');
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Función para mostrar el modal de costos
function showCostModal(costData) {
    const modal = document.createElement('div');
    modal.className = 'cost-modal';
    modal.id = 'costModal';
    
    const gracePeriodText = costData.grace_period_remaining > 0 
        ? `${costData.grace_period_remaining} horas restantes`
        : 'Período de gracia vencido';
    
    modal.innerHTML = `
        <div class="cost-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Cálculo de Costos</h3>
                <button onclick="closeCostModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-2">Información del Paquete</h4>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div>Tracking: ${costData.tracking_number}</div>
                        <div>Tipo: ${costData.package_type}</div>
                        <div>Días en bodega: ${costData.days_in_storage}</div>
                        <div>Período de gracia: ${gracePeriodText}</div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <h4 class="font-medium text-gray-900">Desglose de Costos</h4>
                    
                    <div class="cost-item">
                        <span>Costo base:</span>
                        <span>$${costData.base_cost.toLocaleString()}</span>
                    </div>
                    
                    ${costData.overtime_cost > 0 ? `
                    <div class="cost-item">
                        <span>Costo por tiempo excedido (${costData.overtime_periods} períodos de 24h):</span>
                        <span>$${costData.overtime_cost.toLocaleString()}</span>
                    </div>
                    ` : `
                    <div class="cost-item">
                        <span>Costo por tiempo excedido:</span>
                        <span>$0 (dentro del período de gracia)</span>
                    </div>
                    `}
                    
                    <div class="cost-total">
                        <span>Total a pagar:</span>
                        <span>$${costData.total_cost.toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <strong>Nota:</strong> Este cálculo es parcial. El costo final se calculará al momento de la entrega.
                    </p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'block';
}

// Función para cerrar el modal de costos
function closeCostModal() {
    const modal = document.getElementById('costModal');
    if (modal) {
        modal.remove();
    }
}

// Función para cambiar el estado del paquete
async function changePackageStatus() {
    const statusSelect = document.getElementById('statusChange');
    const newStatus = statusSelect.value;

    if (!newStatus) {
        showToast('warning', 'Estado requerido', 'Por favor selecciona un nuevo estado para el paquete');
        return;
    }

    // Verificar autenticación
    if (!isUserAuthenticated()) {
        showToast('error', 'Error de Autenticación', 'Debes iniciar sesión para realizar esta acción');
        setTimeout(() => {
            window.location.href = '/auth/login';
        }, 2000);
        return;
    }

    // Obtener el package_id del anuncio (disponible cuando está procesado)
    const packageId = '{{ announcement.package_id if announcement.package_id else "" }}';

    if (!packageId) {
        showToast('error', 'Error', 'No se pudo obtener el ID del paquete. Asegúrate de que el paquete haya sido recibido primero.');
        return;
    }

    // Mostrar loading
    const button = document.getElementById('changeStatusBtn');
    const buttonText = document.getElementById('changeStatusText');
    const originalText = buttonText.textContent;
    button.disabled = true;
    buttonText.textContent = 'Cambiando...';

    try {
        const response = await fetch(`/api/packages/${packageId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                status: newStatus
            })
        });

        if (response.ok) {
            const result = await response.json();

            // Mapear estado a español para el mensaje
            const statusMessages = {
                'delivered': 'Entregado',
                'cancelled': 'Cancelado'
            };
            const statusText = statusMessages[newStatus] || newStatus;

            showToast('success', 'Estado Actualizado', `El paquete ha sido marcado como ${statusText}`);

            // Actualizar el badge de estado en el header
            updateStatusBadge(newStatus);

            // Limpiar el select
            statusSelect.value = '';

            // Recargar el timeline para mostrar el cambio
            setTimeout(() => {
                loadAnnouncementTimeline();
            }, 1000);

        } else {
            const error = await response.json();
            showToast('error', 'Error', error.message || error.detail || 'Error al cambiar el estado del paquete');
        }
    } catch (error) {
        console.error('Error cambiando estado:', error);
        showToast('error', 'Error', 'Error de conexión al cambiar el estado');
    } finally {
        // Restaurar botón
        button.disabled = false;
        buttonText.textContent = originalText;
    }
}

// Función para actualizar el badge de estado
function updateStatusBadge(newStatus) {
    const statusBadge = document.getElementById('announcementStatus');

    if (statusBadge) {
        // Remover clases anteriores
        statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold';

        // Agregar clases según el nuevo estado
        switch(newStatus) {
            case 'delivered':
                statusBadge.classList.add('bg-green-100', 'text-papyrus-green');
                statusBadge.textContent = 'ENTREGADO';
                break;
            case 'cancelled':
                statusBadge.classList.add('bg-red-100', 'text-red-600');
                statusBadge.textContent = 'CANCELADO';
                break;
            default:
                statusBadge.classList.add('bg-green-100', 'text-papyrus-green');
                statusBadge.textContent = 'RECIBIDO';
        }
    }
}

// Cerrar modal al hacer clic fuera de él
document.addEventListener('click', function(event) {
    const modal = document.getElementById('costModal');
    if (modal && event.target === modal) {
        closeCostModal();
    }
});
</script>
{% endblock %}

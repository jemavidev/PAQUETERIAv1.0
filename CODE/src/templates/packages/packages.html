 {% extends "base/base.html" %}

{% block title %}PAQUETES - PAQUETEX v4.0{% endblock %}

{% block content %}
<!-- Verificaci贸n de autenticaci贸n -->
{% if not is_authenticated %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-8 text-center">
        <div class="bg-gray-100 rounded-lg p-3 inline-flex mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900">Acceso Restringido</h3>
        <p class="mt-2 text-sm text-gray-500">Debes iniciar sesi贸n para acceder a la gesti贸n de paquetes.</p>
        <div class="mt-6">
            <a href="/auth/login" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-papyrus-blue hover:bg-blue-700 transition-colors duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                </svg>
                Iniciar Sesi贸n
            </a>
        </div>
    </div>
</div>
{% else %}
<div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 py-3 sm:py-4 lg:py-6 xl:py-8">
    <div class="space-y-4 sm:space-y-6">
        <!-- Filtros y Acciones Compactos (estilo Mensajes) -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-3 sm:p-4 lg:p-6 mb-4 sm:mb-6">
            <div class="flex flex-col space-y-3 lg:flex-row lg:items-center lg:space-x-6 lg:space-y-0">
                <h1 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-light text-gray-900">Paquetes</h1>

                <div class="flex flex-col space-y-3 sm:flex-row sm:items-center sm:space-y-0 sm:gap-3 lg:gap-4 w-full">
                    <!-- B煤squeda por todos los campos -->
                    <div class="relative flex-1 min-w-0">
                        <input id="searchFilter"
                                type="text"
                                placeholder="Buscar..."
                                class="w-full px-4 py-3 sm:py-2.5 md:py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue bg-white transition-colors text-base sm:text-base touch-manipulation"
                                autocomplete="off"
                                autocorrect="off"
                                autocapitalize="off"
                                spellcheck="false">
                    </div>

                    <!-- Botones de acci贸n -->
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <!-- Bot贸n para ir a anunciar paquetes -->
                        <button onclick="window.location.href='/announce'"
                                class="inline-flex items-center justify-center w-11 h-11 sm:w-10 sm:h-10 border border-transparent rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 active:scale-95 touch-manipulation"
                                title="Anunciar nuevo paquete">
                            <svg class="w-5 h-5 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>

                        <!-- Botones de estado agrupados -->
                        <div class="flex items-center gap-1">
                            <!-- Anunciado -->
                            <button id="filterAnnounced" class="inline-flex items-center justify-center w-11 h-11 sm:w-10 sm:h-10 border border-transparent rounded-lg shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 active:scale-95 touch-manipulation" title="Anunciado">
                                <svg class="w-5 h-5 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                            <!-- Recibido -->
                            <button id="filterReceived" class="inline-flex items-center justify-center w-11 h-11 sm:w-10 sm:h-10 border border-transparent rounded-lg shadow-sm text-white bg-blue-500 hover:bg-blue-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 active:scale-95 touch-manipulation" title="Recibido">
                                <svg class="w-5 h-5 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                            <!-- Entregado -->
                            <button id="filterDelivered" class="inline-flex items-center justify-center w-11 h-11 sm:w-10 sm:h-10 border border-transparent rounded-lg shadow-sm text-white bg-green-500 hover:bg-green-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 active:scale-95 touch-manipulation" title="Entregado">
                                <svg class="w-5 h-5 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                            </button>
                            <!-- Cancelado -->
                            <button id="filterCancelled" class="inline-flex items-center justify-center w-11 h-11 sm:w-10 sm:h-10 border border-transparent rounded-lg shadow-sm text-white bg-red-500 hover:bg-red-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 active:scale-95 touch-manipulation" title="Cancelado">
                                <svg class="w-5 h-5 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Bot贸n de limpiar filtros -->
                        <button id="clearFilters"
                                class="inline-flex items-center justify-center w-11 h-11 sm:w-10 sm:h-10 border border-gray-300 rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-papyrus-blue active:scale-95 touch-manipulation"
                                title="Limpiar filtros">
                            <svg class="w-5 h-5 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Paquetes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="border-b border-gray-100 px-3 sm:px-4 lg:px-8 py-3 sm:py-4 lg:py-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-base sm:text-lg font-medium text-gray-900">Lista de Paquetes</h2>
                    <div id="totalPackagesCount" class="text-sm text-gray-700"></div>
                </div>
            </div>

            <!-- Tabla responsive -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Estado
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Gu铆a / C贸digo
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                                Cliente
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">
                                Contacto
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden xl:table-cell">
                                Fecha
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-40 md:w-48">
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="packagesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Los paquetes se cargar谩n aqu铆 -->
                    </tbody>
                </table>
            </div>
            
            <!-- Contenedor para paginaci贸n -->
            <div id="paginationContainer" class="hidden border-t border-gray-200 bg-white px-3 py-4 sm:px-6 rounded-b-xl"></div>

            <!-- Loading state -->
            <div id="packagesLoading" class="text-center py-12 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-papyrus-blue-600 mx-auto"></div>
                <p class="mt-4 text-sm text-gray-500">Cargando paquetes...</p>
            </div>

            <!-- Empty state -->
            <div id="packagesEmpty" class="text-center py-12">
                <div class="bg-gray-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">No hay paquetes</h3>
                <p class="mt-2 text-sm text-gray-500">No se encontraron paquetes con los filtros aplicados.</p>
            </div>

        </div>
    </div>
</div>

<!-- Modal de Acci贸n de Paquete -->
<div id="packageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50" style="scrollbar-width: none; -ms-overflow-style: none;" onclick="closeModalOnBackdrop(event)">
    <div class="relative top-2 sm:top-4 md:top-8 lg:top-20 mx-auto p-2 sm:p-3 md:p-4 lg:p-5 w-11/12 sm:w-10/12 md:w-3/4 lg:w-1/2 max-w-4xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto" style="scrollbar-width: none; -ms-overflow-style: none;" onclick="event.stopPropagation()">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100">
            <div class="border-b border-gray-100 px-3 sm:px-4 lg:px-8 py-3 sm:py-4 lg:py-6 flex items-center justify-between">
                <h3 id="modalTitle" class="text-lg sm:text-xl font-light text-gray-900">Acci贸n del Paquete</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="p-3 sm:p-4 lg:p-6">
                <div id="packageDetail">
                   <!-- El contenido del paquete se cargar谩 aqu铆 -->
                </div>

                <!-- Formulario de acci贸n -->
                <div id="actionForm" class="mt-3 sm:mt-4 border-gray-200">
                    <h4 id="actionTitle" class="text-base sm:text-lg font-medium text-gray-900 mb-2 sm:mb-3">Confirmar Acci贸n</h4>
                    
                    <!-- Input de archivo optimizado para escritorio (fuera del receiveForm para que siempre sea accesible) -->
                    <input type="file" id="packageImages" multiple accept="image/jpeg,image/jpg,image/png,image/webp" style="position: absolute; left: -9999px; opacity: 0; pointer-events: auto; width: 1px; height: 1px; z-index: 1000;" />
                    
                    <!-- Formulario espec铆fico de recepci贸n -->
                    <div id="receiveForm" class="space-y-6 hidden">
                        <!-- Informaci贸n del Paquete a Recibir - HIDDEN -->
                        <div class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>
                                <h4 class="font-bold text-blue-800 text-lg">INFORMACIN DEL PAQUETE A RECIBIR</h4>
                            </div>
                            <div id="receivePackageInfo" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <!-- La informaci贸n del paquete se cargar谩 aqu铆 din谩micamente -->
                            </div>
                        </div>

                        <!-- Verificaci贸n F铆sica -->
                        <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-100">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h4 class="font-bold text-orange-800 text-lg">VERIFICACIN FSICA</h4>
                            </div>
                            
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Tipo de Paquete -->
                            <div>
                                    <label for="packageType" class="block text-sm font-medium text-orange-700 mb-2">
                                    Tipo de Paquete <span class="text-red-500">*</span>
                                </label>
                                <select id="packageType"
                                            class="w-full px-4 py-3 border border-orange-200 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-colors text-base touch-manipulation bg-white shadow-sm"
                                        required>
                                    <option value="">Seleccionar tipo</option>
                                        <option value="normal">Normal (30x30x30cm)</option>
                                        <option value="extra_dimensioned">Extra Dimensionado</option>
                                </select>
                            </div>

                            <!-- Condici贸n del Paquete -->
                            <div>
                                    <label for="packageCondition" class="block text-sm font-medium text-orange-700 mb-2">
                                    Condici贸n del Paquete <span class="text-red-500">*</span>
                                </label>
                                <select id="packageCondition"
                                            class="w-full px-4 py-3 border border-orange-200 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-colors text-base touch-manipulation bg-white shadow-sm"
                                        required>
                                    <option value="">Seleccionar condici贸n</option>
                                    <option value="ok">Bueno</option>
                                    <option value="regular">Regular</option>
                                    <option value="opened">Abierto</option>
                                </select>
                                </div>
                            </div>
                        </div>

                        <!-- Documentaci贸n Fotogr谩fica -->
                        <div class="bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-100">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <h4 class="font-bold text-purple-800 text-lg">DOCUMENTACIN FOTOGRFICA</h4>
                            </div>
                            
                            <div class="space-y-4">
                                <!-- Bot贸n para seleccionar archivos (el input est谩 fuera del receiveForm para que siempre sea accesible) -->
                                <button type="button" id="selectImagesBtn"
                                        class="w-full px-6 py-4 border-2 border-dashed border-purple-300 rounded-xl text-purple-600 hover:border-purple-400 hover:text-purple-700 hover:bg-purple-50 transition-all duration-200 touch-manipulation min-h-[60px] flex flex-col items-center justify-center cursor-pointer">
                                    <div class="flex items-center justify-center mb-2">
                                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-sm font-medium desktop-text">Seleccionar im谩genes</span>
                                    <span class="text-xs text-purple-500 mt-1">JPG, PNG, WEBP (m谩x. 5MB cada una)</span>
                                </button>

                                <!-- Preview de im谩genes seleccionadas -->
                                <div id="imagePreview" class="hidden">
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                        <!-- Las previews se cargar谩n aqu铆 din谩micamente -->
                                    </div>
                                </div>

                                <!-- Contador de im谩genes -->
                                <div id="imageCounter" class="hidden">
                                    <div class="bg-purple-100 border border-purple-200 rounded-lg p-3">
                                        <div class="flex items-center space-x-2">
                                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span class="text-sm text-purple-700 font-medium">
                                    <span id="imageCount">0</span> de 3 im谩genes seleccionadas
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Indicador de subida a S3 -->
                                <div id="uploadProgress" class="hidden">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <div class="flex items-center space-x-3">
                                            <svg class="animate-spin w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span class="text-sm text-blue-700 font-medium">Subiendo im谩genes a AWS S3...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Formulario espec铆fico de entrega -->
                    <div id="deliverForm" class="space-y-4 hidden">
                        <!-- INFORMACIN DE PAGO -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 mb-3">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <h3 class="font-bold text-blue-800 text-lg">INFORMACIN DE PAGO</h3>
                            </div>
                            <div id="paymentSummary" class="text-base text-blue-700">
                                <!-- El resumen de pago se cargar谩 aqu铆 -->
                            </div>
                        </div>

                        <!-- FECHAS IMPORTANTES -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 mb-3">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <h3 class="font-bold text-green-800 text-lg">FECHAS IMPORTANTES</h3>
                            </div>
                            <div id="datesSummary" class="text-base text-green-700">
                                <!-- Las fechas importantes se cargar谩n aqu铆 -->
                            </div>
                        </div>

                        <!-- CAMPOS DE PAGO -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="font-bold text-gray-800 text-lg mb-3">CONFIRMACIN DE PAGO</h3>
                            <!-- Monto Total a Pagar -->
                            <div>
                                <label for="paymentAmount" class="block text-sm font-medium text-gray-700 mb-2">
                                    Total <span class="text-red-500">*</span>
                                    <span class="text-sm text-gray-500 ml-1">(Bodegaje + Tarifa base)</span>
                                </label>
                                <input type="number"
                                       id="paymentAmount"
                                       step="0.01"
                                       min="0"
                                       class="w-full px-3 py-3 sm:py-2.5 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue transition-colors text-base touch-manipulation"
                                       placeholder="0.00"
                                       required>
                                <p class="text-sm text-gray-500 mt-1">
                                    <span id="suggestedAmountText">Valor calculado: $0.00</span>
                                </p>
                            </div>
                        </div>

                        <!-- Campo de observaciones de entrega - HIDDEN -->
                        <div class="hidden">
                            <label for="deliverObservations" class="block text-sm font-medium text-gray-500 mb-2">
                                Observaciones (oculto)
                            </label>
                            <textarea id="deliverObservations"
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500"
                                    placeholder="Campo oculto..."
                                    maxlength="500"
                                    disabled></textarea>
                        </div>
                    </div>

                    <!-- Formulario gen茅rico para otras acciones -->
                    <div id="genericForm" class="space-y-2">
                        <div id="actionMessage" class="text-sm text-gray-600">
                            <!-- Mensaje espec铆fico de la acci贸n -->
                        </div>

                        <!-- Campo de observaciones gen茅rico - HIDDEN -->
                        <div class="hidden">
                            <label for="actionObservations" class="block text-sm font-medium text-gray-500 mb-2">
                                Observaciones (oculto)
                            </label>
                            <textarea id="actionObservations"
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500"
                                    placeholder="Campo oculto..."
                                    maxlength="500"
                                    disabled></textarea>
                        </div>
                    </div>

                    <!-- Secci贸n Posici贸n Generada -->
                    <div id="barotiSection" class="hidden mt-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg">
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">POSICION ASIGNADA</h3>
                            <div class="bg-white p-6 rounded-lg shadow-lg border-2 border-green-300">
                                <div id="barotiNumber" class="text-4xl font-bold text-green-600 tracking-wider">
                                    <!-- N煤mero de posici贸n se mostrar谩 aqu铆 -->
                                </div>                           
                            </div>
                        </div>
                    </div>

                    <!-- Bot贸n de Enviar Email (solo visible cuando aplica) -->
                    <div id="emailNotificationSection" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-blue-900">Notificaci贸n por Email</p>
                                    <p class="text-xs text-blue-700" id="emailRecipientInfo">Email del cliente disponible</p>
                                </div>
                            </div>
                            <button id="sendEmailButton"
                                    onclick="sendPackageEmail()"
                                    class="flex-shrink-0 px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-all duration-200 active:scale-95 touch-manipulation flex items-center justify-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Enviar Email
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 flex flex-row justify-end space-x-2 flex-nowrap">
                        <button id="cancelAction"
                                class="hidden flex-shrink-0 px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 active:scale-95 touch-manipulation flex items-center justify-center whitespace-nowrap">
                            Cancelar
                        </button>
                        <button id="confirmAction"
                                class="flex-shrink-0 px-4 py-2 border border-transparent rounded-lg shadow-lg text-sm font-bold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 hover:shadow-xl transition-all duration-200 active:scale-95 touch-manipulation flex items-center justify-center whitespace-nowrap">
                            <span id="confirmButtonText">Confirmar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Posici贸n - Estilo Simple y Limpio -->
<div id="barotiModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[60]" onclick="closeBarotiModalOnBackdrop(event)">
    <div class="relative top-20 mx-auto p-5 w-11/12 sm:w-10/12 md:w-3/4 lg:w-1/2 max-w-lg" onclick="event.stopPropagation()">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100">
            
            <!-- Header -->
            <div class="border-b border-gray-100 px-6 py-5 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-light text-gray-900">Posici贸n Asignada</h3>
                </div>
                <button onclick="closeBarotiModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Body -->
            <div class="p-8">
                <!-- N煤mero de posici贸n -->
                <div class="text-center mb-6">
                    <p class="text-sm text-gray-500 mb-3">Ubicaci贸n en bodega</p>
                    <div class="bg-gray-50 rounded-lg p-8 border border-gray-200">
                        <div id="barotiModalNumber" class="text-6xl font-bold text-gray-900 tracking-wider">
                            <!-- N煤mero de posici贸n se mostrar谩 aqu铆 -->
                        </div>
                    </div>
                </div>
                
                <!-- Mensaje informativo -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-sm text-green-800">
                            El paquete ha sido almacenado exitosamente en esta ubicaci贸n.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Secci贸n de Email (se muestra din谩micamente si aplica) -->
            <div id="barotiEmailSectionContent" class="px-6 pb-4">
                <!-- Se inserta aqu铆 din谩micamente -->
            </div>

            <!-- Footer -->
            <div class="border-t border-gray-100 px-6 py-4 bg-gray-50">
                <button onclick="closeBarotiModal()" 
                        class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors touch-manipulation min-h-[48px]">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sistema de Notificaciones Toast -->
<div id="toastContainer" class="fixed top-4 left-4 right-4 sm:top-4 sm:left-auto sm:right-4 z-50 space-y-2 max-w-full sm:max-w-sm mx-auto sm:mx-0"></div>
{% endblock %}

{% block extra_scripts %}
<style>
.line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* Animaci贸n simple para el modal de posici贸n */
#barotiModalNumber {
    animation: fadeInNumber 0.4s ease-out;
}

@keyframes fadeInNumber {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Estilos para notificaciones toast */
.toast {
    min-width: 280px;
    max-width: 320px;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease-in-out;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

@media (min-width: 640px) {
    .toast {
        min-width: 300px;
        max-width: 400px;
        padding: 16px;
        gap: 12px;
    }
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.toast.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.toast.info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.toast.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.toast-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.toast-message {
    font-size: 13px;
    opacity: 0.9;
    line-height: 1.4;
}

.toast-close {
    flex-shrink: 0;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.toast-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background-color: rgba(255, 255, 255, 0.3);
    transition: width linear;
}

/* Ocultar scrollbar en el modal pero mantener funcionalidad */
#packageModal::-webkit-scrollbar {
    display: none !important;
}

#packageModal *::-webkit-scrollbar {
    display: none !important;
}

/* Optimizaciones m贸viles */
@media (max-width: 640px) {
    .space-y-3 > * + * {
        margin-top: 0.75rem;
    }

    .space-y-4 > * + * {
        margin-top: 1rem;
    }

    button {
        min-height: 44px;
        touch-action: manipulation;
    }

    input, textarea {
        font-size: 16px;
    }

    #packageModal .relative {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
}

@media (hover: none) and (pointer: coarse) {
    .touch-manipulation {
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
    }

    button:active, .cursor-pointer:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
<script>
// ========================================
// DETECCIN DE DISPOSITIVOS MVILES
// ========================================
// Detecci贸n mejorada de dispositivos m贸viles (m谩s precisa)
function isMobileDevice() {
    // Detecci贸n m谩s estricta para evitar falsos positivos en escritorio
    const userAgent = navigator.userAgent.toLowerCase();
    const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
    const isSmallScreen = window.innerWidth <= 768;
    const hasTouchOnly = navigator.maxTouchPoints > 0 && !window.matchMedia('(pointer: fine)').matches;
    
    const result = isMobileUA || (isSmallScreen && hasTouchOnly);
    
    // Log de depuraci贸n
    console.log(' Detecci贸n de dispositivo:', {
        userAgent: userAgent,
        isMobileUA: isMobileUA,
        screenWidth: window.innerWidth,
        isSmallScreen: isSmallScreen,
        touchPoints: navigator.maxTouchPoints,
        hasFinePonter: window.matchMedia('(pointer: fine)').matches,
        hasTouchOnly: hasTouchOnly,
        resultado: result ? ' MVIL' : ' ESCRITORIO'
    });
    
    return result;
}

// Funci贸n optimizada para mostrar opciones de captura solo en m贸viles reales
function showMobileCaptureOptions() {
    // Solo mostrar opciones en dispositivos m贸viles reales
    if (!isMobileDevice()) {
        return false; // No es m贸vil, usar comportamiento normal (solo galer铆a)
    }
    
    // Crear modal de opciones para m贸viles
    const optionsModal = document.createElement('div');
    optionsModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
    optionsModal.innerHTML = `
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">Seleccionar im谩genes</h3>
            <div class="space-y-3">
                <button id="takePictureBtn" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Tomar foto
                </button>
                <button id="selectFromGalleryBtn" class="w-full flex items-center justify-center px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Seleccionar de galer铆a
                </button>
                <button id="cancelCaptureBtn" class="w-full px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(optionsModal);
    
    // Manejar opciones
    const takePictureBtn = optionsModal.querySelector('#takePictureBtn');
    const selectFromGalleryBtn = optionsModal.querySelector('#selectFromGalleryBtn');
    const cancelBtn = optionsModal.querySelector('#cancelCaptureBtn');
    const packageImagesInput = document.getElementById('packageImages');
    
    takePictureBtn.addEventListener('click', () => {
        // Configurar input para c谩mara
        packageImagesInput.setAttribute('capture', 'environment');
        packageImagesInput.setAttribute('accept', 'image/*');
        packageImagesInput.click();
        document.body.removeChild(optionsModal);
    });
    
    selectFromGalleryBtn.addEventListener('click', () => {
        // Configurar input para galer铆a (sin capture)
        packageImagesInput.removeAttribute('capture');
        packageImagesInput.setAttribute('accept', 'image/jpeg,image/jpg,image/png,image/webp');
        packageImagesInput.click();
        document.body.removeChild(optionsModal);
    });
    
    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(optionsModal);
    });
    
    // Cerrar al hacer click fuera del modal
    optionsModal.addEventListener('click', (e) => {
        if (e.target === optionsModal) {
            document.body.removeChild(optionsModal);
        }
    });
    
    return true; // Indica que se mostr贸 el modal m贸vil
}

// ========================================
// Sistema de Notificaciones Toast
// ========================================
function showToast(type, title, message, duration = 5000) {
    const container = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();

    const icons = {
        success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>'
    };

    const toastHTML = `
        <div id="${toastId}" class="toast ${type}">
            <div class="toast-icon">${icons[type] || icons.info}</div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="removeToast('${toastId}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <div class="toast-progress" style="width: 100%;"></div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', toastHTML);

    const toast = document.getElementById(toastId);
    const progress = toast.querySelector('.toast-progress');

    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    setTimeout(() => {
        progress.style.width = '0%';
        progress.style.transition = `width ${duration}ms linear`;
    }, 100);

    setTimeout(() => {
        removeToast(toastId);
    }, duration);

    return toastId;
}

function removeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }
}

// Funciones de conveniencia
function showSuccessToast(title, message, duration) {
    return showToast('success', title, message, duration);
}

function showErrorToast(title, message, duration) {
    return showToast('error', title, message, duration);
}

function showInfoToast(title, message, duration) {
    return showToast('info', title, message, duration);
}

function showWarningToast(title, message, duration) {
    return showToast('warning', title, message, duration);
}

// Cache de elementos DOM
const domCache = {
    searchInput: null,
    packagesTableBody: null
};

// Estado de paquetes por secci贸n
let packagesByState = {
    announced: [],
    received: [],
    delivered: [],
    cancelled: []
};

let currentPackageId = null;
let currentAction = null;
let currentPackage = null;
let currentStatusFilter = null; // Track current status filter

// Inicializar cache de DOM
function initializeDOMCache() {
    domCache.searchInput = document.getElementById('searchFilter');
    domCache.packagesTableBody = document.getElementById('packagesTableBody');
    domCache.totalPackagesBadge = document.getElementById('totalPackagesBadge');

    console.log(' Cache de elementos DOM inicializado');
}

// Cargar paquetes
let currentPage = 1;
let currentLimit = 10; // 10 paquetes por p谩gina
let totalPages = 1;
let totalPackages = 0;

function loadPackages(page = 1) {
    const token = getAuthToken();

    if (!token) {
        console.error('No hay token de autenticaci贸n disponible');
        window.location.href = '/auth/login';
        return;
    }

    console.log('Cargando paquetes con token:', token ? 'presente' : 'ausente');

    // Mostrar loading en todas las secciones
    showLoadingStates(true);

    const params = new URLSearchParams({
        skip: ((page - 1) * currentLimit).toString(),
        limit: currentLimit.toString()
    });
    
    // Agregar filtro de estado si est谩 activo
    if (currentStatusFilter) {
        // Mapear el estado del frontend al formato del backend
        const statusMap = {
            'announced': 'ANUNCIADO',
            'received': 'RECIBIDO',
            'delivered': 'ENTREGADO',
            'cancelled': 'CANCELADO'
        };
        const backendStatus = statusMap[currentStatusFilter] || currentStatusFilter.toUpperCase();
        params.append('status_filter', backendStatus);
    }

    fetch(`/api/packages/?${params.toString()}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Datos recibidos desde API:', data);
        
        // La API ahora retorna un objeto con packages y pagination
        const packages = Array.isArray(data) ? data : (data.packages || []);
        const pagination = data.pagination || null;

        // Usar informaci贸n de paginaci贸n del backend
        if (pagination) {
            totalPackages = pagination.total;
            totalPages = pagination.total_pages;
            currentPage = pagination.page;
            window.currentPagination = pagination; // Guardar para mostrar controles
            
            // Actualizar contador de paquetes
            const startItem = ((pagination.page - 1) * pagination.limit) + 1;
            const endItem = Math.min(pagination.page * pagination.limit, pagination.total);
            const totalCountEl = document.getElementById('totalPackagesCount');
            if (totalCountEl) {
                totalCountEl.innerHTML = `
                    Mostrando 
                    <span class="font-medium">${startItem}</span>
                    a 
                    <span class="font-medium">${endItem}</span>
                    de 
                    <span class="font-medium">${pagination.total}</span> 
                    resultados
                `;
            }
        } else {
            // Fallback si no hay informaci贸n de paginaci贸n
            totalPackages = packages.length;
            totalPages = totalPackages === currentLimit ? currentPage + 1 : currentPage;
            window.currentPagination = null;
            
            const totalCountEl = document.getElementById('totalPackagesCount');
            if (totalCountEl) {
                totalCountEl.textContent = `Total: ${totalPackages}`;
            }
        }
        displayPackagesByState(packages);
        displayPaginationControls(pagination);
    })
    .catch(error => {
        console.error('Error cargando paquetes:', error);
        showLoadingStates(false);
        showErrorState();
    });
}

function showLoadingStates(show) {
    const packagesLoading = document.getElementById('packagesLoading');
    if (show) {
        packagesLoading.classList.remove('hidden');
    } else {
        packagesLoading.classList.add('hidden');
    }
}

function showErrorState() {
    const errorHTML = `
        <tr>
            <td colspan="7" class="px-6 py-12 text-center">
                <div class="bg-red-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Error al cargar paquetes</h3>
                <p class="mt-2 text-sm text-gray-500">No se pudieron cargar los paquetes. Intenta recargar la p谩gina.</p>
            </td>
        </tr>
    `;

    // Mostrar error en la tabla
    domCache.packagesTableBody.innerHTML = errorHTML;
}

function displayPackagesByState(packages) {
    // Reset packages by state
    packagesByState = {
        announced: [],
        received: [],
        delivered: [],
        cancelled: []
    };

    // Clasificar paquetes por estado
    packages.forEach(package => {
        const status = package.status?.toLowerCase();
        console.log(` Clasificando paquete ID: ${package.id}, Status: ${status}, Tracking: ${package.tracking_number}`);
        
        if (status === 'announced' || status === 'anunciado') {
            packagesByState.announced.push(package);
        } else if (status === 'received' || status === 'recibido') {
            packagesByState.received.push(package);
        } else if (status === 'delivered' || status === 'entregado') {
            packagesByState.delivered.push(package);
        } else if (status === 'cancelled' || status === 'cancelado') {
            packagesByState.cancelled.push(package);
        } else {
            console.warn(`锔 Estado no reconocido para paquete ${package.id}: "${status}"`);
        }
    });

    // Ocultar loading
    showLoadingStates(false);

    // Mostrar todos los paquetes en la tabla
    displayPackagesInTable(packages);

    // Actualizar contadores
    updateStateCounts();

    console.log(' Paquetes organizados por estado exitosamente');
    console.log(' Resumen por estado:', {
        announced: packagesByState.announced.length,
        received: packagesByState.received.length,
        delivered: packagesByState.delivered.length,
        cancelled: packagesByState.cancelled.length
    });
    console.log(' IDs por estado:', {
        announced: packagesByState.announced.map(p => p.id),
        received: packagesByState.received.map(p => p.id),
        delivered: packagesByState.delivered.map(p => p.id),
        cancelled: packagesByState.cancelled.map(p => p.id)
    });
}

function displayPackagesInTable(packages) {
    const tableBody = domCache.packagesTableBody;
    const emptyElement = document.getElementById('packagesEmpty');

    if (packages.length === 0) {
        tableBody.innerHTML = '';
        emptyElement.classList.remove('hidden');
    } else {
        emptyElement.classList.add('hidden');
        tableBody.innerHTML = '';

        packages.forEach(package => {
            const packageRow = createPackageElement(package);
            tableBody.appendChild(packageRow);
        });
    }
}

function updateStateCounts() {
    // Contar paquetes ANUNCIADOS (requerimiento)
    const announcedCount = packagesByState.announced.length;

    // Si existe un filtro activo de estado, tambi茅n respetar filas visibles
    const tableBody = domCache.packagesTableBody;
    let visibleAnnouncedCount = 0;
    if (tableBody) {
        const visibleRows = tableBody.querySelectorAll('tr[data-search]:not([style*="display: none"])');
        visibleAnnouncedCount = Array.from(visibleRows).filter(row => {
            const status = (row.getAttribute('data-status') || '').toLowerCase();
            return status === 'announced' || status === 'anunciado';
        }).length;
    }

    // Actualizar contador local en la cabecera de la tabla
    const countElement = document.getElementById('totalPackagesCount');
    if (countElement) {
        countElement.textContent = `Anunciados: ${visibleAnnouncedCount || announcedCount}`;
    }

    // Sincronizar inmediatamente el badge del header (desktop y m贸vil)
    // para que refleje el n煤mero de ANUNCIADOS sin esperar al polling
    const desktopBadge = document.getElementById('packages-badge');
    const mobileBadge = document.getElementById('packages-badge-mobile');
    const desktopCount = document.getElementById('packages-count');
    const mobileCount = document.getElementById('packages-count-mobile');

    const announcedForBadge = visibleAnnouncedCount || announcedCount;
    if (announcedForBadge > 0) {
        if (desktopBadge) desktopBadge.classList.remove('hidden');
        if (mobileBadge) mobileBadge.classList.remove('hidden');
        if (desktopCount) desktopCount.textContent = String(announcedForBadge);
        if (mobileCount) mobileCount.textContent = String(announcedForBadge);
        // Persistir para otras vistas
        try { localStorage.setItem('packages_announced_last', String(announcedForBadge)); } catch (_e) {}
    } else {
        if (desktopBadge) desktopBadge.classList.add('hidden');
        if (mobileBadge) mobileBadge.classList.add('hidden');
    }
}

function createPackageCard(package, state) {
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200';

    // Agregar atributo data-search para filtrado local
    const searchData = [
        package.tracking_number || '',
        package.customer_name || '',
        package.customer_phone || '',
        package.status || '',
        package.guide_number || '',
        // ACCESS CODE HIDDEN - No longer including access code in search
        // package.access_code || '',
        package.baroti || '',
        package.package_type || '',
        package.package_condition || '',
        // OBSERVATIONS HIDDEN - No longer including observations in search
        // package.observations || '',
        package.id || ''
    ].join(' ').toLowerCase();

    card.setAttribute('data-search', searchData);
    card.setAttribute('data-status', package.status || '');

    const statusColor = getStatusColor(package.status);
    const statusText = getStatusText(package.status);

    // Determinar acciones disponibles seg煤n el estado
    const actions = getAvailableActions(package);

    // Formatear informaci贸n del paquete
    const guideInfo = package.guide_number ? `<div class="text-xs text-gray-500">Gu铆a: ${package.guide_number}</div>` : '';
    const barotiInfo = package.baroti ? `<div class="text-xs text-gray-500">Posici贸n: ${package.baroti}</div>` : '';
    const typeInfo = package.package_type ? `<div class="text-xs text-gray-500">Tipo: ${package.package_type}</div>` : '';

    card.innerHTML = `
        <div class="flex items-start justify-between mb-3">
            <div class="flex-1 min-w-0">
                <div class="flex items-center space-x-2 mb-1">
                    <h4 class="text-sm font-semibold text-gray-900 truncate">${package.tracking_number}</h4>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusColor} flex-shrink-0">
                        ${statusText}
                    </span>
                </div>
                <div class="text-sm text-gray-700 truncate">${package.customer_name || 'Sin nombre'}</div>
                <div class="text-xs text-gray-500 mt-1">
                    ${formatPhoneLinks(package.customer_phone, package.customer_name)}
                </div>
            </div>
        </div>

        <div class="space-y-1 mb-3">
            ${guideInfo}
            ${barotiInfo}
            ${typeInfo}
            <div class="text-xs text-gray-500">
                ${formatDate(package.announced_at)}
            </div>
        </div>

        <!-- OBSERVATIONS HIDDEN - No longer displaying observations in cards -->
        <!-- ${package.observations ? `<div class="text-xs text-gray-600 bg-gray-50 rounded p-2 mb-3 line-clamp-2">${package.observations}</div>` : ''} -->

        <div class="flex justify-end space-x-2">
            ${actions.map(action => `
                <button onclick="${action.type === 'receive' ? `window.location.href='/receive?id=${package.id}'` : `openPackageAction('${package.id}', '${action.type}')`}"
                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md ${action.color} hover:opacity-80 transition-colors duration-200">
                    ${action.icon}
                    ${action.label}
                </button>
            `).join('')}
        </div>
    `;

    return card;
}

function createPackageElement(package) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 transition-colors duration-200';

    // Agregar atributo data-search para filtrado local - incluir todos los campos disponibles
    const searchData = [
        package.tracking_number || '',
        package.customer_name || '',
        package.customer_phone || '',
        package.status || '',
        package.guide_number || '',
        // ACCESS CODE HIDDEN - No longer including access code in search
        // package.access_code || '',
        package.baroti || '',
        package.package_type || '',
        package.package_condition || '',
        // OBSERVATIONS HIDDEN - No longer including observations in search
        // package.observations || '',
        package.id || ''
    ].join(' ').toLowerCase();

    row.setAttribute('data-search', searchData);
    row.setAttribute('data-status', package.status || '');

    const statusColor = getStatusColor(package.status);
    const statusText = getStatusText(package.status);
    const statusIcon = getStatusIcon(package.status);

    // Determinar acciones disponibles seg煤n el estado y tipo
    const actions = getAvailableActions(package);

    row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold border ${statusColor} shadow-sm">
                ${statusIcon}
                <span class="ml-2">${statusText}</span>
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">
                ${package.guide_number ? `
                    <a href="/search?auto_search=${encodeURIComponent(package.guide_number)}"
                       class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200">
                        ${package.guide_number}
                    </a>
                ` : '<span class="text-gray-400">Sin gu铆a</span>'}
                ${package.guide_number && package.tracking_number ? ' <span class="text-gray-400">/</span> ' : ''}
                ${package.tracking_number ? `
                    <a href="/search?auto_search=${encodeURIComponent(package.tracking_number)}"
                       class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200 font-semibold">
                        ${package.tracking_number}
                    </a>
                ` : package.guide_number ? '<span class="text-gray-400">Sin c贸digo</span>' : ''}
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center space-x-2">
                <div class="text-sm text-gray-900">${package.customer_name || 'Sin nombre'}</div>
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex flex-col space-y-2">
                <!-- N煤mero de tel茅fono -->
                ${package.customer_phone ? `
                    <a href="tel:+57${package.customer_phone.replace(/[\s\-\(\)]/g, '').replace(/^\+57/, '')}" 
                       class="text-sm font-medium text-gray-900 hover:text-blue-600 hover:underline transition-colors">
                        ${package.customer_phone}
                    </a>
                ` : '<div class="text-sm font-medium text-gray-400">Sin tel茅fono</div>'}
                <!-- Iconos de contacto -->
                <div class="flex items-center space-x-3">
                    ${package.customer_email ? `
                        <a href="mailto:${package.customer_email}" 
                           class="text-blue-600 hover:text-blue-800 transition-colors"
                           title="Enviar email a ${package.customer_email}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </a>
                    ` : ''}
                    ${package.customer_phone ? `
                        <a href="https://wa.me/57${package.customer_phone.replace(/[\s\-\(\)]/g, '').replace(/^\+57/, '')}?text=${encodeURIComponent(`Hola ${package.customer_name || 'cliente'}, te contacto por tu paquete`)}" 
                           target="_blank"
                           class="text-green-600 hover:text-green-800 transition-colors"
                           title="Contactar por WhatsApp">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                            </svg>
                        </a>
                    ` : ''}
                    ${package.customer_phone ? `
                        <a href="tel:+57${package.customer_phone.replace(/[\s\-\(\)]/g, '').replace(/^\+57/, '')}" 
                           class="text-blue-600 hover:text-blue-800 transition-colors"
                           title="Llamar a ${package.customer_phone}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                        </a>
                    ` : ''}
                </div>
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex flex-col space-y-1">
                ${package.announced_at ? (() => {
                    const date = new Date(package.announced_at);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    let hours = date.getHours();
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12;
                    const timeStr = hours.toString().padStart(2, '0') + ':' + minutes + ' ' + ampm;
                    return `
                        <div class="text-sm font-medium text-gray-900">${day}/${month}/${year}</div>
                        <div class="text-xs text-gray-500">${timeStr}</div>
                    `;
                })() : '<div class="text-sm text-gray-400">N/A</div>'}
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="grid grid-flow-col auto-cols-max gap-2 justify-end">
                ${actions.map(action => `
                    <button ${action.disabled ? 'disabled' : `onclick=\"openPackageAction('${package.id}', '${action.type}')\"`}
                            title="${action.title}${action.disabled ? ' (No disponible)' : ''}"
                            class="inline-flex items-center justify-center w-9 h-9 md:w-9 md:h-9 border border-transparent text-xs font-medium rounded-md ${action.color} ${action.disabled ? '' : 'hover:opacity-80'} transition-colors duration-200 ${action.disabled ? 'opacity-50' : ''}">
                        ${action.icon}
                    </button>
                `).join('')}
            </div>
        </td>
    `;

    return row;
}

function getAvailableActions(package) {
    const actions = [];
    const status = package.status?.toLowerCase();

    // Verificadores de estado (soporte para ingl茅s y espa帽ol)
    const isAnnounced = status === 'announced' || status === 'anunciado';
    const isReceived = status === 'received' || status === 'recibido';
    const isDelivered = status === 'delivered' || status === 'entregado';
    const isCancelled = status === 'cancelled' || status === 'cancelado';

    console.log(' Estado del paquete:', status, '| isReceived:', isReceived, '| isAnnounced:', isAnnounced);

    // Visualizar: always available for all packages
    actions.push({
        type: 'visualizar',
        label: '',
        color: 'text-white bg-gray-600 hover:bg-gray-700',
        icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>',
        title: 'Visualizar',
        disabled: false
    });

    // Recibir: only for announced packages
    actions.push({
        type: 'receive',
        label: '',
        color: isAnnounced ? 'text-white bg-blue-600 hover:bg-blue-700' : 'text-gray-400 bg-gray-200 cursor-not-allowed',
        icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
        title: 'Recibir',
        disabled: !isAnnounced
    });

    // Entregar: only for received packages
    actions.push({
        type: 'deliver',
        label: '',
        color: isReceived ? 'text-white bg-green-600 hover:bg-green-700' : 'text-gray-400 bg-gray-200 cursor-not-allowed',
        icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>',
        title: 'Entregar',
        disabled: !isReceived
    });

    // Cancelar: siempre mostrar el bot贸n para ADMIN, deshabilitado si no aplica
    if (userRole === 'ADMIN') {
        const cancelEnabled = (isAnnounced || isReceived);
        actions.push({
            type: 'cancel',
            label: '',
            color: cancelEnabled ? 'text-white bg-red-600 hover:bg-red-700' : 'text-gray-400 bg-gray-200 cursor-not-allowed',
            icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
            title: cancelEnabled ? 'Cancelar' : 'No disponible para este estado',
            disabled: !cancelEnabled
        });
    }

    return actions;
}

function openPackageAction(packageId, action) {
    event.stopPropagation(); // Prevent triggering the card click

    console.log(' Abriendo acci贸n del paquete:', packageId, action);

    currentPackageId = packageId;
    currentAction = action;

    // Find the package data from the already loaded packages
    let packageData = null;

    // Search in all state arrays
    for (const state of ['announced', 'received', 'delivered', 'cancelled']) {
        const packages = packagesByState[state];
        // Comparar tanto strings como n煤meros, y tambi茅n IDs de announcements
        packageData = packages.find(p => {
            // Convertir ambos a string para comparaci贸n consistente
            const pId = String(p.id);
            const searchId = String(packageId);
            
            // Comparar directamente o con prefijo announcement_
            return pId === searchId || 
                   `announcement_${pId}` === searchId ||
                   pId === `announcement_${searchId}` ||
                   // Tambi茅n buscar por tracking_number como fallback
                   (p.tracking_number && String(p.tracking_number) === searchId);
        });
        
        if (packageData) {
            console.log(' Datos del paquete encontrados en estado:', state);
            console.log('   ID buscado:', packageId);
            console.log('   ID encontrado:', packageData.id);
            break;
        }
    }

    if (!packageData) {
        console.error(' Paquete no encontrado en datos cargados');
        console.error('   ID buscado:', packageId);
        console.error('   IDs disponibles:', {
            announced: packagesByState.announced.map(p => p.id),
            received: packagesByState.received.map(p => p.id),
            delivered: packagesByState.delivered.map(p => p.id),
            cancelled: packagesByState.cancelled.map(p => p.id)
        });
        showErrorToast('Error', 'No se encontraron los datos del paquete. Por favor, recarga la p谩gina.', 5000);
        return;
    }

    // For announcements, mark as announcement
    if (String(packageId).startsWith('announcement_')) {
        packageData.is_announcement = true;
    }

    console.log(' Usando datos del paquete:', packageData);
    showPackageModal(packageData, action);
}

function showPackageModal(package, action) {
    console.log(' Mostrando modal para paquete:', package, 'acci贸n:', action);

    // Almacenar el paquete actual en variable global
    currentPackage = package;

    const modal = document.getElementById('packageModal');
    if (!modal) {
        console.error(' Modal no encontrado');
        alert('Error: Modal no encontrado');
        return;
    }

    const modalTitle = document.getElementById('modalTitle');
    const packageDetail = document.getElementById('packageDetail');
    const actionTitle = document.getElementById('actionTitle');
    const actionMessage = document.getElementById('actionMessage');
    const receiveForm = document.getElementById('receiveForm');
    const deliverForm = document.getElementById('deliverForm');
    const genericForm = document.getElementById('genericForm');

    console.log(' Elementos del modal encontrados:', {
        modal: !!modal,
        modalTitle: !!modalTitle,
        receiveForm: !!receiveForm,
        deliverForm: !!deliverForm,
        genericForm: !!genericForm
    });

    // Reset forms
    receiveForm.classList.add('hidden');
    deliverForm.classList.add('hidden');
    genericForm.classList.add('hidden');

    // Set modal title and show appropriate form based on action
    const confirmButtonText = document.getElementById('confirmButtonText');
    
    switch(action) {
        case 'visualizar':
            modalTitle.textContent = 'Detalles del Paquete';
            actionTitle.textContent = '';
            genericForm.classList.remove('hidden');
            confirmButtonText.textContent = 'Cerrar';
            
            // Mostrar informaci贸n completa del paquete
            displayPackageDetails(package);
            // Cargar informaci贸n de pago din谩micamente
            loadDynamicPaymentInfo(package);
            // Soluci贸n temporal: Mostrar tarifas correctas inmediatamente
            setTimeout(() => showCorrectFees(package), 100);
            break;
        case 'receive':
            modalTitle.textContent = 'Recibir Paquete';
            actionTitle.textContent = 'Confirmar Recepci贸n';
            receiveForm.classList.remove('hidden');
            confirmButtonText.textContent = 'Recibir Paquete';

            // Reset receive form
            document.getElementById('packageType').value = 'normal';
            document.getElementById('packageCondition').value = 'ok';
            // OBSERVATIONS DISABLED - No longer resetting observations
            // const observationsElement = document.getElementById('receiveObservations');
            // if (observationsElement) observationsElement.value = '';
            resetImageUpload();
            
            // Cargar informaci贸n del paquete en la nueva secci贸n
            displayReceivePackageInfo(package);
            
            // Agregar event listener para actualizar tarifa base seg煤n tipo de paquete
            setupPackageTypeFeeListener();
            
            // Configurar listener del bot贸n de im谩genes cuando el modal se muestre
            setTimeout(() => {
                const selectImagesBtn = document.getElementById('selectImagesBtn');
                if (selectImagesBtn) {
                    console.log(' Bot贸n selectImagesBtn encontrado, configurando listener directo...');
                    
                    // Remover listener anterior si existe
                    const newBtn = selectImagesBtn.cloneNode(true);
                    selectImagesBtn.parentNode.replaceChild(newBtn, selectImagesBtn);
                    
                    // Agregar listener directo con detecci贸n de dispositivo
                    newBtn.addEventListener('click', function(e) {
                        console.log(' ===== CLICK DIRECTO EN BOTN =====');
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Verificar l铆mite
                        if (selectedImages.length >= 3) {
                            showInfoToast('L铆mite alcanzado', 'Ya tienes el m谩ximo de 3 im谩genes seleccionadas.', 3000);
                            return;
                        }
                        
                        // Buscar input
                        const packageImagesInput = document.getElementById('packageImages');
                        if (packageImagesInput) {
                            // Detectar si es dispositivo m贸vil
                            if (isMobileDevice()) {
                                console.log(' Dispositivo m贸vil detectado - mostrando opciones');
                                showMobileCaptureOptions();
                            } else {
                                console.log(' Escritorio detectado - abriendo selector');
                                packageImagesInput.removeAttribute('capture');
                                packageImagesInput.setAttribute('accept', 'image/jpeg,image/jpg,image/png,image/webp');
                                packageImagesInput.click();
                            }
                        } else {
                            console.error(' Input no encontrado');
                        }
                    });
                    
                    console.log(' Listener directo agregado al bot贸n');
                } else {
                    console.warn('锔 Bot贸n selectImagesBtn no encontrado');
                }
            }, 100);
            break;
        case 'deliver':
            console.log(' Configurando modal de entrega para paquete:', package);
            modalTitle.textContent = 'Entregar Paquete';
            actionTitle.textContent = 'Confirmar Entrega';
            deliverForm.classList.remove('hidden');
            confirmButtonText.textContent = 'Entregar Paquete';

            // Load payment summary
            loadPaymentSummary(package);

            // Reset deliver form
            const paymentAmountField = document.getElementById('paymentAmount');
            if (paymentAmountField) {
                paymentAmountField.value = package.total_amount || '';
                console.log(' Campo paymentAmount encontrado y configurado');
            } else {
                console.error(' Campo paymentAmount no encontrado');
            }
            // OBSERVATIONS DISABLED - No longer resetting observations
            // document.getElementById('deliverObservations').value = '';
            
            // Mostrar bot贸n de email si el cliente tiene email
            checkAndShowEmailButton(package, 'delivered');
            break;
        case 'cancel':
            modalTitle.textContent = 'Cancelar Paquete';
            actionTitle.textContent = 'Confirmar Cancelaci贸n';
            genericForm.classList.remove('hidden');
            actionMessage.textContent = `驴Est谩s seguro de que deseas cancelar el paquete ${package.tracking_number}? Esta acci贸n no se puede deshacer.`;
            confirmButtonText.textContent = 'Cancelar Paquete';
            
            // Mostrar bot贸n de email si el cliente tiene email
            checkAndShowEmailButton(package, 'cancelled');
            break;
        case 'delete':
            modalTitle.textContent = 'Eliminar Paquete';
            actionTitle.textContent = 'Confirmar Eliminaci贸n';
            genericForm.classList.remove('hidden');
            actionMessage.textContent = `驴Est谩s seguro de que deseas ELIMINAR PERMANENTEMENTE el paquete ${package.tracking_number}? Esta acci贸n eliminar谩 todos los datos relacionados y NO SE PUEDE DESHACER. Solo los administradores pueden realizar esta acci贸n.`;
            confirmButtonText.textContent = 'Eliminar Paquete';
            break;
    }

    // Mostrar detalles del paquete si es acci贸n de visualizar
    if (action === 'visualizar') {
        displayPackageDetails(package);
        // Mostrar el contenedor de detalles
        packageDetail.style.display = 'block';
    } else {
        // Para acciones simples (cancel, delete), ocultar completamente el 谩rea de detalles
        packageDetail.style.display = 'none';
        packageDetail.innerHTML = '';
    }

    modal.classList.remove('hidden');
}

function normalizePackageType(packageType) {
    // Normalizar siempre a los DOS valores que entiende el backend:
    //  - "NORMAL"
    //  - "EXTRA_DIMENSIONADO" (valor del Enum PackageType)
    if (!packageType) return 'NORMAL';

    const normalized = packageType.toString().toLowerCase();

    // Cualquier variante que contenga "extra" se considera extra dimensionado
    if (normalized.includes('extra') || normalized.includes('dimension')) {
        // Valor oficial del Enum en backend
        return 'EXTRA_DIMENSIONADO';
    }

    return 'NORMAL';
}

async function loadPaymentSummary(package) {
    const paymentSummary = document.getElementById('paymentSummary');
    const datesSummary = document.getElementById('datesSummary');
    const paymentAmountInput = document.getElementById('paymentAmount');
    const suggestedAmountText = document.getElementById('suggestedAmountText');
    
    // Debug: Mostrar informaci贸n del paquete
    console.log(' Paquete recibido en loadPaymentSummary:', package);
    console.log(' Tipo original:', package.package_type);
    console.log(' Tipo normalizado:', normalizePackageType(package.package_type));
    
    // Calcular tarifa din谩micamente desde CODE/LOCAL/.env
    try {
        const response = await fetch('/api/packages/calculate-dynamic-fee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                // Enviar el valor EXACTO que espera el Enum del backend
                package_type: normalizePackageType(package.package_type),
                storage_days: package.storage_days || 0
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log(' Respuesta del backend:', data);
            const calculation = data.calculation;
            console.log('М C谩lculo recibido:', calculation);
            
            // Actualizar resumen de pago
            paymentSummary.innerHTML = `
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span>Tarifa base:</span>
                        <span>$${calculation.base_fee.toFixed(2)}</span>
                    </div>
                    ${calculation.storage_fee > 0 ? `
                    <div class="flex justify-between">
                        <span>Almacenamiento (${calculation.storage_days} d铆as):</span>
                        <span>$${calculation.storage_fee.toFixed(2)}</span>
                    </div>
                    ` : ''}
                    <div class="border-t border-blue-300 pt-1 mt-2">
                        <div class="flex justify-between font-semibold">
                            <span>Total sugerido:</span>
                            <span>$${calculation.total_fee.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar fechas importantes
            loadDatesSummary(package);
            
            // Pre-cargar monto calculado
            paymentAmountInput.value = calculation.total_fee.toFixed(2);
            suggestedAmountText.textContent = `Valor calculado: $${calculation.total_fee.toFixed(2)}`;
            
        } else {
            // Fallback a valores de la base de datos
            loadPaymentSummaryFallback(package);
        }
    } catch (error) {
        console.error('Error calculando tarifa din谩mica:', error);
        // Fallback a valores de la base de datos
        loadPaymentSummaryFallback(package);
    }
}

function loadPaymentSummaryFallback(package) {
    const paymentSummary = document.getElementById('paymentSummary');
    const datesSummary = document.getElementById('datesSummary');
    const paymentAmountInput = document.getElementById('paymentAmount');
    const suggestedAmountText = document.getElementById('suggestedAmountText');
    
    const totalAmount = package.total_amount || 0;
    const baseFee = package.base_fee || 0;
    const storageFee = package.storage_fee || 0;
    const storageDays = package.storage_days || 0;

    // Actualizar resumen de pago
    paymentSummary.innerHTML = `
        <div class="space-y-1">
            <div class="flex justify-between">
                <span>Entrega base:</span>
                <span>$${baseFee.toFixed(2)}</span>
            </div>
            ${storageFee > 0 ? `
            <div class="flex justify-between">
                <span>Almacenamiento (${storageDays} d铆as):</span>
                <span>$${storageFee.toFixed(2)}</span>
            </div>
            ` : ''}
            <div class="border-t border-blue-300 pt-1 mt-2">
                <div class="flex justify-between font-semibold">
                    <span>Total sugerido:</span>
                    <span>$${totalAmount.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
    
    // Cargar fechas importantes
    loadDatesSummary(package);
    
    // Pre-cargar monto calculado
    paymentAmountInput.value = totalAmount.toFixed(2);
    suggestedAmountText.textContent = `Valor calculado: $${totalAmount.toFixed(2)}`;
}

function loadDatesSummary(package) {
    const datesSummary = document.getElementById('datesSummary');
    
    // Obtener fechas del paquete
    const announcedAt = package.announced_at ? new Date(package.announced_at) : null;
    const receivedAt = package.received_at ? new Date(package.received_at) : null;
    const currentTime = new Date();
    
    // Formatear fechas
    const formatDate = (date) => {
        if (!date) return 'No disponible';
        return date.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    };
    
    // Calcular tiempo de almacenamiento
    let storageTimeText = 'No calculable';
    if (receivedAt) {
        const timeDiff = currentTime - receivedAt;
        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        if (days > 0) {
            storageTimeText = `${days} d铆a${days > 1 ? 's' : ''} y ${hours} hora${hours > 1 ? 's' : ''}`;
        } else if (hours > 0) {
            storageTimeText = `${hours} hora${hours > 1 ? 's' : ''}`;
        } else {
            storageTimeText = 'Menos de 1 hora';
        }
    }
    
    // Crear HTML de fechas importantes
    datesSummary.innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Anunciado:</span>
                <span class="text-sm font-medium">${formatDate(announcedAt)}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Recibido:</span>
                <span class="text-sm font-medium">${formatDate(receivedAt)}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Entrega:</span>
                <span class="text-sm font-medium">${formatDate(currentTime)}</span>
            </div>
            <div class="border-t border-green-300 pt-2 mt-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-green-800">Tiempo en almac茅n:</span>
                    <span class="text-sm font-bold text-green-900 bg-green-100 px-2 py-1 rounded">${storageTimeText}</span>
                </div>
            </div>
        </div>
    `;
}

async function loadDynamicPaymentInfo(package) {
    const paymentInfo = document.getElementById('dynamicPaymentInfo');
    
    console.log(' Iniciando c谩lculo din谩mico para paquete:', package);
    
    // Calcular tarifa din谩micamente desde CODE/LOCAL/.env
    try {
        const requestData = {
            package_type: normalizePackageType(package.package_type),
            storage_days: package.storage_days || 0
        };
        
        console.log(' Enviando petici贸n:', requestData);
        
        const response = await fetch('/api/packages/calculate-dynamic-fee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                package_type: requestData.package_type.toUpperCase(),
                storage_days: requestData.storage_days
            })
        });
        
        console.log(' Respuesta recibida:', response.status, response.statusText);
        
        if (response.ok) {
            const data = await response.json();
            console.log(' Datos de c谩lculo:', data);
            
            const calculation = data.calculation;
            
            paymentInfo.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center py-2 border-b border-green-200">
                        <span class="text-green-700 font-medium">TARIFA BASE:</span>
                        <span class="text-gray-700 font-mono">$${calculation.base_fee.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-green-200">
                        <span class="text-green-700 font-medium">BODEGAJE <span class="font-bold text-lg">${calculation.storage_days || 0}</span> DIAS:</span>
                        <span class="text-gray-700 font-mono">$${calculation.storage_fee.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center py-3 bg-green-100 rounded-lg px-3">
                        <span class="text-green-800 font-bold text-lg">TOTAL:</span>
                        <span class="text-green-800 font-bold text-xl font-mono">$${calculation.total_fee.toFixed(2)}</span>
                    </div>
                </div>
            `;
        } else {
            console.error(' Error en respuesta:', response.status, response.statusText);
            const errorText = await response.text();
            console.error(' Detalles del error:', errorText);
            // Fallback a valores de la base de datos
            loadDynamicPaymentInfoFallback(package);
        }
    } catch (error) {
        console.error(' Error calculando tarifa din谩mica:', error);
        // Fallback a valores de la base de datos
        loadDynamicPaymentInfoFallback(package);
    }
}

function loadDynamicPaymentInfoFallback(package) {
    const paymentInfo = document.getElementById('dynamicPaymentInfo');
    const totalAmount = package.total_amount || 0;
    const baseFee = package.base_fee || 0;
    const storageFee = package.storage_fee || 0;
    const storageDays = package.storage_days || 0;

    paymentInfo.innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between items-center py-2 border-b border-green-200">
                <span class="text-green-700 font-medium">TARIFA BASE:</span>
                <span class="text-gray-700 font-mono">$${baseFee.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-green-200">
                <span class="text-green-700 font-medium">BODEGAJE <span class="font-bold text-lg">${storageDays}</span> DIAS:</span>
                <span class="text-gray-700 font-mono">$${storageFee.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-green-100 rounded-lg px-3">
                <span class="text-green-800 font-bold text-lg">TOTAL:</span>
                <span class="text-green-800 font-bold text-xl font-mono">$${totalAmount.toFixed(2)}</span>
            </div>
            <div class="text-xs text-gray-500 mt-2 text-center">
                锔 Valores de base de datos (fallback)
            </div>
        </div>
    `;
}

function displayReceivePackageInfo(package) {
    const receivePackageInfo = document.getElementById('receivePackageInfo');
    
    // Formatear fechas
    const formatDate = (dateString) => {
        if (!dateString) return 'N/D';
        const date = new Date(dateString);
        return date.toLocaleString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    // Construir HTML de informaci贸n del paquete para recepci贸n
    receivePackageInfo.innerHTML = `
        <div class="flex items-center space-x-2">
            <span class="text-blue-600 font-medium">CDIGO DE CONSULTA:</span>
            <a href="${window.appConfig?.development_url || 'http://localhost:8000'}/search?auto_search=${package.tracking_number || ''}" 
               class="text-blue-600 hover:text-blue-800 underline font-mono bg-gray-100 px-2 py-1 rounded hover:bg-gray-200 transition-colors duration-200" 
               target="_blank">
               ${package.tracking_number || 'N/D'}
            </a>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-blue-600 font-medium">NMERO DE GUA:</span>
            <a href="${window.appConfig?.development_url || 'http://localhost:8000'}/search?auto_search=${package.guide_number || ''}" 
               class="text-blue-600 hover:text-blue-800 underline font-mono bg-gray-100 px-2 py-1 rounded hover:bg-gray-200 transition-colors duration-200" 
               target="_blank">
               ${package.guide_number || 'N/D'}
            </a>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-blue-600 font-medium">CLIENTE:</span>
            <span class="text-gray-700 font-medium">${package.customer_name || 'N/D'}</span>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-blue-600 font-medium">TELFONO:</span>
            <a href="https://wa.me/57${package.customer_phone?.replace(/\D/g, '') || ''}?text=Hola%20${encodeURIComponent(package.customer_name || 'CLIENTE')}%2C%20te%20contacto%20por%20tu%20paquete" 
               class="text-green-600 hover:text-green-800 underline font-medium" 
               target="_blank">
               ${package.customer_phone || 'N/D'}
            </a>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-blue-600 font-medium">ANUNCIADO:</span>
            <span class="text-gray-700">${formatDate(package.announced_at)}</span>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-blue-600 font-medium">ESTADO ACTUAL:</span>
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800 border border-blue-200">
                ANUNCIADO - ESPERANDO RECEPCIN
            </span>
        </div>
    `;
}

function displayPackageDetails(package) {
    const packageDetail = document.getElementById('packageDetail');
    const actionMessage = document.getElementById('actionMessage');
    
    // Formatear fechas
    const formatDate = (dateString) => {
        if (!dateString) return 'N/D';
        const date = new Date(dateString);
        return date.toLocaleString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    // Formatear estado
    const formatStatus = (status) => {
        const statusMap = {
            'ANUNCIADO': 'ANUNCIADO',
            'announced': 'ANUNCIADO',
            'RECIBIDO': 'RECIBIDO',
            'received': 'RECIBIDO',
            'ENTREGADO': 'ENTREGADO',
            'delivered': 'ENTREGADO',
            'CANCELADO': 'CANCELADO',
            'cancelled': 'CANCELADO'
        };
        return statusMap[status] || status.toUpperCase();
    };

    // Formatear tipo de paquete
    const formatPackageType = (type) => {
        const typeMap = {
            'MEDIA': 'MEDIA',
            'normal': 'MEDIA',
            'EXTRA_DIMENSIONED': 'EXTRA DIMENSIONADO',
            'extra_dimensioned': 'EXTRA DIMENSIONADO',
            'extra dimensioned': 'EXTRA DIMENSIONADO'
        };
        return typeMap[type] || type.toUpperCase();
    };

    // Formatear condici贸n
    const formatCondition = (condition) => {
        const conditionMap = {
            'BUENO': 'BUENO',
            'ok': 'BUENO',
            'OPENED': 'ABIERTO',
            'opened': 'ABIERTO',
            'REGULAR': 'REGULAR',
            'regular': 'REGULAR'
        };
        return conditionMap[condition] || condition.toUpperCase();
    };

    // Obtener informaci贸n del cliente o estado del paquete
    const customerInfo = package.customer ? `
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl mb-4 border border-blue-100">
            <div class="flex items-center mb-3">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h4 class="font-bold text-blue-800 text-lg">INFORMACIN DEL CLIENTE</h4>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="flex items-center space-x-2">
                    <span class="text-blue-600 font-medium">NOMBRE:</span>
                    <span class="text-gray-700">${package.customer.first_name || ''} ${package.customer.last_name || ''}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-600 font-medium">TELFONO:</span>
                    <span class="text-gray-700">${package.customer.phone || 'N/D'}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-600 font-medium">EMAIL:</span>
                    <span class="text-gray-700">${package.customer.email || 'N/D'}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-600 font-medium">TORRE:</span>
                    <span class="text-gray-700">${package.customer.tower || 'N/D'}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-600 font-medium">APARTAMENTO:</span>
                    <span class="text-gray-700">${package.customer.apartment || 'N/D'}</span>
                </div>
                <div class="flex items-center space-x-2 md:col-span-2">
                    <span class="text-blue-600 font-medium">DIRECCIN:</span>
                    <span class="text-gray-700">${package.customer.address || 'N/D'}</span>
                </div>
            </div>
        </div>
    ` : `
        <div class="bg-gradient-to-r from-gray-50 to-slate-50 p-4 rounded-xl mb-4 border border-gray-200">
            <div class="flex items-center mb-3">
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                </div>
                <h4 class="font-bold text-gray-800 text-lg">ESTADO DEL PAQUETE</h4>
            </div>
            <div class="flex items-center space-x-3">
                <span class="px-4 py-2 rounded-full text-sm font-bold ${
                    package.status === 'ANUNCIADO' || package.status === 'announced' ? 'bg-blue-100 text-blue-800 border border-blue-200' :
                    package.status === 'RECIBIDO' || package.status === 'received' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                    package.status === 'ENTREGADO' || package.status === 'delivered' ? 'bg-green-100 text-green-800 border border-green-200' :
                    package.status === 'CANCELADO' || package.status === 'cancelled' ? 'bg-red-100 text-red-800 border border-red-200' :
                    'bg-gray-100 text-gray-800 border border-gray-200'
                }">
                    ${formatStatus(package.status)}
                </span>
                <span class="text-sm text-gray-600 font-medium">
                    ${package.status === 'ANUNCIADO' || package.status === 'announced' ? 'PAQUETE ANUNCIADO, ESPERANDO A DOMICILIARIO' :
                      package.status === 'RECIBIDO' || package.status === 'received' ? 'PAQUETE RECIBIDO EN PAPYRUS' :
                      package.status === 'ENTREGADO' || package.status === 'delivered' ? 'PAQUETE ENTREGADO AL CLIENTE EXITOSAMENTE' :
                      package.status === 'CANCELADO' || package.status === 'cancelled' ? 'PAQUETE CANCELADO' :
                      'ESTADO DESCONOCIDO'}
                </span>
            </div>
        </div>
    `;

    // Construir HTML de detalles mejorado
    packageDetail.innerHTML = `
        <div class="space-y-4">
            ${customerInfo}
            
            <!-- Informaci贸n del Paquete -->
            <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-100">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <h4 class="font-bold text-orange-800 text-lg">INFORMACIN DEL PAQUETE</h4>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">CDIGO DE CONSULTA:</span>
                        <a href="${window.appConfig?.development_url || 'http://localhost:8000'}/search?auto_search=${package.tracking_number || ''}" 
                           class="text-blue-600 hover:text-blue-800 underline font-mono bg-gray-100 px-2 py-1 rounded hover:bg-gray-200 transition-colors duration-200" 
                           target="_blank">
                           ${package.tracking_number || 'N/D'}
                        </a>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">NMERO DE GUA:</span>
                        <a href="${window.appConfig?.development_url || 'http://localhost:8000'}/search?auto_search=${package.guide_number || ''}" 
                           class="text-blue-600 hover:text-blue-800 underline font-mono bg-gray-100 px-2 py-1 rounded hover:bg-gray-200 transition-colors duration-200" 
                           target="_blank">
                           ${package.guide_number || 'N/D'}
                        </a>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">CLIENTE:</span>
                        <span class="text-gray-700">${package.customer_name || 'N/D'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">TELFONO:</span>
                        <a href="https://wa.me/57${package.customer_phone?.replace(/\D/g, '') || ''}?text=Hola%20${encodeURIComponent(package.customer_name || 'CLIENTE')}%2C%20te%20contacto%20por%20tu%20paquete" 
                           class="text-green-600 hover:text-green-800 underline font-medium" 
                           target="_blank">
                           ${package.customer_phone || 'N/D'}
                        </a>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">EMAIL:</span>
                        ${package.customer_email ? `
                            <a href="mailto:${package.customer_email}" 
                               class="text-blue-600 hover:text-blue-800 underline font-medium" 
                               title="Enviar email a ${package.customer_email}">
                                ${package.customer_email}
                            </a>
                        ` : '<span class="text-gray-700">N/D</span>'}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">POSICIN:</span>
                        <span class="text-gray-700">${package.baroti || 'N/D'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">TIPO:</span>
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                            package.package_type === 'MEDIA' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                        }">${formatPackageType(package.package_type)}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-orange-600 font-medium">CONDICIN:</span>
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                            package.package_condition === 'BUENO' ? 'bg-green-100 text-green-800' :
                            package.package_condition === 'OPENED' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">${formatCondition(package.package_condition)}</span>
                    </div>
                </div>
            </div>

            <!-- Informaci贸n de Pago -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <h4 class="font-bold text-green-800 text-lg">INFORMACIN DE PAGO</h4>
                </div>
                <div id="dynamicPaymentInfo" class="space-y-2">
                    <!-- Se cargar谩 din谩micamente -->
                    <div class="flex justify-center items-center py-4">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                        <span class="ml-2 text-green-600">Calculando tarifas...</span>
                    </div>
                </div>
                
            </div>

            <!-- Fechas Importantes -->
            <div class="bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-100">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h4 class="font-bold text-purple-800 text-lg">FECHAS IMPORTANTES</h4>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <span class="text-purple-600 font-medium">ANUNCIADO:</span>
                        <span class="text-gray-700">${formatDate(package.announced_at)}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-purple-600 font-medium">RECIBIDO:</span>
                        <span class="text-gray-700">${formatDate(package.received_at)}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-purple-600 font-medium">ENTREGADO:</span>
                        <span class="text-gray-700">${formatDate(package.delivered_at)}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-purple-600 font-medium">CANCELADO:</span>
                        <span class="text-gray-700">${formatDate(package.cancelled_at)}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-purple-600 font-medium">ACTUALIZADO:</span>
                        <span class="text-gray-700">${formatDate(package.updated_at)}</span>
                    </div>
                </div>
            </div>

            <!-- Observaciones si existen -->
            ${package.observations ? `
                <div class="bg-gradient-to-r from-yellow-50 to-amber-50 p-4 rounded-xl border border-yellow-100">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </div>
                        <h4 class="font-bold text-yellow-800 text-lg">OBSERVACIONES</h4>
                    </div>
                    <p class="text-gray-700 text-sm leading-relaxed">${package.observations}</p>
                </div>
            ` : ''}

            ${package.messages && package.messages.length > 0 ? `
            <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-100">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h4 class="font-bold text-orange-800 text-lg">MENSAJES (${package.messages.length})</h4>
                </div>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${package.messages.map(msg => `
                        <div class="text-xs bg-white p-3 rounded-lg border-l-4 border-orange-300 shadow-sm">
                            <div class="font-medium text-gray-800">${msg.subject || 'SIN ASUNTO'}</div>
                            <div class="text-gray-600 mt-1">${msg.content || 'SIN CONTENIDO'}</div>
                            <div class="text-gray-500 text-xs mt-2">${formatDate(msg.created_at)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}


        </div>
    `;

    // Ocultar el mensaje de acci贸n para visualizar
    actionMessage.style.display = 'none';
}

function confirmAction() {
    console.log(' confirmAction called');
    console.log(' Current package ID:', currentPackageId);
    console.log(' Current action:', currentAction);
    
    if (!currentPackageId || !currentAction) {
        console.log(' Missing package ID or action');
        return;
    }

    // Handle specific actions
    if (currentAction === 'receive') {
        console.log(' Calling confirmReceiveAction');
        return confirmReceiveAction();
    } else if (currentAction === 'deliver') {
        console.log(' Calling confirmDeliverAction');
        return confirmDeliverAction();
    } else if (currentAction === 'delete') {
        console.log('锔 Calling confirmDeleteAction');
        return confirmDeleteAction();
    } else if (currentAction === 'visualizar') {
        console.log('锔 Closing modal for visualizar');
        // For visualizar, just close the modal
        closeModal();
        return;
    }

    // Handle other actions (cancel)
    if (currentAction === 'cancel') {
        console.log(' Calling confirmCancelAction');
        return confirmCancelAction();
    }
    
    showErrorToast('Error', 'Acci贸n no v谩lida.', 3000);
}

function confirmCancelAction() {
    console.log(' confirmCancelAction called');
    
    // NO limpiar el package_id - el backend ahora maneja tanto anuncios como paquetes
    // Si es un anuncio, mantiene el prefijo 'announcement_', si es un paquete, es un n煤mero
    const packageIdForRequest = currentPackageId.toString();
    
    // Datos para cancelaci贸n (usar valores por defecto)
    const cancelData = {
        reason: 'otro', // Raz贸n por defecto (cliente_solicita, cliente_no_reclama, paquete_danado, paquete_perdido, anuncio_expirado, error_operador, otro)
        observations: null, // Opcional
        refund_amount: 0.00, // Por defecto 0
        operator_id: 1 // TODO: Obtener del usuario actual
    };

    // Send the cancel request to the correct endpoint
    console.log(' Sending cancel request to:', `/api/packages/${packageIdForRequest}/cancel`);
    console.log(' Request data:', cancelData);
    console.log(' Package ID type:', packageIdForRequest.startsWith('announcement_') ? 'ANUNCIO' : 'PAQUETE');
    
    fetch(`/api/packages/${packageIdForRequest}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify(cancelData)
    })
    .then(response => {
        console.log(' Response status:', response.status);
        
        if (!response.ok) {
            return response.json().then(errorData => {
                console.log(' Error response:', errorData);
                throw new Error(errorData.detail || 'Error al cancelar el paquete');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log(' Respuesta exitosa:', data);
        
        // Verificar si fue exitoso (tanto para paquetes como anuncios)
        if (data.success) {
            // Determinar si es un anuncio o un paquete
            const isAnnouncement = currentPackageId.toString().startsWith('announcement_');
            const itemType = isAnnouncement ? 'anuncio' : 'paquete';
            
            // Mostrar mensaje de 茅xito
            const successMessage = data.message || `El ${itemType} ha sido cancelado correctamente.`;
            showSuccessToast('xito', successMessage, 4000);
            
            // Si es un paquete y tiene email, mostrar opci贸n de email
            if (!isAnnouncement && data.package && data.package.customer && data.package.customer.email) {
                // Guardar informaci贸n del paquete cancelado para mostrar bot贸n
                window.cancelledPackageForEmail = data.package;
                showSuccessToast('xito', `${successMessage} Puedes enviar un email de notificaci贸n.`, 5000);
            }
        } else {
            // Si no fue exitoso, mostrar el mensaje de error
            showErrorToast('Error', data.message || 'No se pudo cancelar el elemento.', 5000);
            return; // No cerrar modal ni recargar si hay error
        }
        
        closeModal();
        // Esperar un momento antes de recargar para que el usuario vea el mensaje
        setTimeout(() => {
            reloadPackages();
        }, 500);
    })
    .catch(error => {
        console.error(' Error cancelando paquete:', error);
        console.error(' Error message:', error.message);
        showErrorToast('Error', error.message || 'No se pudo cancelar el paquete.', 5000);
    });
}

function confirmDeliverAction() {
    console.log(' confirmDeliverAction called');
    
    // Validate required fields
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    // OBSERVATIONS DISABLED - No longer reading observations data
    // const observations = document.getElementById('deliverObservations').value.trim();

    console.log(' Payment amount:', paymentAmount);

    if (!paymentAmount || paymentAmount <= 0) {
        console.log(' Invalid payment amount:', paymentAmount);
        showErrorToast('Error', 'Debe ingresar un monto de pago v谩lido.', 3000);
        return;
    }

    // Validar que el monto sea razonable (opcional)
    const calculatedAmount = parseFloat(document.getElementById('suggestedAmountText').textContent.replace('Valor calculado: $', ''));
    if (paymentAmount > calculatedAmount * 2) {
        if (!confirm(`El monto ingresado ($${paymentAmount.toFixed(2)}) es significativamente mayor al calculado ($${calculatedAmount.toFixed(2)}). 驴Est谩 seguro de continuar?`)) {
            return;
        }
    }

    // Limpiar el package_id si tiene prefijo
    const cleanPackageId = currentPackageId.toString().replace('announcement_', '');
    
    // Obtener informaci贸n del paquete para customer_id
    const packageData = packagesByState.received.find(p => p.id.toString() === cleanPackageId) ||
                        packagesByState.announced.find(p => p.id.toString() === cleanPackageId) ||
                        currentPackage;
    
    // Obtener customer_id correctamente (puede ser UUID string o null)
    const customerId = packageData?.customer_id || 
                       (packageData?.customer && packageData.customer.id) || 
                       (currentPackage && currentPackage.customer_id) ||
                       null;
    
    const deliverData = {
        payment_method: 'efectivo', // Siempre efectivo
        payment_amount: paymentAmount,
        customer_id: customerId, // UUID o null (opcional)
        operator_id: 1, // TODO: Obtener del usuario actual
        customer_signature: null // TODO: Implementar firma si es necesario
        // OBSERVATIONS DISABLED - Not including observations
        // observations: observations || null
    };

    // Send the delivery request to the correct endpoint
    console.log(' Sending delivery request to:', `/api/packages/${cleanPackageId}/deliver`);
    console.log(' Request data:', deliverData);
    
    fetch(`/api/packages/${cleanPackageId}/deliver`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify(deliverData)
    })
    .then(response => {
        console.log(' Response status:', response.status);
        console.log(' Response headers:', response.headers);
        
        if (!response.ok) {
            return response.json().then(errorData => {
                console.log(' Error response:', errorData);
                throw new Error(errorData.detail || 'Error al entregar el paquete');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log(' Respuesta exitosa:', data);
        
        // Verificar que el paquete se entreg贸 correctamente
        const packageData = data.package || data;
        const status = packageData.status || (packageData.status?.value);
        
        if (status && (status === 'ENTREGADO' || status === 'DELIVERED' || status?.toUpperCase() === 'ENTREGADO')) {
            // Mostrar bot贸n de email si el cliente tiene email (despu茅s de entregar)
            if (packageData.customer && packageData.customer.email) {
                // Guardar informaci贸n del paquete entregado para mostrar bot贸n
                window.deliveredPackageForEmail = packageData;
                // Mostrar mensaje con opci贸n de email
                showSuccessToast('xito', 'El paquete ha sido entregado correctamente. Puedes enviar un email de confirmaci贸n.', 5000);
            } else {
                showSuccessToast('xito', data.message || 'El paquete ha sido entregado correctamente.', 4000);
            }
        } else {
            // Si el estado no es ENTREGADO, mostrar advertencia
            console.warn('锔 El paquete podr铆a no haberse entregado correctamente. Estado recibido:', status);
            showSuccessToast('xito', data.message || 'Operaci贸n completada.', 4000);
        }
        
        closeModal();
        // Esperar un momento antes de recargar para que el usuario vea el mensaje
        setTimeout(() => {
            reloadPackages();
        }, 500);
    })
    .catch(error => {
        console.error(' Error entregando paquete:', error);
        console.error(' Error message:', error.message);
        showErrorToast('Error', error.message || 'No se pudo entregar el paquete.', 5000);
    });
}

function confirmDeleteAction() {
    // Additional confirmation for delete action
    const confirmed = confirm(`锔 隆ATENCIN! Esta acci贸n eliminar谩 permanentemente el paquete ${currentPackageId}.\n\n驴Est谩s completamente seguro de que deseas continuar?\n\nEsta acci贸n NO SE PUEDE DESHACER.`);

    if (!confirmed) {
        return;
    }

    // Show loading state
    const confirmButton = document.getElementById('confirmAction');
    const originalText = confirmButton.innerHTML;
    confirmButton.disabled = true;
    confirmButton.innerHTML = 'Eliminando...';

    // Determine if it's a package ID or announcement ID
    let endpoint;
    if (currentPackageId.startsWith('announcement_')) {
        // It's an announcement, use guide endpoint
        const trackingCode = currentPackageId.replace('announcement_', '');
        endpoint = `/api/packages/guide/${trackingCode}`;
    } else {
        // It's a regular package
        endpoint = `/api/packages/package/${currentPackageId}`;
    }

    // Send the delete request
    fetch(endpoint, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.detail || 'Error al eliminar el paquete');
            });
        }
        return response.json();
    })
    .then(data => {
        closeModal();
        showSuccessToast('xito', data.message || 'El paquete ha sido eliminado correctamente.', 5000);
        reloadPackages();
    })
    .catch(error => {
        console.error('Error eliminando paquete:', error);
        showErrorToast('Error', error.message || 'No se pudo eliminar el paquete. Verifica que tengas permisos de administrador.', 7000);
    })
    .finally(() => {
        // Restore button state
        confirmButton.disabled = false;
        confirmButton.innerHTML = originalText;
        
        // Hide upload progress indicator
        const uploadProgress = document.getElementById('uploadProgress');
        if (uploadProgress) {
            uploadProgress.classList.add('hidden');
        }
    });
}

async function confirmReceiveAction() {
    // Validate required fields
    const packageType = document.getElementById('packageType').value;
    const packageCondition = document.getElementById('packageCondition').value;

    if (!packageType) {
        showErrorToast('Error', 'Debe seleccionar el tipo de paquete.', 3000);
        return;
    }

    if (!packageCondition) {
        showErrorToast('Error', 'Debe seleccionar la condici贸n del paquete.', 3000);
        return;
    }

    // Show loading state
    const confirmButton = document.getElementById('confirmAction');
    const originalText = confirmButton.innerHTML;
    confirmButton.disabled = true;
    confirmButton.innerHTML = 'Procesando...';

    try {
        // Procesar recepci贸n con S3
        const result = await processReceiveWithS3(currentPackageId, packageType, packageCondition, currentPackage.tracking_number);
        
        // Debug: Mostrar respuesta completa
        console.log(' Respuesta completa del backend:', result);
        console.log(' Campo baroti:', result?.baroti);
        
        // Mostrar n煤mero de posici贸n en el modal o mostrar opci贸n de email
        if (result && result.baroti) {
            console.log(' Posici贸n encontrada, mostrando en modal:', result.baroti);
            showBarotiNumber(result.baroti);
            
            // Si el paquete recibido tiene cliente con email, mostrar bot贸n despu茅s de mostrar posici贸n
            if (result.package && result.package.customer && result.package.customer.email) {
                // Esperar un momento para que se muestre el modal de posici贸n, luego agregar bot贸n
                setTimeout(() => {
                    addEmailButtonToBarotiModal(result.package, 'received');
                }, 500);
            }
        } else {
            console.log(' No se encontr贸 posici贸n en la respuesta');
            // Si no hay posici贸n pero hay cliente con email, mostrar bot贸n antes de cerrar
            if (result && result.package && result.package.customer && result.package.customer.email) {
                // No cerrar modal, mostrar bot贸n de email
                showEmailButtonAfterReceive(result.package);
            } else {
                // Si no hay posici贸n en la respuesta, cerrar modal y mostrar 茅xito
                closeModal();
                showSuccessToast('xito', 'Paquete recibido correctamente con im谩genes subidas a S3.', 3000);
                reloadPackages();
            }
        }
        
    } catch (error) {
        console.error('Error en recepci贸n del paquete:', error);
        showErrorToast('Error', error.message || 'No se pudo recibir el paquete.', 5000);
    } finally {
        // Restore button state
        confirmButton.disabled = false;
        confirmButton.innerHTML = originalText;
    }
}

/**
 * Configurar event listener para actualizar tarifa base seg煤n tipo de paquete
 */
function setupPackageTypeFeeListener() {
    console.log(' Configurando listener de tarifas por tipo de paquete');
    const packageTypeSelect = document.getElementById('packageType');
    if (!packageTypeSelect) {
        console.error(' No se encontr贸 el select de tipo de paquete');
        return;
    }
    
    console.log(' Select de tipo de paquete encontrado');
    
    // Remover listener anterior si existe
    packageTypeSelect.removeEventListener('change', updatePackageTypeFee);
    
    // Agregar nuevo listener
    packageTypeSelect.addEventListener('change', updatePackageTypeFee);
    console.log(' Event listener agregado');
    
    // Actualizar tarifa inicial
    updatePackageTypeFee();
}

/**
 * Actualizar tarifa base mostrada seg煤n tipo de paquete seleccionado
 */
function updatePackageTypeFee() {
    const packageTypeSelect = document.getElementById('packageType');
    if (!packageTypeSelect) return;
    
    const selectedType = packageTypeSelect.value;
    let baseFee = 0;
    let feeDescription = '';
    
    // Obtener tarifas desde configuraci贸n din谩mica del .env
    const rates = window.appConfig?.rates;
    
    if (!rates) {
        console.error(' No se encontr贸 configuraci贸n de tarifas en window.appConfig.rates');
        return;
    }
    
    // Definir tarifas base seg煤n configuraci贸n del backend
    if (selectedType === 'normal') {
        baseFee = rates.normal;
        feeDescription = 'Normal (30x30x30cm)';
        console.log(' Tarifa Normal seleccionada:', baseFee);
    } else if (selectedType === 'extra_dimensioned') {
        baseFee = rates.extra_dimensioned;
        feeDescription = 'Extra Dimensionado';
        console.log(' Tarifa Extra Dimensionado seleccionada:', baseFee);
    }
    
    console.log(' Tipo seleccionado:', selectedType, 'Tarifa:', baseFee);
    
    // Eliminar elemento de tarifa si existe (ocultar informaci贸n de tarifa)
    let feeDisplay = document.getElementById('packageTypeFeeDisplay');
    if (feeDisplay) {
        feeDisplay.remove();
    }
}

/**
 * Mostrar n煤mero de posici贸n generado en el modal
 * @param {string} barotiNumber - N煤mero de posici贸n generado
 */
function showBarotiNumber(barotiNumber) {
    console.log(' Mostrando n煤mero de posici贸n:', barotiNumber);
    
    // Cerrar el modal de recepci贸n
    closeModal();
    
    // Mostrar mensaje de 茅xito
    showSuccessToast('xito', 'Paquete recibido correctamente.', 3000);
    
    // Recargar la lista de paquetes
    reloadPackages();
    
    // Esperar un momento antes de abrir el modal de posici贸n
    setTimeout(() => {
        openBarotiModal(barotiNumber);
    }, 300);
}

/**
 * Abrir modal de posici贸n
 * @param {string} barotiNumber - N煤mero de posici贸n generado
 */
function openBarotiModal(barotiNumber) {
    console.log(' Abriendo modal de posici贸n:', barotiNumber);
    
    const barotiModal = document.getElementById('barotiModal');
    const barotiModalNumber = document.getElementById('barotiModalNumber');
    
    if (barotiModal && barotiModalNumber) {
        // Establecer el n煤mero de posici贸n
        barotiModalNumber.textContent = barotiNumber;
        
        // Mostrar el modal
        barotiModal.classList.remove('hidden');
        
        // Prevenir scroll del body
        document.body.style.overflow = 'hidden';
        
        console.log(' Modal de posici贸n mostrado:', barotiNumber);
    } else {
        console.error(' No se encontraron elementos del modal de posici贸n');
    }
}

/**
 * Cerrar modal de posici贸n
 */
function closeBarotiModal() {
    console.log(' Cerrando modal de posici贸n');
    
    const barotiModal = document.getElementById('barotiModal');
    const barotiEmailSection = document.getElementById('barotiEmailSectionContent');
    
    if (barotiModal) {
        barotiModal.classList.add('hidden');
        
        // Limpiar secci贸n de email
        if (barotiEmailSection) {
            barotiEmailSection.innerHTML = '';
        }
        
        // Restaurar scroll del body
        document.body.style.overflow = '';
        
        // Recargar paquetes una vez m谩s para asegurar que los datos est茅n actualizados
        console.log(' Recargando paquetes al cerrar modal de posici贸n...');
        reloadPackages();
        
        console.log(' Modal de posici贸n cerrado');
    }
}

/**
 * Cerrar modal de posici贸n al hacer clic en el fondo
 */
function closeBarotiModalOnBackdrop(event) {
    if (event.target.id === 'barotiModal') {
        closeBarotiModal();
    }
}

/**
 * Procesar recepci贸n de paquete con subida a S3
 * @param {string} packageId - ID del paquete
 * @param {string} packageType - Tipo de paquete
 * @param {string} packageCondition - Condici贸n del paquete
 * @param {string} trackingNumber - Tracking number del paquete
 */
async function processReceiveWithS3(packageId, packageType, packageCondition, trackingNumber) {
    console.log(` Procesando recepci贸n con S3 para paquete: ${packageId}`);
    
    // Extraer tracking_code del packageId (remover prefijo 'announcement_')
    const trackingCode = packageId.replace('announcement_', '');
    
    // IMPORTANTE: NO subir im谩genes a S3 antes de verificar el anuncio
    // El endpoint /api/packages/receive-with-images verificar谩 el anuncio primero
    // y luego procesar谩 las im谩genes dentro de la misma transacci贸n
    
    // Crear FormData para enviar tanto datos como im谩genes
    const formData = new FormData();
    formData.append('announcement_id', `announcement_${trackingCode}`);
    formData.append('package_type', packageType);
    formData.append('package_condition', packageCondition);
    formData.append('observations', '');
    
    // Agregar im谩genes comprimidas si existen (el backend las subir谩 a S3)
    if (selectedImages && selectedImages.length > 0) {
        console.log(` Agregando ${selectedImages.length} im谩genes al FormData...`);
        for (let i = 0; i < selectedImages.length; i++) {
            const image = selectedImages[i];
            // selectedImages contiene objetos File directamente
            formData.append('images', image, image.name);
            console.log(`    Imagen ${i + 1} agregada: ${image.name} (${(image.size / 1024).toFixed(1)}KB)`);
        }
    } else {
        console.log('锔 No hay im谩genes seleccionadas para enviar');
    }
    
    console.log(' Enviando recepci贸n al backend...');
    
    // Enviar recepci贸n al backend - el backend verificar谩 el anuncio PRIMERO
    // y solo si existe, procesar谩 las im谩genes
    const response = await fetch('/api/packages/receive-with-images', {
        method: 'POST',
        credentials: 'same-origin',
        body: formData
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || 'Error al recibir el paquete');
    }
    
    const result = await response.json();
    console.log(' Paquete recibido exitosamente:', result);
    
    return result;
}

// Funciones de subida de im谩genes eliminadas - ahora se hace todo en un solo endpoint

// Image upload functionality
let selectedImages = [];
let isProcessingImages = false; // Bandera para evitar procesamiento duplicado
let changeListenerAttached = false; // Bandera para evitar m煤ltiples listeners

function resetImageUpload() {
    console.log(' Reseteando upload de im谩genes');
    selectedImages = [];
    
    const packageImagesInput = document.getElementById('packageImages');
    if (packageImagesInput) {
        packageImagesInput.value = '';
    }
    
    // Actualizar previsualizaci贸n y contador
    displayImagePreviews();
    updateImageCounter();
    
    console.log(' Upload de im谩genes reseteado');
}

// ========================================
// COMPRESIN DE IMGENES Y NOMENCLATURA S3
// ========================================

/**
 * Detectar soporte WebP en el navegador
 * @returns {boolean} - True si WebP es soportado
 */
function supportsWebP() {
    const canvas = document.createElement('canvas');
    canvas.width = 1;
    canvas.height = 1;
    
    try {
        return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
    } catch (e) {
        return false;
    }
}

/**
 * Obtener el mejor formato de imagen disponible
 * @returns {string} - Formato 贸ptimo (webp o jpeg)
 */
function getBestImageFormat() {
    return supportsWebP() ? 'image/webp' : 'image/jpeg';
}

/**
 * Comprimir imagen usando Canvas API con WebP y fallback JPEG
 * @param {File} file - Archivo de imagen original
 * @param {Object} options - Opciones de compresi贸n
 * @returns {Promise<Blob>} - Imagen comprimida
 */
function compressImage(file, options = {}) {
    const {
        maxSizeMB = 4.5,
        maxWidthOrHeight = 1080,  // Reducido a 1080x1080
        quality = 0.87,
        outputFormat = getBestImageFormat()  // WebP con fallback JPEG
    } = options;

    return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
            try {
                // Calcular dimensiones para compresi贸n
                const ratio = Math.min(
                    maxWidthOrHeight / img.width,
                    maxWidthOrHeight / img.height
                );
                
                canvas.width = img.width * ratio;
                canvas.height = img.height * ratio;
                
                // Dibujar imagen redimensionada con alta calidad
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Comprimir
                canvas.toBlob(
                    (blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('Error al comprimir la imagen'));
                        }
                    },
                    outputFormat,
                    quality
                );
                
            } catch (error) {
                reject(new Error('Error al procesar la imagen: ' + error.message));
            }
        };
        
        img.onerror = () => reject(new Error('Error al cargar la imagen'));
        img.src = URL.createObjectURL(file);
    });
}

/**
 * Procesar imagen para upload: validar tama帽o y comprimir
 * @param {File} file - Archivo de imagen original
 * @returns {Promise<Blob>} - Imagen procesada
 */
async function processImageForUpload(file) {
    // 1. VALIDAR TAMAO ORIGINAL (m谩ximo 5MB)
    const maxSizeBytes = 5 * 1024 * 1024; // 5MB
    
    if (file.size > maxSizeBytes) {
        throw new Error(`La imagen es demasiado grande (${(file.size / (1024 * 1024)).toFixed(1)}MB). El l铆mite m谩ximo es 5MB.`);
    }
    
    // 2. COMPRIMIR SIEMPRE (incluso si es peque帽a)
    return await compressImage(file, {
        maxSizeMB: 4.5,           // Comprimir a m谩ximo 4.5MB
        maxWidthOrHeight: 1080,   // Resoluci贸n m谩xima 1080x1080
        quality: 0.87,            // Calidad 87%
        outputFormat: getBestImageFormat()  // WebP con fallback JPEG
    });
}

        /**
         * Generar nombre de archivo 煤nico para S3 con extensi贸n correcta
         * @param {string} trackingCode - Tracking code del paquete
         * @param {number} sequence - N煤mero de secuencia
         * @param {Date} timestamp - Timestamp de la acci贸n
         * @param {string} format - Formato de imagen (webp o jpeg)
         * @returns {string} - Nombre del archivo
         */
        function generateImageFileName(trackingCode, sequence, timestamp = null, format = null) {
            const now = timestamp || new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
            
            // Determinar extensi贸n basada en el formato
            const extension = format === 'image/webp' ? 'webp' : 'jpg';
            
            return `${trackingCode}_${dateStr}_${timeStr}_${sequence.toString().padStart(3, '0')}.${extension}`;
        }

/**
 * Generar ruta S3 completa con estructura h铆brida
 * @param {string} packageId - ID del paquete
 * @param {string} packageType - Tipo de acci贸n (receive/deliver)
 * @param {Date} timestamp - Timestamp de la acci贸n
 * @returns {string} - Ruta S3 completa
 */
function generateS3Path(packageId, packageType, timestamp = null) {
    const now = timestamp || new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    
    return `${year}/${month}/${day}/packages/${packageId}/${packageType}/`;
}

/**
 * Generar metadatos de im谩genes para S3
 * @param {string} packageId - ID del paquete
 * @param {string} packageType - Tipo de acci贸n
 * @param {Array} images - Array de im谩genes procesadas
 * @returns {Object} - Metadatos en formato JSON
 */
function generateImageMetadata(packageId, packageType, images) {
    const now = new Date();
    
    return {
        packageId: packageId,
        packageType: packageType,
        uploadedAt: now.toISOString(),
        totalImages: images.length,
        images: images.map(img => ({
            fileName: img.fileName,
            s3Key: img.s3Key,
            s3Url: img.s3Url,
            size: img.size,
            originalSize: img.originalSize || img.size,
            sequence: img.sequence,
            uploadedAt: img.uploadedAt
        })),
        compression: {
            originalTotalSize: images.reduce((sum, img) => sum + (img.originalSize || img.size), 0),
            compressedTotalSize: images.reduce((sum, img) => sum + img.size, 0),
            compressionRatio: images.length > 0 ? 
                (images.reduce((sum, img) => sum + img.size, 0) / 
                 images.reduce((sum, img) => sum + (img.originalSize || img.size), 0)).toFixed(2) : 1
        },
        s3Structure: {
            bucket: 'elclub-paqueteria',
            year: now.getFullYear(),
            month: (now.getMonth() + 1).toString().padStart(2, '0'),
            day: now.getDate().toString().padStart(2, '0'),
            packageId: packageId,
            packageType: packageType
        }
    };
}

/**
 * Subir im谩genes a S3 con estructura h铆brida
 * @param {string} packageId - ID del paquete
 * @param {string} packageType - Tipo de acci贸n (receive/deliver)
 * @param {string} trackingNumber - Tracking number del paquete
 * @returns {Promise<Array>} - Array de im谩genes subidas con metadatos
 */
async function uploadImagesToS3(packageId, packageType = 'receive', trackingNumber) {
    if (!selectedImages || selectedImages.length === 0) {
        return [];
    }
    
    const uploadedImages = [];
    const timestamp = new Date();
    const s3BasePath = generateS3Path(packageId, packageType, timestamp);
    
    console.log(` Subiendo ${selectedImages.length} im谩genes a S3...`);
    console.log(` Ruta S3: ${s3BasePath}`);
    
    for (let i = 0; i < selectedImages.length; i++) {
        try {
            const file = selectedImages[i];
            const sequence = i + 1;
            
            // Generar nombre de archivo 煤nico
            const fileName = generateImageFileName(trackingNumber, sequence, timestamp);
            const fullS3Key = s3BasePath + fileName;
            
            console.log(` Subiendo imagen ${sequence}/${selectedImages.length}: ${fileName}`);
            
            // Crear FormData para la subida
            const formData = new FormData();
            formData.append('file', file);
            formData.append('s3_key', fullS3Key);
            formData.append('package_id', packageId);
            formData.append('package_type', packageType);
            
            // Subir a S3 (asumiendo que tienes un endpoint para esto)
            const response = await fetch('/api/upload/s3', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const uploadResult = await response.json();
            
            uploadedImages.push({
                fileName: fileName,
                s3Key: fullS3Key,
                s3Url: uploadResult.url || uploadResult.Location,
                size: file.size,
                originalSize: file.originalSize || file.size,
                sequence: sequence,
                uploadedAt: timestamp.toISOString()
            });
            
            console.log(` Imagen ${sequence} subida exitosamente: ${fileName}`);
            
        } catch (error) {
            console.error(` Error subiendo imagen ${i + 1}:`, error);
            throw new Error(`Error subiendo imagen ${i + 1}: ${error.message}`);
        }
    }
    
    // Generar y subir archivo de metadatos
    try {
        const metadata = generateImageMetadata(packageId, packageType, uploadedImages);
        const metadataKey = s3BasePath + 'metadata.json';
        
        const metadataResponse = await fetch('/api/upload/s3-metadata', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                s3_key: metadataKey,
                metadata: metadata
            })
        });
        
        if (metadataResponse.ok) {
            console.log(` Metadatos subidos: ${metadataKey}`);
        }
        
    } catch (error) {
        console.warn('锔 Error subiendo metadatos:', error);
    }
    
    return uploadedImages;
}

/**
 * Actualizar contador de im谩genes
 */
function updateImageCounter() {
    const counter = document.getElementById('imageCounter');
    const count = document.getElementById('imageCount');
    
    if (selectedImages.length > 0) {
        counter.classList.remove('hidden');
        count.textContent = selectedImages.length;
    } else {
        counter.classList.add('hidden');
    }
}

/**
 * Actualizar preview de im谩genes
 */
function updateImagePreview() {
    const preview = document.getElementById('imagePreview');
    
    if (selectedImages.length === 0) {
        preview.classList.add('hidden');
        return;
    }
    
    preview.classList.remove('hidden');
    
    const previewContainer = preview.querySelector('.grid');
    previewContainer.innerHTML = '';
    
    selectedImages.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'relative group';
        
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = 'w-full h-32 object-cover rounded-lg border border-gray-200';
        
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '';
        removeBtn.className = 'absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm font-bold hover:bg-red-600 transition-colors';
        removeBtn.onclick = () => removeImage(index);
        
        previewItem.appendChild(img);
        previewItem.appendChild(removeBtn);
        previewContainer.appendChild(previewItem);
    });
}

/**
 * Eliminar imagen de la selecci贸n
 * NOTA: Esta funci贸n est谩 duplicada, usar la funci贸n removeImage principal
 */

async function handleImageSelection() {
    console.log(' ===== handleImageSelection INICIADO =====');
    
    // Prevenir procesamiento duplicado
    if (isProcessingImages) {
        console.warn('锔 Ya se est谩 procesando una selecci贸n de im谩genes, ignorando...');
        return;
    }
    
    isProcessingImages = true;
    
    try {
        const fileInput = document.getElementById('packageImages');
        
        if (!fileInput) {
            console.error(' Input packageImages no encontrado');
            showErrorToast('Error', 'No se encontr贸 el selector de archivos.', 3000);
            isProcessingImages = false;
            return;
        }
        
        console.log(' Input encontrado:', fileInput);
        console.log(' fileInput.files:', fileInput.files);
        console.log(' fileInput.files.length:', fileInput.files ? fileInput.files.length : 0);
        
        const newFiles = Array.from(fileInput.files || []);
        const maxFiles = 3;

        console.log(' Modal handleImageSelection called');
        console.log(' New files selected:', newFiles.length);
        console.log(' Current selectedImages:', selectedImages.length);

        // Si no hay archivos nuevos, no hacer nada
        if (newFiles.length === 0) {
            console.warn('锔 No se seleccionaron archivos');
            return;
        }

        // Verificar l铆mite ANTES de procesar
        const availableSlots = maxFiles - selectedImages.length;
        if (availableSlots <= 0) {
            console.warn('锔 L铆mite de im谩genes alcanzado');
            showInfoToast('L铆mite alcanzado', `Ya tienes ${maxFiles} im谩genes seleccionadas.`, 3000);
            fileInput.value = '';
            return;
        }

        // Mostrar indicador de carga
        showInfoToast('Procesando im谩genes', 'Comprimiendo y validando im谩genes...', 3000);

        // Procesar cada archivo con compresi贸n
        let addedCount = 0;
        let errorCount = 0;
        const filesToProcess = newFiles.slice(0, availableSlots); // Solo procesar hasta el l铆mite

        console.log(` Procesando ${filesToProcess.length} archivo(s) de ${newFiles.length} seleccionado(s)`);

        for (let i = 0; i < filesToProcess.length; i++) {
            const newFile = filesToProcess[i];
            
            try {
                console.log(`\n Procesando archivo ${i + 1}/${filesToProcess.length}: ${newFile.name}`);
                console.log(`   Tama帽o: ${(newFile.size / (1024 * 1024)).toFixed(2)}MB`);
                console.log(`   Tipo: ${newFile.type}`);
                
                // Verificar si ya existe un archivo con el mismo nombre y tama帽o
                const existingFile = selectedImages.find(existing => 
                    existing.name === newFile.name && existing.size === newFile.size
                );
                
                if (existingFile) {
                    console.log(`锔 Duplicate image skipped: ${newFile.name}`);
                    showInfoToast('Imagen duplicada', `${newFile.name} ya est谩 seleccionada.`, 2000);
                    continue;
                }

                // Procesar imagen: validar tama帽o y comprimir
                console.log(` Comprimiendo imagen: ${newFile.name}...`);
                
                const compressedBlob = await processImageForUpload(newFile);
                
                console.log(` Compresi贸n completada para ${newFile.name}`);
                
                // Crear archivo comprimido con metadatos originales
                const outputFormat = getBestImageFormat();
                const compressedFile = new File([compressedBlob], newFile.name, {
                    type: outputFormat,  // WebP o JPEG seg煤n soporte
                    lastModified: newFile.lastModified
                });
                
                // Agregar metadatos del archivo original
                compressedFile.originalSize = newFile.size;
                compressedFile.originalName = newFile.name;
                
                selectedImages.push(compressedFile);
                addedCount++;
                
                console.log(` Imagen agregada: ${newFile.name}`);
                console.log(`    Formato: ${outputFormat === 'image/webp' ? 'WebP' : 'JPEG'}`);
                console.log(`    Original: ${(newFile.size / (1024 * 1024)).toFixed(2)}MB`);
                console.log(`    Comprimida: ${(compressedFile.size / (1024 * 1024)).toFixed(2)}MB`);
                if (newFile.size > 0) {
                    console.log(`    Reducci贸n: ${(((newFile.size - compressedFile.size) / newFile.size) * 100).toFixed(1)}%`);
                }

            } catch (error) {
                errorCount++;
                console.error(` Error procesando imagen ${newFile.name}:`, error);
                console.error('   Stack:', error.stack);
                showErrorToast('Error de imagen', `${newFile.name}: ${error.message || 'Error desconocido'}`, 4000);
            }
        }

        // Mostrar mensajes informativos
        if (addedCount > 0) {
            console.log(` ${addedCount} imagen(es) agregada(s) exitosamente`);
            showSuccessToast('Im谩genes procesadas', `Se agregaron ${addedCount} imagen${addedCount > 1 ? 'es' : ''} correctamente.`, 2000);
        }

        if (errorCount > 0) {
            console.error(` ${errorCount} imagen(es) fallaron`);
            showWarningToast('Algunas im谩genes fallaron', `${errorCount} imagen${errorCount > 1 ? 'es' : ''} no se pudieron procesar.`, 3000);
        }

        // El input se limpia en el bloque finally para evitar m煤ltiples disparos

        console.log(' Final selectedImages count:', selectedImages.length);
        console.log(' Actualizando previsualizaci贸n...');
        
        // Actualizar la previsualizaci贸n y el contador
        displayImagePreviews();
        updateImageCounter();
        
        // Actualizar tambi茅n el resumen de recepci贸n si existe
        if (typeof updateReceiveSummary === 'function') {
            console.log(' Actualizando resumen de recepci贸n...');
            updateReceiveSummary();
        }
        
        console.log(' ===== handleImageSelection COMPLETADO =====\n');
        
    } catch (error) {
        console.error(' ERROR CRTICO en handleImageSelection:', error);
        console.error('   Stack:', error.stack);
        showErrorToast('Error cr铆tico', `Error al procesar im谩genes: ${error.message || 'Error desconocido'}`, 5000);
    } finally {
        // Siempre liberar la bandera al finalizar
        isProcessingImages = false;
        
        // Limpiar el input despu茅s de procesar para evitar m煤ltiples disparos
        const fileInput = document.getElementById('packageImages');
        if (fileInput) {
            fileInput.value = '';
        }
    }
}

function displayImagePreviews() {
    const previewContainer = document.getElementById('imagePreview');
    if (!previewContainer) {
        console.error(' Contenedor imagePreview no encontrado');
        return;
    }
    
    let gridContainer = previewContainer.querySelector('.grid');
    
    // Si no existe el grid, crearlo
    if (!gridContainer) {
        gridContainer = document.createElement('div');
        gridContainer.className = 'grid grid-cols-1 sm:grid-cols-3 gap-4';
        previewContainer.appendChild(gridContainer);
    }
    
    const counter = document.getElementById('imageCounter');
    const countSpan = document.getElementById('imageCount');
    
    // Clear previous previews
    gridContainer.innerHTML = '';
    
    if (selectedImages.length === 0) {
        previewContainer.classList.add('hidden');
        if (counter) counter.classList.add('hidden');
        return;
    }
    
    // Show counter
    if (countSpan) countSpan.textContent = selectedImages.length;
    if (counter) counter.classList.remove('hidden');
    console.log(` Displaying ${selectedImages.length} of 3 images`);
    
    // Create previews
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'relative group';
            previewDiv.innerHTML = `
                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200">
                    <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-full object-cover">
                </div>
                <button type="button"
                        onclick="removeImage(${index})"
                        class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 focus:opacity-100 z-10">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-1 py-0.5 rounded">
                    ${(file.size / 1024 / 1024).toFixed(1)}MB
                </div>
            `;
            gridContainer.appendChild(previewDiv);
        };
        
        reader.onerror = function(error) {
            console.error(' Error leyendo archivo:', error);
        };
        
        reader.readAsDataURL(file);
    });
    
    previewContainer.classList.remove('hidden');
    console.log(' Previsualizaci贸n actualizada');
}

function removeImage(index) {
    console.log(`锔 Removing image at index ${index}`);
    
    if (index < 0 || index >= selectedImages.length) {
        console.error(' ndice inv谩lido:', index);
        return;
    }
    
    const removedImage = selectedImages[index];
    selectedImages.splice(index, 1);
    
    console.log(` Removed: ${removedImage.name || 'imagen'}`);
    console.log(` Remaining images: ${selectedImages.length}`);

    // Actualizar previsualizaci贸n y contador
    displayImagePreviews();
    updateImageCounter();
    
    // Actualizar resumen si existe
    if (typeof updateReceiveSummary === 'function') {
        updateReceiveSummary();
    }
    
    showSuccessToast('Imagen eliminada', 'La imagen ha sido eliminada de la selecci贸n.', 2000);
}

// ========================================
// FUNCIONES PARA ENVO MANUAL DE EMAIL
// ========================================

/**
 * Verificar si el cliente tiene email y mostrar bot贸n de env铆o
 */
function checkAndShowEmailButton(package, eventType) {
    const emailSection = document.getElementById('emailNotificationSection');
    const emailRecipientInfo = document.getElementById('emailRecipientInfo');
    
    if (!emailSection) {
        console.warn('Secci贸n de email no encontrada');
        return;
    }
    
    // Verificar si el paquete tiene cliente con email
    if (package.customer && package.customer.email) {
        // Mostrar secci贸n de email
        emailSection.classList.remove('hidden');
        emailRecipientInfo.textContent = `${package.customer.email} (Tel: ${package.customer.phone || 'N/A'})`;
        
        // Guardar informaci贸n para env铆o
        window.currentEmailEventType = eventType;
        window.currentPackageForEmail = package;
        
        console.log(' Cliente tiene email, bot贸n de email visible');
    } else {
        // Ocultar secci贸n si no hay email
        emailSection.classList.add('hidden');
        console.log('锔 Cliente no tiene email registrado');
    }
}

/**
 * Enviar email de notificaci贸n manual
 */
async function sendPackageEmail() {
    if (!currentPackageId || !window.currentEmailEventType) {
        showErrorToast('Error', 'No hay informaci贸n suficiente para enviar el email.', 3000);
        return;
    }
    
    const sendButton = document.getElementById('sendEmailButton');
    const originalContent = sendButton.innerHTML;
    
    // Deshabilitar bot贸n y mostrar loading
    sendButton.disabled = true;
    sendButton.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Enviando...
    `;
    
    try {
        // Limpiar el package_id si tiene prefijo
        const cleanPackageId = currentPackageId.toString().replace('announcement_', '');
        
        const response = await fetch(`/api/packages/${cleanPackageId}/send-email?event_type=${window.currentEmailEventType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Error al enviar el email');
        }
        
        const data = await response.json();
        
        // Mostrar 茅xito
        showSuccessToast('Email Enviado', `Email enviado exitosamente a ${data.recipient_email}`, 4000);
        
        // Actualizar estado del bot贸n
        sendButton.innerHTML = `
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Email Enviado
        `;
        sendButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        sendButton.classList.add('bg-green-600', 'hover:bg-green-700');
        
        // Deshabilitar bot贸n despu茅s de enviar
        setTimeout(() => {
            sendButton.disabled = true;
        }, 2000);
        
    } catch (error) {
        console.error('Error enviando email:', error);
        showErrorToast('Error', error.message || 'No se pudo enviar el email.', 5000);
        
        // Restaurar bot贸n
        sendButton.disabled = false;
        sendButton.innerHTML = originalContent;
    }
}

function closeModal() {
    // Ocultar secci贸n de email cuando se cierra el modal
    const emailSection = document.getElementById('emailNotificationSection');
    if (emailSection) {
        emailSection.classList.add('hidden');
    }
    window.currentEmailEventType = null;
    window.currentPackageForEmail = null;
    
    // Restaurar estado original del bot贸n
    const sendButton = document.getElementById('sendEmailButton');
    if (sendButton) {
        sendButton.disabled = false;
        sendButton.innerHTML = `
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            Enviar Email
        `;
        sendButton.classList.remove('bg-green-600', 'hover:bg-green-700');
        sendButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }
    
    document.getElementById('packageModal').classList.add('hidden');
    // OBSERVATIONS DISABLED - No longer resetting observations
    // document.getElementById('actionObservations').value = '';

    // Reset receive form
    document.getElementById('packageType').value = '';
    document.getElementById('packageCondition').value = '';
    // OBSERVATIONS DISABLED - No longer resetting observations
    // const observationsElement = document.getElementById('receiveObservations');
    // if (observationsElement) observationsElement.value = '';
    resetImageUpload();
    
    // Limpiar display de tarifa
    const feeDisplay = document.getElementById('packageTypeFeeDisplay');
    if (feeDisplay) {
        feeDisplay.style.display = 'none';
    }

    // Reset deliver form
    document.getElementById('paymentAmount').value = '';
    // OBSERVATIONS DISABLED - No longer resetting observations
    // document.getElementById('deliverObservations').value = '';
    
    // Reset secci贸n de posici贸n
    const barotiSection = document.getElementById('barotiSection');
    const confirmButton = document.getElementById('confirmAction');
    const cancelButton = document.getElementById('cancelAction');
    
    if (barotiSection) {
        barotiSection.classList.add('hidden');
    }
    
    if (confirmButton) {
        confirmButton.style.display = 'block';
    }
    
    if (cancelButton) {
        cancelButton.style.display = 'none';
    }

    currentPackageId = null;
    currentAction = null;
}

function closeModalOnBackdrop(event) {
    // Solo cerrar si se hizo clic en el backdrop (no en el contenido del modal)
    if (event.target === event.currentTarget) {
        closeModal();
    }
}

// Filtrado mejorado con mejor mapeo de estados
function applyPackageFilter() {
    const searchTerm = domCache.searchInput?.value?.toLowerCase().trim() || '';

    const tableBody = domCache.packagesTableBody;
    const rows = tableBody.querySelectorAll('tr[data-search]');
    const emptyElement = document.getElementById('packagesEmpty');

    let totalVisible = 0;
    let totalPackages = rows.length;

    console.log(` Aplicando filtros - Texto: "${searchTerm}", Estado: "${currentStatusFilter}", Filas totales: ${totalPackages}`);

    rows.forEach((row, index) => {
        const searchData = row.getAttribute('data-search') || '';
        const statusData = row.getAttribute('data-status') || '';
        let isVisible = true;

        // Filter by search term (searches all fields)
        if (searchTerm) {
            const searchTerms = searchTerm.split(' ').filter(term => term.length > 0);
            const allTermsFound = searchTerms.every(term => searchData.includes(term));
            if (!allTermsFound) {
                isVisible = false;
            }
        }

        // Filter by status if a status filter is active - Mejorado con mapeo
        if (currentStatusFilter && isVisible) {
            const normalizedStatus = normalizeStatusForFilter(statusData);
            const normalizedFilter = normalizeStatusForFilter(currentStatusFilter);
            
            if (index < 3) { // Solo mostrar log para las primeras 3 filas
                console.log(`Fila ${index}: Status="${statusData}" -> "${normalizedStatus}", Filtro="${currentStatusFilter}" -> "${normalizedFilter}"`);
            }
            
            if (normalizedStatus !== normalizedFilter) {
                isVisible = false;
            }
        }

        row.style.display = isVisible ? 'table-row' : 'none';
        if (isVisible) {
            totalVisible++;
        }
    });

    console.log(` Filtrado completado: ${totalVisible} de ${totalPackages} filas visibles`);

    // Mostrar/ocultar mensaje vac铆o
    if (totalVisible === 0 && totalPackages > 0) {
        emptyElement?.classList.remove('hidden');
        tableBody?.classList.add('hidden');
    } else {
        emptyElement?.classList.add('hidden');
        tableBody?.classList.remove('hidden');
    }

    // Actualizar contadores visuales
    updateStateCounts();

    // Mostrar notificaci贸n si hay filtros activos
    if (searchTerm || currentStatusFilter) {
        let filterMessage = '';
        if (searchTerm && currentStatusFilter) {
            filterMessage = `B煤squeda y filtro de estado aplicados`;
        } else if (searchTerm) {
            filterMessage = `B煤squeda aplicada`;
        } else if (currentStatusFilter) {
            filterMessage = `Filtro de estado aplicado: ${getStatusText(currentStatusFilter)}`;
        }
        showInfoToast(filterMessage, `Mostrando ${totalVisible} de ${totalPackages} paquetes`, 2000);
    }
}

// Funci贸n auxiliar para normalizar estados para filtrado
function normalizeStatusForFilter(status) {
    if (!status) return '';
    const normalized = status.toLowerCase().trim();
    
    // Mapeo de estados en espa帽ol a ingl茅s
    const statusMap = {
        'anunciado': 'announced',
        'recibido': 'received', 
        'entregado': 'delivered',
        'cancelado': 'cancelled'
    };
    
    return statusMap[normalized] || normalized;
}

function applyStatusFilter(status) {
    // If clicking the same status, clear the filter
    if (currentStatusFilter === status) {
        clearStatusFilter();
        return;
    }

    currentStatusFilter = status;
    updateStatusButtonStyles();
    // Recargar desde el backend con el filtro aplicado (resetear a p谩gina 1)
    loadPackages(1);
}

function clearStatusFilter() {
    currentStatusFilter = null;
    updateStatusButtonStyles();
    // Recargar desde el backend sin filtro (resetear a p谩gina 1)
    loadPackages(1);
}

function updateStatusButtonStyles() {
    // Reset all status buttons to default style - Usar selector m谩s espec铆fico
    const statusButtonsContainer = document.querySelector('.flex.items-center.gap-1');
    if (!statusButtonsContainer) {
        console.warn('锔 No se encontr贸 contenedor de botones de estado');
        return;
    }
    
    const statusButtons = statusButtonsContainer.querySelectorAll('button');
    console.log(` Actualizando estilos de ${statusButtons.length} botones, filtro activo: "${currentStatusFilter}"`);
    
    statusButtons.forEach(button => {
        button.classList.remove('ring-2', 'ring-offset-2', 'ring-papyrus-blue', 'bg-opacity-20');
        // Mantener los colores hover originales
    });

    // Highlight active status button
    if (currentStatusFilter) {
        const filterIndex = ['announced', 'received', 'delivered', 'cancelled'].indexOf(currentStatusFilter);
        console.log(` Aplicando estilo para filtro: ${currentStatusFilter} (铆ndice: ${filterIndex})`);
        
        if (filterIndex !== -1 && statusButtons[filterIndex]) {
            const activeButton = statusButtons[filterIndex];
            activeButton.classList.add('ring-2', 'ring-offset-2', 'ring-papyrus-blue', 'bg-opacity-20');
            console.log(` Estilo aplicado al bot贸n ${filterIndex}`);
        } else {
            console.warn(` No se pudo aplicar estilo: filterIndex=${filterIndex}, buttons.length=${statusButtons.length}`);
        }
    }
}

function clearFilters() {
    // Limpiar campo de b煤squeda
    if (domCache.searchInput) domCache.searchInput.value = '';
    // Limpiar filtro de estado y recargar
    clearStatusFilter();

    // Asegurar que la tabla sea visible despu茅s de limpiar filtros
    const tableBody = domCache.packagesTableBody;
    const emptyElement = document.getElementById('packagesEmpty');
    if (tableBody.children.length > 0) {
        emptyElement.classList.add('hidden');
        tableBody.classList.remove('hidden');
    }

    showInfoToast('Filtros Limpiados', 'Se han removido todos los filtros aplicados.', 2000);
}

// Funci贸n auxiliar para recargar paquetes despu茅s de acciones
function reloadPackages() {
    loadPackages(currentPage);
}

// Funciones de paginaci贸n
function displayPaginationControls(pagination) {
    const paginationContainer = document.getElementById('paginationContainer');
    if (!paginationContainer) return;

    if (!pagination || pagination.total_pages <= 1) {
        paginationContainer.classList.add('hidden');
        return;
    }

    paginationContainer.classList.remove('hidden');

    const startItem = ((pagination.page - 1) * pagination.limit) + 1;
    const endItem = Math.min(pagination.page * pagination.limit, pagination.total);

    let paginationHTML = `
        <div class="flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
            <!-- Contador de resultados -->
            <div class="text-sm text-gray-700 order-2 sm:order-1">
                Mostrando 
                <span class="font-medium">${startItem}</span>
                a 
                <span class="font-medium">${endItem}</span>
                de 
                <span class="font-medium">${pagination.total}</span> 
                resultados
            </div>
            
            <!-- Botones de navegaci贸n -->
            <div class="flex items-center space-x-2 order-1 sm:order-2">
                <!-- Bot贸n Anterior -->
                ${pagination.has_prev ? `
                <button onclick="loadPackages(${pagination.page - 1})" 
                       class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    <span class="ml-1 hidden sm:inline">Anterior</span>
                </button>
                ` : `
                <span class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    <span class="ml-1 hidden sm:inline">Anterior</span>
                </span>
                `}
                
                <!-- N煤meros de p谩gina -->
                <div class="hidden md:flex items-center space-x-1">
                    ${(() => {
                        const startPage = Math.max(1, pagination.page - 2);
                        const endPage = Math.min(pagination.total_pages, pagination.page + 2);
                        let html = '';
                        
                        if (startPage > 1) {
                            html += `<button onclick="loadPackages(1)" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">1</button>`;
                            if (startPage > 2) {
                                html += `<span class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>`;
                            }
                        }
                        
                        for (let i = startPage; i <= endPage; i++) {
                            if (i === pagination.page) {
                                html += `<span class="relative inline-flex items-center px-4 py-2 border border-papyrus-blue bg-papyrus-blue text-sm font-medium text-white z-10">${i}</span>`;
                            } else {
                                html += `<button onclick="loadPackages(${i})" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">${i}</button>`;
                            }
                        }
                        
                        if (endPage < pagination.total_pages) {
                            if (endPage < pagination.total_pages - 1) {
                                html += `<span class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>`;
                            }
                            html += `<button onclick="loadPackages(${pagination.total_pages})" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">${pagination.total_pages}</button>`;
                        }
                        
                        return html;
                    })()}
                </div>
                
                <!-- Indicador de p谩gina actual (m贸vil) -->
                <div class="md:hidden relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                    ${pagination.page} / ${pagination.total_pages}
                </div>
                
                <!-- Bot贸n Siguiente -->
                ${pagination.has_next ? `
                <button onclick="loadPackages(${pagination.page + 1})" 
                       class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    <span class="mr-1 hidden sm:inline">Siguiente</span>
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                ` : `
                <span class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                    <span class="mr-1 hidden sm:inline">Siguiente</span>
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </span>
                `}
            </div>
        </div>
    `;

    paginationContainer.innerHTML = paginationHTML;
}



// Utility functions
function getStatusColor(status) {
    const normalizedStatus = normalizeStatusForFilter(status);
    switch(normalizedStatus?.toLowerCase()) {
        case 'announced': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
        case 'received': return 'bg-blue-100 text-blue-800 border-blue-200';
        case 'delivered': return 'bg-green-100 text-green-800 border-green-200';
        case 'cancelled': return 'bg-red-100 text-red-800 border-red-200';
        default: return 'bg-gray-100 text-gray-800 border-gray-200';
    }
}

function getStatusText(status) {
    const normalizedStatus = normalizeStatusForFilter(status);
    switch(normalizedStatus?.toLowerCase()) {
        case 'announced': return 'ANUNCIADO';
        case 'received': return 'RECIBIDO';
        case 'delivered': return 'ENTREGADO';
        case 'cancelled': return 'CANCELADO';
        default: return status || 'DESCONOCIDO';
    }
}

function getStatusIcon(status) {
    const normalizedStatus = normalizeStatusForFilter(status);
    switch(normalizedStatus?.toLowerCase()) {
        case 'announced':
            return '<svg class="w-4 h-4 text-yellow-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        case 'received':
            return '<svg class="w-4 h-4 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        case 'delivered':
            return '<svg class="w-4 h-4 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>';
        case 'cancelled':
            return '<svg class="w-4 h-4 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>';
        default:
            return '<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);

    // Format: dd/mm/yyyy hh:mm AM/PM
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    let hours = date.getHours();
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';

    hours = hours % 12;
    hours = hours ? hours : 12; // Convert 0 to 12 for 12 AM
    hours = hours.toString().padStart(2, '0');

    return `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;
}

function formatPhoneLinks(phoneNumber, customerName = '') {
    if (!phoneNumber || phoneNumber === 'Sin tel茅fono' || phoneNumber === 'N/A') {
        return phoneNumber || 'Sin tel茅fono';
    }

    // Clean phone number for links (remove spaces, dashes, +57 prefix)
    let cleanNumber = phoneNumber.replace(/[\s\-\(\)]/g, '');
    if (cleanNumber.startsWith('+57')) {
        cleanNumber = cleanNumber.substring(3);
    }

    // Create WhatsApp link
    const whatsappLink = `https://wa.me/57${cleanNumber}`;
    const whatsappText = `Hola ${customerName || 'cliente'}, te contacto por tu paquete`;

    // Create phone call link
    const telLink = `tel:+57${cleanNumber}`;

    return `
        <div class="flex items-center space-x-2">
            <a href="${telLink}"
               class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors"
               title="Llamar">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                ${phoneNumber}
            </a>
            <a href="${whatsappLink}?text=${encodeURIComponent(whatsappText)}"
               target="_blank"
               class="inline-flex items-center text-green-600 hover:text-green-800 transition-colors"
               title="WhatsApp">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                </svg>
            </a>
        </div>
    `;
}

function getAuthToken() {
    const cookieValue = `; ${document.cookie}`;
    const cookieParts = cookieValue.split(`; access_token=`);
    if (cookieParts.length === 2) {
        const token = cookieParts.pop().split(';').shift();
        if (token && token !== 'undefined' && token !== 'null') {
            return token;
        }
    }

    let token = localStorage.getItem('access_token');
    if (token && token !== 'undefined' && token !== 'null') {
        return token;
    }

    return null;
}

// User role for role-based UI
const userRole = '{{ user.role.value if user else "" }}';

// Funci贸n de debug para filtros
window.debugFilters = function() {
    console.log('И DIAGNSTICO DE FILTROS');
    console.log('========================');
    
    // Verificar elementos DOM
    const searchInput = document.getElementById('searchFilter');
    const clearButton = document.getElementById('clearFilters');
    const statusContainer = document.querySelector('.flex.items-center.gap-1');
    const tableBody = document.getElementById('packagesTableBody');
    
    console.log(' Elementos DOM:');
    console.log(`  - Campo b煤squeda: ${searchInput ? '' : ''}`);
    console.log(`  - Bot贸n limpiar: ${clearButton ? '' : ''}`);
    console.log(`  - Contenedor estados: ${statusContainer ? '' : ''}`);
    console.log(`  - Tabla: ${tableBody ? '' : ''}`);
    
    if (statusContainer) {
        const statusButtons = statusContainer.querySelectorAll('button');
        console.log(`  - Botones estado: ${statusButtons.length} encontrados`);
    }
    
    // Verificar filas de datos
    if (tableBody) {
        const rows = tableBody.querySelectorAll('tr[data-search]');
        console.log(`\n Datos de tabla:`);
        console.log(`  - Total filas: ${rows.length}`);
        
        if (rows.length > 0) {
            console.log(`  - Primera fila:`, {
                search: rows[0].getAttribute('data-search'),
                status: rows[0].getAttribute('data-status')
            });
        }
        
        // Mostrar estados 煤nicos
        const uniqueStatuses = [...new Set(Array.from(rows).map(row => row.getAttribute('data-status')))];
        console.log(`  - Estados 煤nicos: ${uniqueStatuses.join(', ')}`);
    }
    
    // Estado actual de filtros
    console.log(`\n Estado actual:`);
    console.log(`  - Filtro texto: "${domCache.searchInput?.value || 'vac铆o'}"`);
    console.log(`  - Filtro estado: "${currentStatusFilter || 'ninguno'}"`);
    
    return 'Debug completado - ver console para detalles';
};

// Funci贸n de debug espec铆fica para colores de estado
window.debugColoresEstado = function() {
    console.log(' DIAGNSTICO DE COLORES DE ESTADO');
    console.log('================================');
    
    const tableBody = document.getElementById('packagesTableBody');
    if (!tableBody) {
        console.log(' Tabla no encontrada');
        return;
    }
    
    const rows = tableBody.querySelectorAll('tr[data-search]');
    console.log(` Analizando colores de ${rows.length} filas`);
    
    // Analizar cada fila
    rows.forEach((row, index) => {
        const statusData = row.getAttribute('data-status');
        const statusSpan = row.querySelector('td:first-child span');
        const statusIcon = row.querySelector('td:first-child svg');
        
        if (statusSpan && statusIcon) {
            const spanClasses = statusSpan.className;
            const iconClasses = statusIcon.className;
            
            console.log(`[${index}] Estado: "${statusData}"`);
            console.log(`     Span classes: ${spanClasses}`);
            console.log(`     Icon classes: ${iconClasses}`);
            
            // Verificar colores esperados
            const normalizedStatus = normalizeStatusForFilter(statusData);
            const expectedColor = getStatusColor(normalizedStatus);
            const expectedIcon = getStatusIcon(normalizedStatus);
            
            console.log(`     Estado normalizado: "${normalizedStatus}"`);
            console.log(`     Color esperado: ${expectedColor}`);
            console.log('     ----');
        }
    });
    
    return 'An谩lisis de colores completado';
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('P谩gina de paquetes cargada');
    console.log(' TIP: Usa window.debugFilters() para diagnosticar problemas');
    console.log(' TIP: Usa window.debugColoresEstado() para verificar colores de iconos');
    initializeDOMCache();
    loadPackages();

    // Event listeners
    const searchFilter = document.getElementById('searchFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');

    if (searchFilter) {
        searchFilter.addEventListener('input', applyPackageFilter);
        // Focus on search filter when page loads
        searchFilter.focus();
    }
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearFilters);
    }

    // Status filter buttons - Usar selectores m谩s espec铆ficos
    const statusButtonsContainer = document.querySelector('.flex.items-center.gap-1');
    if (statusButtonsContainer) {
        const statusButtons = statusButtonsContainer.querySelectorAll('button');
        console.log(' Botones de estado encontrados:', statusButtons.length);
        
        if (statusButtons.length >= 4) {
            // Agregar event listeners con mapeo correcto de estados
            statusButtons[0].addEventListener('click', () => applyStatusFilter('announced')); // Amarillo - Anunciado
            statusButtons[1].addEventListener('click', () => applyStatusFilter('received'));  // Azul - Recibido  
            statusButtons[2].addEventListener('click', () => applyStatusFilter('delivered')); // Verde - Entregado
            statusButtons[3].addEventListener('click', () => applyStatusFilter('cancelled')); // Rojo - Cancelado
            
            console.log(' Event listeners de estado configurados');
        } else {
            console.warn('锔 No se encontraron suficientes botones de estado');
        }
    } else {
        console.error(' No se encontr贸 el contenedor de botones de estado');
    }

    // Modal events - verificar que los elementos existan antes de agregar listeners
    const closeModalBtn = document.getElementById('closeModal');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }
    
    const cancelActionBtn = document.getElementById('cancelAction');
    if (cancelActionBtn) {
        cancelActionBtn.addEventListener('click', closeModal);
    }
    
    const confirmActionBtn = document.getElementById('confirmAction');
    if (confirmActionBtn) {
        confirmActionBtn.addEventListener('click', confirmAction);
    }

    // Pagination events - verificar que los elementos existan antes de agregar listeners
    const prevPageBtn = document.getElementById('prevPage');
    if (prevPageBtn) {
        prevPageBtn.addEventListener('click', goToPrevPage);
    }
    
    const nextPageBtn = document.getElementById('nextPage');
    if (nextPageBtn) {
        nextPageBtn.addEventListener('click', goToNextPage);
    }
    
    const prevPageMobileBtn = document.getElementById('prevPageMobile');
    if (prevPageMobileBtn) {
        prevPageMobileBtn.addEventListener('click', goToPrevPage);
    }
    
    const nextPageMobileBtn = document.getElementById('nextPageMobile');
    if (nextPageMobileBtn) {
        nextPageMobileBtn.addEventListener('click', goToNextPage);
    }

    // Image upload events - OPTIMIZADO con soporte m贸vil y escritorio
    document.addEventListener('click', function(e) {
        // Verificar si el click fue en el bot贸n de selecci贸n de im谩genes o en sus elementos hijos
        const clickedBtn = e.target.closest('#selectImagesBtn');
        if (clickedBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            // Verificar si ya se alcanz贸 el l铆mite m谩ximo
            if (selectedImages.length >= 3) {
                showInfoToast('L铆mite alcanzado', 'Ya tienes el m谩ximo de 3 im谩genes seleccionadas. Elimina alguna para agregar otra.', 3000);
                return;
            }
            
            // Buscar el input file
            const packageImagesInput = document.getElementById('packageImages');
            
            if (!packageImagesInput) {
                showErrorToast('Error', 'No se encontr贸 el selector de archivos. Por favor, recarga la p谩gina.', 3000);
                return;
            }
            
            // Detectar si es dispositivo m贸vil
            if (isMobileDevice()) {
                // En m贸vil: mostrar modal con opciones (c谩mara o galer铆a)
                console.log(' Dispositivo m贸vil detectado - mostrando opciones');
                showMobileCaptureOptions();
            } else {
                // En escritorio: activar selector de archivos directamente
                console.log(' Escritorio detectado - abriendo selector de archivos');
                try {
                    packageImagesInput.removeAttribute('capture');
                    packageImagesInput.setAttribute('accept', 'image/jpeg,image/jpg,image/png,image/webp');
                    packageImagesInput.click();
                } catch (error) {
                    console.error(' Error al activar input:', error);
                    showErrorToast('Error', 'No se pudo abrir el selector de archivos. Por favor, intenta nuevamente.', 3000);
                }
            }
        }
    });

    // Asegurar que el input existente tenga el event listener usando delegaci贸n
    // Usamos delegaci贸n de eventos en el document para el cambio de archivos
    // Solo un listener para evitar duplicaci贸n
    if (!changeListenerAttached) {
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'packageImages') {
                console.log(' ===== EVENTO CHANGE DETECTADO (delegado) =====');
                console.log(' Target:', e.target);
                console.log(' Archivos seleccionados:', e.target.files ? e.target.files.length : 0);
                
                // Verificar que el input tiene archivos antes de procesar
                if (e.target.files && e.target.files.length > 0) {
                    console.log(' Archivos detectados, llamando handleImageSelection...');
                    // Usar setTimeout para asegurar que el evento se proces贸 completamente
                    setTimeout(() => {
                        handleImageSelection();
                    }, 50);
                } else {
                    console.warn('锔 Input file est谩 vac铆o');
                }
            }
        }, { once: false, passive: true });
        changeListenerAttached = true;
        console.log(' Listener de change delegado configurado');
    }
    
    // Tambi茅n agregar listener directo al input cuando est茅 disponible
    function setupImageInputListener() {
        const packageImagesInput = document.getElementById('packageImages');
        if (packageImagesInput) {
            // Remover listener anterior si existe para evitar duplicados
            const newInput = packageImagesInput.cloneNode(true);
            packageImagesInput.parentNode.replaceChild(newInput, packageImagesInput);
            
            // Obtener referencia al nuevo input despu茅s del reemplazo
            const updatedInput = document.getElementById('packageImages');
            
            // Agregar listener para el evento change
            if (updatedInput) {
                updatedInput.addEventListener('change', function(e) {
                    console.log(' ===== EVENTO CHANGE DISPARADO EN INPUT =====');
                    console.log(' Archivos seleccionados:', e.target.files.length);
                    
                    // Llamar a la funci贸n de manejo de im谩genes
                    handleImageSelection();
                });
                
                console.log(' Listener change agregado al input packageImages');
            } else {
                console.error(' No se pudo obtener referencia al input despu茅s del reemplazo');
            }
        }
    }
    
    // Intentar configurar el listener cuando el DOM est茅 listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupImageInputListener);
    } else {
        setupImageInputListener();
    }
    
    // Tambi茅n configurar cuando se muestre el modal
    const modal = document.getElementById('packageModal');
    if (modal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!modal.classList.contains('hidden')) {
                        setTimeout(setupImageInputListener, 100);
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });
    }
    
    console.log(' Sistema de selecci贸n de im谩genes inicializado');

    // Payment amount input event - solo si el elemento existe
    const paymentAmountInput = document.getElementById('paymentAmount');
    if (paymentAmountInput) {
        paymentAmountInput.addEventListener('input', function() {
            const paymentAmount = parseFloat(this.value) || 0;
            const suggestedAmountText = document.getElementById('suggestedAmountText');
            
            if (suggestedAmountText) {
                const calculatedAmount = parseFloat(suggestedAmountText.textContent.replace('Valor calculado: $', ''));
                
                if (paymentAmount > 0) {
                    if (paymentAmount === calculatedAmount) {
                        suggestedAmountText.textContent = `Valor calculado: $${calculatedAmount.toFixed(2)} (exacto)`;
                        suggestedAmountText.className = 'text-sm text-green-600 mt-1';
                    } else if (paymentAmount > calculatedAmount) {
                        const difference = paymentAmount - calculatedAmount;
                        suggestedAmountText.textContent = `Valor calculado: $${calculatedAmount.toFixed(2)} (+$${difference.toFixed(2)})`;
                        suggestedAmountText.className = 'text-sm text-orange-600 mt-1';
                    } else {
                        const difference = calculatedAmount - paymentAmount;
                        suggestedAmountText.textContent = `Valor calculado: $${calculatedAmount.toFixed(2)} (-$${difference.toFixed(2)})`;
                        suggestedAmountText.className = 'text-sm text-blue-600 mt-1';
                    }
                } else {
                    suggestedAmountText.textContent = `Valor calculado: $${calculatedAmount.toFixed(2)}`;
                    suggestedAmountText.className = 'text-sm text-gray-500 mt-1';
                }
            }
        });
        console.log(' Listener de paymentAmount agregado');
    } else {
        console.warn('锔 paymentAmount no encontrado al inicializar (normal si no est谩 en modal de entrega)');
    }
});

// Funci贸n para mostrar tarifas correctas inmediatamente
function showCorrectFees(package) {
    const paymentInfo = document.getElementById('dynamicPaymentInfo');
    
    // Tarifas correctas desde configuraci贸n (se cargan din谩micamente)
    const rates = window.appConfig?.rates;
    
    if (!rates) {
        console.error(' No se encontr贸 configuraci贸n de tarifas en showCorrectFees');
        return;
    }
    
    const packageType = normalizePackageType(package.package_type);
    const storageDays = package.storage_days || 0;
    
    // Usar las claves exactas que viene del backend en app_config.rates
    const baseFee = packageType === 'EXTRA_DIMENSIONADO'
        ? (rates.extra_dimensioned ?? rates.extra_dimensioned_package_rate ?? rates.normal)
        : (rates.normal ?? rates.normal_package_rate ?? rates.extra_dimensioned);
    const storageFee = storageDays * rates.storage_per_day;
    const totalFee = baseFee + storageFee;
    
    paymentInfo.innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between items-center py-2 border-b border-green-200">
                <span class="text-green-700 font-medium">TARIFA BASE:</span>
                <span class="text-gray-700 font-mono">$${baseFee.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-green-200">
                <span class="text-green-700 font-medium">BODEGAJE <span class="font-bold text-lg">${storageDays}</span> DIAS:</span>
                <span class="text-gray-700 font-mono">$${storageFee.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center py-3 bg-green-100 rounded-lg px-3">
                <span class="text-green-800 font-bold text-lg">TOTAL:</span>
                <span class="text-green-800 font-bold text-xl font-mono">$${totalFee.toFixed(2)}</span>
            </div>
        </div>
    `;
}

// Configuraci贸n de la aplicaci贸n desde el backend
{% if app_config %}
window.appConfig = {{ app_config | tojson | safe }};
console.log(' Configuraci贸n de la aplicaci贸n cargada:', window.appConfig);
{% else %}
console.error(' No se encontr贸 app_config en el template');
window.appConfig = null;
{% endif %}

// NOTA: Las funciones isMobileDevice() y showMobileCaptureOptions() 
// est谩n definidas al inicio del script para estar disponibles globalmente

</script>
{% endblock %}


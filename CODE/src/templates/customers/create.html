{% extends "base/base.html" %}

{% block title %}Crear Cliente - PAQUETEX v3.1{% endblock %}

{% block extra_head %}
<!-- Utilidades de teléfono -->
<script src="{{ url_for('static', path='/js/phone-utils.js') }}"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-4 sm:py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-light text-gray-900">Crear Cliente</h1>
            <p class="mt-2 text-sm sm:text-base text-gray-500">Registra un nuevo cliente en el sistema</p>
        </div>

        <!-- Navegación -->
        <div class="bg-white shadow-sm border border-gray-200 rounded-lg mb-6 sm:mb-8">
            <nav class="flex space-x-4 sm:space-x-8 px-4 sm:px-6 overflow-x-auto" aria-label="Tabs">
                <a href="/profile" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    Perfil
                </a>
                <a href="/settings" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    Configuración
                </a>
                <a href="/profile/change-password" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    Seguridad
                </a>
                {% if user.role.value == 'ADMIN' %}
                <a href="/admin/users" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                    Gestión de Usuarios
                </a>
                {% endif %}
                <a href="/customers/manage" class="border-papyrus-blue text-papyrus-blue whitespace-nowrap py-3 sm:py-4 px-1 border-b-2 font-medium text-sm">
                    Clientes
                </a>
            </nav>
        </div>

        <!-- Formulario -->
        <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
            <div class="px-4 sm:px-6 py-4 sm:py-6 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Información del Cliente</h2>
            </div>
            
            <form method="POST" action="/api/customers" class="p-4 sm:p-6 space-y-6" id="customerForm">
                <!-- Información Básica -->
                <div class="space-y-4">
                    <h3 class="text-md font-medium text-gray-900 mb-4">Información Básica</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-field">
                            <label for="first_name" class="form-label form-label-required">Nombre</label>
                            <input type="text" 
                                   id="first_name" 
                                   name="first_name" 
                                   required
                                   minlength="1"
                                   maxlength="50"
                                   class="form-input"
                                   placeholder="Ingrese el nombre">
                        </div>
                        
                        <div class="form-field">
                            <label for="last_name" class="form-label">Apellido</label>
                            <input type="text" 
                                   id="last_name" 
                                   name="last_name"
                                   maxlength="50"
                                   class="form-input"
                                   placeholder="Ingrese el apellido">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-field">
                            <label for="phone" class="form-label form-label-required">Teléfono</label>
                            <input type="tel" 
                                   id="phone" 
                                   name="phone" 
                                   required
                                   minlength="10"
                                   maxlength="20"
                                   class="form-input"
                                   placeholder="+573001234567 o 3001234567">
                            <p class="mt-1 text-xs text-gray-500">Formato: +573001234567 (Colombia por defecto si no ingresa código)</p>
                        </div>
                        
                        <div class="form-field">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" 
                                   id="email" 
                                   name="email"
                                   maxlength="100"
                                   class="form-input"
                                   placeholder="cliente@example.com">
                        </div>
                    </div>
                </div>

                <!-- Dirección -->
                <div class="space-y-4">
                    <h3 class="text-md font-medium text-gray-900 mb-4">Dirección</h3>
                    
                    <div class="form-field">
                        <label for="address_street" class="form-label form-label-required">Dirección</label>
                        <input type="text" 
                               id="address_street" 
                               name="address_street" 
                               required
                               maxlength="100"
                               class="form-input"
                               placeholder="Ej: Calle 123 #45-67">
                    </div>
                </div>

                <!-- Información del Edificio -->
                <div class="space-y-4">
                    <h3 class="text-md font-medium text-gray-900 mb-4">Información del Edificio</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-field">
                            <label for="building_name" class="form-label">Conjunto Residencial</label>
                            <input type="text" 
                                   id="building_name" 
                                   name="building_name"
                                   maxlength="100"
                                   class="form-input"
                                   placeholder="Nombre del conjunto">
                        </div>
                        
                        <div class="form-field">
                            <label for="tower" class="form-label">Torre</label>
                            <input type="text" 
                                   id="tower" 
                                   name="tower"
                                   maxlength="10"
                                   class="form-input"
                                   placeholder="Ej: A, B, 1, 2">
                        </div>
                        
                        <div class="form-field">
                            <label for="apartment" class="form-label">Apartamento</label>
                            <input type="text" 
                                   id="apartment" 
                                   name="apartment"
                                   maxlength="10"
                                   class="form-input"
                                   placeholder="Ej: 101, 201">
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-end pt-6 border-t border-gray-200">
                    <a href="/customers/manage" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors text-center">
                        Cancelar
                    </a>
                    <button type="submit" class="bg-papyrus-blue text-white px-6 py-3 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                        Guardar Cliente
                    </button>
                </div>
            </form>
        </div>
        
    </div>
</div>

<script>
document.getElementById('customerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // Validaciones adicionales
    if (!data.first_name || data.first_name.trim().length === 0) {
        alert('El nombre es obligatorio');
        return;
    }
    
    if (!data.phone || data.phone.trim().length === 0) {
        alert('El teléfono es obligatorio');
        return;
    }
    
    // Validar formato de teléfono
    if (window.validatePhone && !window.validatePhone(data.phone)) {
        alert('Número de teléfono inválido. Use formato: +573001234567 o 3001234567');
        return;
    }
    
    // Normalizar teléfono
    if (window.normalizePhone) {
        data.phone = window.normalizePhone(data.phone);
    }
    
    if (!data.address_street || data.address_street.trim().length === 0) {
        alert('La dirección es obligatoria');
        return;
    }
    
    // Limpiar espacios en blanco
    Object.keys(data).forEach(key => {
        if (typeof data[key] === 'string') {
            data[key] = data[key].trim();
        }
    });
    
    // Función para obtener token de cookies
    function getAuthToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'access_token') {
                return value;
            }
        }
        return null;
    }
    
    try {
        const token = getAuthToken();
        const headers = {
            'Content-Type': 'application/json',
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch('/api/customers', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            window.location.href = '/customers/manage?success=Cliente creado exitosamente';
        } else {
            const error = await response.json();
            alert('Error al crear cliente: ' + (error.detail || 'Error desconocido'));
        }
    } catch (error) {
        alert('Error al crear cliente: ' + error.message);
    }
});
</script>
{% endblock %}


# ╔════════════════════════════════════════════════════════════════════════════╗
# ║                     CONFIGURACIÓN: PAPYRUS                                 ║
# ║                  Servidor AWS Cloud - Producción                           ║
# ╚════════════════════════════════════════════════════════════════════════════╝
#
# SERVIDOR: papyrus (AWS Lightsail)
# PROYECTO: PAQUETEX v4.0 - Sistema de Gestión de Paquetería
# URL: https://paquetex.papyrus.com.co
# UBICACIÓN: /home/ubuntu/paqueteria
#
# IMPORTANTE:
# - Este es el servidor de PRODUCCIÓN
# - Siempre crea backup antes de deploy
# - Verifica health check después de cambios
# - Monitorea logs después de deploy
#
# USO:
# ./deploy/deploy.sh --env papyrus --deploy
# ./deploy/deploy.sh --env papyrus --health
# ./deploy/deploy.sh --env papyrus --logs
#
# ════════════════════════════════════════════════════════════════════════════

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ INFORMACIÓN BÁSICA                                                         │
# └────────────────────────────────────────────────────────────────────────────┘

ENV_NAME="papyrus"
ENV_TYPE="remote"                   # Servidor remoto vía SSH
ENV_DESCRIPTION="Servidor AWS Producción"
ENV_COLOR="green"                   # Verde para producción

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ CONFIGURACIÓN SSH                                                          │
# └────────────────────────────────────────────────────────────────────────────┘
# Conexión al servidor AWS Lightsail

SSH_ENABLED=true
SSH_HOST="papyrus"                  # Alias configurado en ~/.ssh/config
SSH_USER="ubuntu"                   # Usuario por defecto en AWS
SSH_PORT=22
SSH_KEY="~/.ssh/id_rsa"            # Clave privada SSH
SSH_OPTIONS="-o StrictHostKeyChecking=no -o ConnectTimeout=10"

# NOTA: Asegúrate de tener configurado el alias en ~/.ssh/config:
# Host papyrus
#     HostName <IP-DEL-SERVIDOR>
#     User ubuntu
#     IdentityFile ~/.ssh/id_rsa

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ GIT                                                                        │
# └────────────────────────────────────────────────────────────────────────────┘

GIT_ENABLED=true
GIT_AUTO_COMMIT=true                # Commit automático en producción
GIT_AUTO_PUSH=true                  # Push automático
GIT_BRANCH="main"                   # Rama principal de producción

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ DOCKER                                                                     │
# └────────────────────────────────────────────────────────────────────────────┘

DOCKER_ENABLED=true
DOCKER_COMPOSE_FILE="docker-compose.prod.yml"  # Configuración de producción
DOCKER_PROJECT_NAME="paqueteria_v1_prod"       # Nombre del proyecto
DOCKER_REBUILD_ON_DEPLOY=true                  # Build la imagen app
DOCKER_PULL_BEFORE_DEPLOY=false                # No pull (imagen local)

# NOTA: Si hay cambios en Dockerfile, hacer rebuild manual:
# ./deploy/deploy.sh --env papyrus
# Opción 6 - Rebuild Contenedores

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ RUTAS EN SERVIDOR                                                          │
# └────────────────────────────────────────────────────────────────────────────┘

PROJECT_PATH="/home/ubuntu/paqueteria"        # Ruta del proyecto
BACKUP_PATH="/home/ubuntu/backups"            # Backups de BD

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ SERVICIOS DOCKER                                                           │
# └────────────────────────────────────────────────────────────────────────────┘

SERVICES=("app" "redis" "nginx")              # Servicios (postgres en RDS)
MAIN_SERVICE="app"                            # FastAPI application
OPTIONAL_SERVICES=("nginx")                   # Nginx es opcional

# SERVICIOS:
# - app      : FastAPI (Python) - Puerto 8000
# - redis    : Cache y sesiones - Puerto 6379
# - postgres : Base de datos - Puerto 5432
# - nginx    : Reverse proxy - Puerto 80/443

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ URLs Y ENDPOINTS                                                           │
# └────────────────────────────────────────────────────────────────────────────┘

BASE_URL="https://paquetex.papyrus.com.co"   # URL pública
HEALTH_CHECK_URL="http://localhost:8000/health"  # Health check interno
API_URL="http://localhost:8000/api"          # API interna

# NOTA: Health check usa localhost porque se ejecuta dentro del servidor

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ HEALTH CHECK                                                               │
# └────────────────────────────────────────────────────────────────────────────┘

HEALTH_CHECK_ENABLED=true
HEALTH_CHECK_TIMEOUT=60             # 60s (servidor puede tardar en arrancar)
HEALTH_CHECK_RETRIES=30             # 30 intentos (1 minuto total)
HEALTH_CHECK_INTERVAL=2             # Cada 2 segundos

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ MIGRACIONES DE BASE DE DATOS                                              │
# └────────────────────────────────────────────────────────────────────────────┘

MIGRATIONS_ENABLED=true
MIGRATIONS_AUTO=false               # SIEMPRE pedir confirmación en producción
MIGRATIONS_COMMAND="docker compose -f docker-compose.prod.yml exec app alembic upgrade head"
MIGRATIONS_ROLLBACK_COMMAND="docker compose -f docker-compose.prod.yml exec app alembic downgrade -1"

# IMPORTANTE: Las migraciones en producción deben ser:
# 1. Probadas en localhost primero
# 2. Revisadas manualmente
# 3. Con backup previo
# 4. Monitoreadas después de aplicar

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ BACKUP DE BASE DE DATOS                                                   │
# └────────────────────────────────────────────────────────────────────────────┘

BACKUP_ENABLED=false                # Deshabilitado - PostgreSQL está en RDS
BACKUP_AUTO_BEFORE_DEPLOY=false     # RDS tiene backups automáticos
BACKUP_DB_COMMAND="docker compose -f docker-compose.prod.yml exec -T postgres pg_dump -U postgres paqueteria"
BACKUP_RETENTION_DAYS=30            # Mantener 30 días

# BACKUPS SE GUARDAN EN: /home/ubuntu/backups/
# Formato: backup_papyrus_YYYYMMDD_HHMMSS.sql
#
# Para restaurar un backup:
# cat backup.sql | docker compose exec -T postgres psql -U postgres paqueteria

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ TESTS                                                                      │
# └────────────────────────────────────────────────────────────────────────────┘

TESTS_ENABLED=false                 # Tests se ejecutan en localhost/staging
TESTS_COMMAND="docker compose -f docker-compose.prod.yml exec app pytest"
TESTS_REQUIRED=false

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ HOOKS PERSONALIZADOS                                                      │
# └────────────────────────────────────────────────────────────────────────────┘

PRE_DEPLOY_HOOK=".deploy/hooks/pre-deploy-papyrus.sh"
POST_DEPLOY_HOOK=".deploy/hooks/post-deploy-papyrus.sh"
PRE_BACKUP_HOOK=""
POST_BACKUP_HOOK=""

# PRE-DEPLOY HOOK:
# - Verifica espacio en disco
# - Verifica servicios críticos
# - Crea backup de seguridad
#
# POST-DEPLOY HOOK:
# - Limpia caché de Redis
# - Verifica logs por errores
# - Warm-up de caché
# - Muestra métricas

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ NOTIFICACIONES                                                             │
# └────────────────────────────────────────────────────────────────────────────┘

NOTIFY_ON_SUCCESS=true              # Notificar deploys exitosos
NOTIFY_ON_ERROR=true                # Notificar errores inmediatamente

# NOTA: Configurar webhooks en deploy/config/deploy.conf
# SLACK_WEBHOOK="https://hooks.slack.com/..."
# DISCORD_WEBHOOK="https://discord.com/api/webhooks/..."

# ════════════════════════════════════════════════════════════════════════════
# INFORMACIÓN DEL SERVIDOR
# ════════════════════════════════════════════════════════════════════════════
#
# ESPECIFICACIONES:
# - Proveedor: AWS Lightsail
# - RAM: 1GB
# - CPU: 2 vCPUs
# - Disco: 20GB SSD
# - OS: Ubuntu 20.04 LTS
#
# SERVICIOS ACTIVOS:
# - Docker & Docker Compose
# - Nginx (reverse proxy)
# - Certbot (SSL/TLS)
# - PostgreSQL (en contenedor)
# - Redis (en contenedor)
# - FastAPI App (en contenedor)
#
# MONITOREO:
# - Logs: ./deploy/deploy.sh --env papyrus --logs
# - Estado: ./deploy/deploy.sh --env papyrus --status
# - Health: ./deploy/deploy.sh --env papyrus --health
#
# COMANDOS ÚTILES:
# - Deploy: ./deploy/deploy.sh --env papyrus --deploy
# - Restart: ./deploy/deploy.sh --env papyrus --restart
# - Backup: ./deploy/deploy.sh --env papyrus --backup
# - Migraciones: ./deploy/deploy.sh --env papyrus --migrations
#
# ════════════════════════════════════════════════════════════════════════════

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║                     CONFIGURACIÓN: STAGING                                 ║
# ║                    Servidor de Pruebas/Testing                             ║
# ╚════════════════════════════════════════════════════════════════════════════╝
#
# PROPÓSITO:
# Entorno de pruebas para validar cambios antes de producción.
# Replica la configuración de producción pero con datos de prueba.
#
# FLUJO RECOMENDADO:
# 1. Desarrollo en localhost
# 2. Pruebas en staging
# 3. Deploy a producción (papyrus)
#
# USO:
# ./deploy/deploy.sh --env staging --deploy
# ./deploy/deploy.sh --env staging --health
# ./deploy/deploy.sh --env staging --logs
#
# ════════════════════════════════════════════════════════════════════════════

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ INFORMACIÓN BÁSICA                                                         │
# └────────────────────────────────────────────────────────────────────────────┘

ENV_NAME="staging"
ENV_TYPE="remote"                   # Servidor remoto vía SSH
ENV_DESCRIPTION="Servidor de Pruebas"
ENV_COLOR="yellow"                  # Amarillo para staging

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ CONFIGURACIÓN SSH                                                          │
# └────────────────────────────────────────────────────────────────────────────┘
# NOTA: Actualiza estos valores con tu servidor de staging real

SSH_ENABLED=true
SSH_HOST="staging.example.com"      # Cambiar por tu servidor
SSH_USER="ubuntu"
SSH_PORT=22
SSH_KEY="~/.ssh/id_rsa"
SSH_OPTIONS="-o StrictHostKeyChecking=no -o ConnectTimeout=10"

# TODO: Configurar servidor de staging y actualizar SSH_HOST

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ GIT                                                                        │
# └────────────────────────────────────────────────────────────────────────────┘

GIT_ENABLED=true
GIT_AUTO_COMMIT=true                # Commit automático
GIT_AUTO_PUSH=true                  # Push automático
GIT_BRANCH="develop"                # Rama de desarrollo

# NOTA: Staging usa rama 'develop' para probar antes de merge a 'main'

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ DOCKER                                                                     │
# └────────────────────────────────────────────────────────────────────────────┘

DOCKER_ENABLED=true
DOCKER_COMPOSE_FILE="docker-compose.staging.yml"  # Config de staging
DOCKER_PROJECT_NAME="paquetex_staging"            # Prefijo staging
DOCKER_REBUILD_ON_DEPLOY=false                    # No rebuild
DOCKER_PULL_BEFORE_DEPLOY=true                    # Actualizar imágenes

# NOTA: Crear docker-compose.staging.yml si no existe

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ RUTAS EN SERVIDOR                                                          │
# └────────────────────────────────────────────────────────────────────────────┘

PROJECT_PATH="/home/ubuntu/paqueteria-staging"   # Ruta del proyecto
BACKUP_PATH="/home/ubuntu/backups-staging"       # Backups

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ SERVICIOS                                                                  │
# └────────────────────────────────────────────────────────────────────────────┘

SERVICES=("app" "redis" "postgres")               # Servicios principales
MAIN_SERVICE="app"
OPTIONAL_SERVICES=()

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ URLs                                                                       │
# └────────────────────────────────────────────────────────────────────────────┘

BASE_URL="https://staging.paquetex.com"          # URL pública de staging
HEALTH_CHECK_URL="http://localhost:8000/health"
API_URL="http://localhost:8000/api"

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ HEALTH CHECK                                                               │
# └────────────────────────────────────────────────────────────────────────────┘

HEALTH_CHECK_ENABLED=true
HEALTH_CHECK_TIMEOUT=45             # 45s
HEALTH_CHECK_RETRIES=20             # 20 intentos
HEALTH_CHECK_INTERVAL=2             # Cada 2 segundos

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ MIGRACIONES                                                                │
# └────────────────────────────────────────────────────────────────────────────┘

MIGRATIONS_ENABLED=true
MIGRATIONS_AUTO=true                # Automático en staging (para probar)
MIGRATIONS_COMMAND="docker compose -f docker-compose.staging.yml exec app alembic upgrade head"
MIGRATIONS_ROLLBACK_COMMAND="docker compose -f docker-compose.staging.yml exec app alembic downgrade -1"

# NOTA: Staging es el lugar ideal para probar migraciones antes de producción

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ BACKUP                                                                     │
# └────────────────────────────────────────────────────────────────────────────┘

BACKUP_ENABLED=true
BACKUP_AUTO_BEFORE_DEPLOY=true      # Backup automático
BACKUP_DB_COMMAND="docker compose -f docker-compose.staging.yml exec -T postgres pg_dump -U postgres paqueteria"
BACKUP_RETENTION_DAYS=14            # Mantener 14 días

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ TESTS                                                                      │
# └────────────────────────────────────────────────────────────────────────────┘

TESTS_ENABLED=true                  # Ejecutar tests en staging
TESTS_COMMAND="docker compose -f docker-compose.staging.yml exec app pytest"
TESTS_REQUIRED=false                # No bloquear deploy si fallan

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ HOOKS                                                                      │
# └────────────────────────────────────────────────────────────────────────────┘

PRE_DEPLOY_HOOK=""                  # Sin hooks por ahora
POST_DEPLOY_HOOK=""
PRE_BACKUP_HOOK=""
POST_BACKUP_HOOK=""

# ┌────────────────────────────────────────────────────────────────────────────┐
# │ NOTIFICACIONES                                                             │
# └────────────────────────────────────────────────────────────────────────────┘

NOTIFY_ON_SUCCESS=false             # No notificar éxitos
NOTIFY_ON_ERROR=true                # Solo notificar errores

# ════════════════════════════════════════════════════════════════════════════
# NOTAS SOBRE STAGING:
# ════════════════════════════════════════════════════════════════════════════
#
# PROPÓSITO:
# - Probar cambios antes de producción
# - Validar migraciones de BD
# - Ejecutar tests de integración
# - Verificar configuración de producción
#
# DIFERENCIAS CON PRODUCCIÓN:
# - Usa rama 'develop' en lugar de 'main'
# - Migraciones automáticas (para probar)
# - Tests habilitados
# - Menos retención de backups (14 vs 30 días)
#
# FLUJO RECOMENDADO:
# 1. Desarrollar en localhost
# 2. Commit a rama develop
# 3. Deploy a staging: ./deploy/deploy.sh --env staging --deploy
# 4. Probar en staging
# 5. Si todo OK, merge develop → main
# 6. Deploy a producción: ./deploy/deploy.sh --env papyrus --deploy
#
# ════════════════════════════════════════════════════════════════════════════
